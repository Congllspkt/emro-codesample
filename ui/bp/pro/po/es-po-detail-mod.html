<sc-link rel="import" href="../shared/ep-item-detail-spec.html"></sc-link>
<sc-link rel="import" href="ep-po-mod-history.html"></sc-link>
<sc-link rel="import" href="ep-po-cs-detail.html"></sc-link>
<sc-link rel="import" href="/ui/bp/edoc/contract/cntrstatus/es-cntrmanager.html"></sc-link>
<sc-link rel="import" href="/ui/bp/edoc/contract/popup/ep-non-standard-cntrmanager.html"></sc-link>
<dom-module id="es-po-detail-mod">
	<!--
	/**
	 *
	 *	@description : 계약및 발주현황 변경
	 *  <pre>
	 * </pre>
	 * @author : Yeon-u Kim
	 * @FileName :
	 * @Since 2016. 12. 26. renew 9.1
	 */
	-->
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>
	
	<template>
		
		<!-- 상세정보 조회 -->
		<sc-ajax id="findInfo" url="findModifyPo.do" body="{{findInfo.param}}" on-response="completeFindInfo"></sc-ajax>
		<!-- 변경 임시 저장 -->
		<sc-ajax id="modifyDraft" url="modifyDraftPo.do" on-response="completeSaveInfo"></sc-ajax>
		<!-- 변경요청 반송 저장 -->
		<sc-ajax id="modifyReturn" url="modifyReturnPo.do" on-response="completeSaveInfo" body="{{poData}}"></sc-ajax>
		<!-- 변경승인 저장 -->
		<sc-ajax id="modifySubmit" url="modifySubmitPo.do" on-response="completeSaveInfo"></sc-ajax>
		<!-- 발주해지 저장 -->
		<sc-ajax id="modifyClose" url="modifyClosePo.do" on-response="completeSaveInfo"></sc-ajax>
		<!-- 삭제 -->
		<sc-ajax id="deleteInfo" url="deletePo.do" on-response="completeDelete" body="{{poData}}"></sc-ajax>
		<!-- 전자계약 생성 -->
		<sc-ajax id="saveRefContract" url="/bp/edoc/saveRefContract.do"></sc-ajax>
		<!-- 전자계약 삭제 -->
		<sc-ajax id="deleteRefContract" url="/bp/edoc/deleteRefContract.do"></sc-ajax>
		<!-- 전자계약 조회 -->
		<sc-ajax id="findElecContract" url="/bp/edoc/findElecContract.do"></sc-ajax>
		<!-- 전자계약 해지 -->
		<sc-ajax id="saveRefCloseContract" url="/bp/edoc/saveRefCloseContract.do"></sc-ajax>
		<!-- 계약서식 조회 -->
		<sc-ajax
				id="findCntrdocFormList"
				url="/bp/edoc/largeFindListCntrForm.do"
				body="{{codes.cntrdocFormListParam}}"
				last-response="{{codes.cntrdocFormList}}">
		</sc-ajax>
		<!-- 전자계약 발송 -->
		<sc-ajax id="sendRefContract" url="sendRefContract.do"></sc-ajax>
		<!-- 코드 조회 -->
		
		<!-- EDOC SETUP 사용여부 -->
		<cc-code-constraint code-param="{{codes.setupParam}}" value="{{codes.setupInfo}}"></cc-code-constraint>
		
		<!-- 세금코드 -->
		<sc-ajax id="findListCommonCodeAttributeCode"
				 url="findListCommonCodeAttributeCode.do"
				 body="{{codes.taxTypCcdParam}}"
				 last-response="{{codes.taxTypCcd}}" init>
		</sc-ajax>
		<!-- 코드 -->
		<sc-code-group>
			<sc-code code="C007" value="{{codes.unitCd}}"></sc-code>       <!-- UOM -->
			<sc-code code="C024" value="{{codes.domovrsDivCcd}}"></sc-code>  <!-- 내외자 구분 공통코드 -->
			<sc-code code="P009" value="{{codes.pymtmethCcd}}"></sc-code>   <!-- 지급방법 -->
			<sc-code code="P010" value="{{codes.delyTermsCd}}"></sc-code>  <!-- 납품방법 -->
			<sc-code code="P011" value="{{codes.aprvSts}}"></sc-code>      <!-- 결재상태 -->
			<sc-code code="P012" value="{{codes.vdPoStsCcd}}"></sc-code>    <!-- 협력사진행상태 -->
			<sc-code code="P038" value="{{codes.poProgSts}}"></sc-code>    <!-- 발주진행상태 -->
			<sc-code code="P045" value="{{codes.purcTypCcd}}"></sc-code>      <!-- 구매 유형 공통코드 -->
			<sc-code code="P048" value="{{codes.maintBondTyp}}"></sc-code> <!-- 하자보증타입 -->
			<sc-code code="P064" value="{{codes.bondCls}}"></sc-code>      <!-- 계약이행 보증구분/하자보증구분/선급금보증구분 -->
			<sc-code code="P070" value="{{codes.modTyp}}"></sc-code>       <!-- 변경유형 -->
			<sc-code code="D015" value="{{codes.stamptaxIssueRateTyp}}"></sc-code>        <!-- 인지세 납부 비율 -->
			<sc-code code="P091" value="{{codes.payClsCd}}"></sc-code>        <!-- 지급구분 (선급금/중도금/잔금) -->
			<sc-code code="P100" value="{{codes.csTypCd}}"></sc-code>        <!-- 컨소시엄유형 -->
		</sc-code-group>

		<sc-request-group init>
			<!-- 계약 체결 유형 -->
			<sc-ajax id="findListCommonCodeAttributeCode"
					 url="findListCommonCodeAttributeCode.do"
					 body="{{codes.cntrSignParam}}"
					 last-response="{{codes.cntrSgngTypCcd}}"
					 on-response="completeFindListCommonCodeAttributeCode">
			</sc-ajax>

		</sc-request-group>

		<cc-auth-checker check-list="auth-s, auth-a"></cc-auth-checker>
		
		<cc-page-title-bar title-text="발주 상세">
			<sc-button text="계약 변경 이력" on-click="onShowModHistory" hidden="[[!formula('showModHistory')]]" auth-r></sc-button>
			<sc-button text="계약 변경 비교" on-click="onShowComparePrev" hidden="[[!formula('showComparePrev')]]" auth-r></sc-button>
			<sc-button text="[[formula('geEvalSetBtnTxt')]]" on-click="onPoEvalSet" hidden="[[!formula('poEvalSetBtn')]]" auth-s></sc-button>
			<sc-button text="저장" on-click="onModifyDraft" hidden="[[!formula('modifyDraftBtn')]]" auth-s></sc-button>
			<sc-button text="계약서 조회" on-click="onViewCntr" hidden="[[!formula('showEcntrViewBtn')]]" auth-s></sc-button>
			<sc-button text="변경 승인" on-click="onModifySubmit" hidden="[[!formula('modifySubmitBtn')]]" auth-s></sc-button>
			<sc-button text="반려" on-click="onModifyReturn" hidden="[[!formula('modifyReturnBtn')]]" auth-s></sc-button>
			<sc-button text="해지 승인" on-click="onModifyClose" hidden="[[!formula('modifyCloseBtn')]]" auth-s></sc-button>
			<sc-button text="발주 변경 결재 요청" on-click="onModifyApproval" hidden="[[!formula('modifyApprovalBtn')]]" auth-a></sc-button>
			<sc-button text="삭제" on-click="onDelete" hidden="[[!formula('deleteBtn')]]" auth-s></sc-button>
			<sc-button text="닫기" on-click="onClose"></sc-button>
		</cc-page-title-bar>
		
		<cc-link-document param="{{poData}}" app-type="PO"></cc-link-document>
		
		<div class="flex page">
			
			<cc-approval-summary app-id="{{poData.po_uuid}}" aprv-typcd="PO_CHG"></cc-approval-summary> <!-- PO_CHG: 발주변경품의 -->
			
			<cc-form-panel title-text="[[getModTitleText(poData.po_chg_req_typ_ccd)]]" collapsible="true" hidden="[[!formula('isModified')]]">
				<cc-fieldset>
					<sc-label text="발주 변경 요청자"></sc-label>
					<sc-text-field value="{{poData.mod_req_nm}}" readonly="true"></sc-text-field>
					<sc-text-field value="{{poData.po_chg_reqr_id}}" class="w-150" readonly="true" hidden="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 변경 요청 부서"></sc-label>
					<sc-text-field value="{{poData.po_chg_req_dept_cd}}" readonly="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 변경 유형"></sc-label>
					<sc-combobox-field value="{{poData.po_chg_typ_ccd}}" items="{{codes.modTyp}}" display-field="label" value-field="data"
									   readonly="true">
					</sc-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 변경 요청 일자"></sc-label>
					<sc-date-field value="{{poData.po_chg_req_dt}}" string-date="true" class="date" readonly="true" default-value="0d"></sc-date-field>
				</cc-fieldset>
				<cc-fieldset column-span="2">
					<sc-label text="[[getModCauseText(poData.po_chg_req_typ_ccd)]]"></sc-label>
					<sc-textarea-field value="{{poData.po_chg_req_rsn}}" readonly="[[!formula('editableModReqCause')]]" required="true" max-length="1000" validation-group="modReq"></sc-textarea-field>
				</cc-fieldset>
			</cc-form-panel>
			
			<cc-form-panel title-text="해지 정보" collapsible="true" hidden="[[!formula('isClosed')]]">
				<cc-fieldset>
					<sc-label text="발주 해지 담당자"></sc-label>
					<sc-text-field value="{{poData.po_close_chr_nm}}" readonly="true"></sc-text-field>
					<sc-text-field value="{{poData.po_trmn_pic_id}}" class="w-150" readonly="true" hidden="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 해지 일자"></sc-label>
					<sc-date-field value="{{poData.po_trmn_dt}}" string-date="true" class="date" readonly="true"></sc-date-field>
				</cc-fieldset>
				<cc-fieldset column-span="2">
					<sc-label text="발주 해지 사유"></sc-label>
					<sc-textarea-field value="{{poData.po_trmn_rsn}}" required="true" readonly="[[!formula('editableCntrCloseCause')]]" max-length="1000" validation-group="modifyClose"></sc-textarea-field>
				</cc-fieldset>
			</cc-form-panel>
			
			<cc-form-panel title-text="일반 정보" collapsible="true" validation-group="basic">
				<cc-fieldset>
					<sc-label text="운영조직"></sc-label>
					<cc-operorg-combobox-field value="{{poData.oorg_cd}}" oper-unit-cd="PO"
											   id="operorgcombobox" disabled="true">
					</cc-operorg-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="구매 유형"></sc-label>
					<sc-combobox-field value="{{poData.purc_typ_ccd}}" items="{{codes.purcTypCcd}}" display-field="label" value-field="data"
									   readonly="true">
					</sc-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 번호/차수"></sc-label>
					<sc-text-field value="{{poData.po_no}}" class="w-150" readonly="true"></sc-text-field>
					/
					<sc-text-field value="{{poData.po_revno}}" class="w-50" readonly="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="제목"></sc-label>
					<sc-text-field value="{{poData.po_tit}}" required="true" readonly="[[!formula('editable')]]" max-length="200"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="단가계약 번호"></sc-label>
					<sc-text-field value="{{poData.uprccntr_no}}" class="w-150" readonly="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="계약 기간"></sc-label>
					<sc-period-date-field from-value="{{poData.cntr_st_dt}}" to-value="{{poData.cntr_exp_dt}}"
										  readonly="[[!formula('isPurcTypMTEditable')]]" string-date="true" required="[[formula('isRequiredCntrDate')]]"></sc-period-date-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="내외자 구분"></sc-label>
					<sc-combobox-field value="{{poData.domovrs_div_ccd}}" items="{{codes.domovrsDivCcd}}" display-field="label" value-field="data"
									   readonly="true">
					</sc-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 등록 일자"></sc-label>
					<sc-date-field value="{{poData.po_crn_dt}}" string-date="true" class="date" readonly="true"></sc-date-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="협력사"></sc-label>
					<cc-linked-vendor vd-cd="{{poData.vd_cd}}" result-value="{{poData.erp_vd_cd}}" value="{{poData.vd_nm}}"
									  oper-org-cd="{{poData.oorg_cd}}" link-typ="POEO" readonly="true" hide-trigger="true">
					</cc-linked-vendor>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="협력사 담당자"></sc-label>
					<sc-text-field value="{{poData.vd_pic_uuid}}" readonly="true"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="거래기본계약 여부"></sc-label>
					<div class="field-box">
						<sc-checkbox-field input-value="{{poData.mstagt_yn}}" checked-value="Y" un-checked-value="N" readonly="true"></sc-checkbox-field>
						<sc-text-field value="{{poData.mstagt_no}}" readonly="true"></sc-text-field>
					</div>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="계약 체결 유형"></sc-label>
					<div class="field-box">
						<sc-combobox-field id="cntrSgngTypCcdCombo" class="w-150" readonly="true" value="{{poData.cntr_sgng_typ_ccd}}" items="{{codes.cntrSgngTypCcd}}" display-field="label"
										   value-field="data"  selected-index="0" placeholder="필수">
						</sc-combobox-field>&nbsp;
					</div>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="통화"></sc-label>
					<cc-cur-search value="{{poData.cur_ccd}}" readonly="true" hide-trigger="true" result-hidden="true"></cc-cur-search>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="발주 금액"></sc-label>
					<sc-number-field value="{{poData.po_amt}}" input-cover="true" format-type="amt"
									 class="align-right" readonly="true">
					</sc-number-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="인지세 사용 여부"></sc-label>
					<td>
						<div class="field-box" style="width:100%">
							<sc-checkbox-field input-value="{{poData.stax_yn}}" checked-value="Y" un-checked-value="N" readonly="[[!formula('checkAbleStamptaxYn')]]" on-click="changeStamptaxYn"></sc-checkbox-field>
							&nbsp;&nbsp;&nbsp;&nbsp;
							<sc-label hidden="[[!formula('showElecStamptax')]]" text="전자인지세 사용 여부"></sc-label>
							<sc-checkbox-field hidden="[[!formula('showElecStamptax')]]" input-value="{{poData.estax_yn}}" checked-value="Y" un-checked-value="N" readonly="[[!formula('checkAbleElecStamptaxYn')]]"></sc-checkbox-field>
						</div>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="인지세납부 비율"></sc-label>
					<sc-combobox-field value="{{poData.sttpymt_ro_typ_ccd}}" items="{{codes.stamptaxIssueRateTyp}}" display-field="label" value-field="data"
									   readonly="[[!formula('checkAbleStamptaxIssueRateTyp')]]" placeholder="선택" required="[[formula('checkAbleStamptaxIssueRateTyp')]]">
					</sc-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="[[formula('purcTypTxt')]]평가 대상 여부"></sc-label>
					<sc-radio-group-field value="{{poData.ge_subj_yn}}" readonly="true">
						<sc-radio-field label="예" input-value="Y"></sc-radio-field>
						<sc-radio-field label="아니오" input-value="N"></sc-radio-field>
					</sc-radio-group-field>
				</cc-fieldset>
				<cc-fieldset hidden="[[!formula('showCsTyp')]]" column-span="2">
					<tr>
						<sc-label text="컨소시엄 유형"></sc-label>
						<div class="field-box" style="width:100%">
							<sc-combobox-field class="w-150" display-field="label" value-field="data" items="{{codes.csTypCd}}" value="{{poData.cstm_typ_ccd}}" readonly="true"></sc-combobox-field>
							<sc-trigger-field style="margin-left:3px" trigger-cls="field-search" on-trigger-click="onShowCsPopup"></sc-trigger-field>
						</div>
				</cc-fieldset>
				<cc-fieldset column-span="2">
					<sc-label text="비고"></sc-label>
					<sc-textarea-field value="{{poData.po_rem}}" readonly="[[!formula('editable')]]" max-length="1000"></sc-textarea-field>
				</cc-fieldset>
			</cc-form-panel>
			
			<cc-form-panel title-text="첨부파일" collapsible="true" form-cls="label-column" label-width="300">
				<cc-fieldset>
					<sc-label text="내부참조용"></sc-label>
					<sc-upload id="upload1" class="h-200" value="{{poData.athg_uuid}}" editable="[[formula('editable')]]"></sc-upload>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="외부참조용(계약첨부)"></sc-label>
					<sc-upload id="upload2" class="h-200" value="{{poData.cntr_athg_uuid}}" editable="[[formula('editable')]]"></sc-upload>
				</cc-fieldset>
			</cc-form-panel>
			
			<!-- <cc-form-paneltitle-text="지급정보" collapsible="true" validation-group="poInfo"> -->
			<cc-form-panel title-text="지급 정보" collapsible="true"><!-- 지급 정보 패널 내에 지불조건 그리드는 validation-group에 포함되면 안되므로 -->
				<cc-fieldset>
					<sc-label text="지급방법"></sc-label>
					<div class="field-box" style="width:100%">
						<!--<sc-checkbox-field class="w-120" input-value="{{poData.pymtmeth_use_yn}}" checked-value="Y" un-checked-value="N"
										   label="계약서표시" readonly="[[!formula('editable')]]">
						</sc-checkbox-field>-->
						<sc-combobox-field value="{{poData.pymtmeth_ccd}}" items="{{codes.pymtmethCcd}}" display-field="label" value-field="data"
										   readonly="[[!formula('editable')]]" placeholder="선택">
						</sc-combobox-field>
					</div>
				</cc-fieldset>
				<cc-fieldset row-span="6">
					<sc-grid id="paymentPlanGrid" class="flex" style="width:100%;height:100%;" aggregate="true"
							 editable="[[formula('editable')]]"
							 sortable="false"
							 use-dummy="false"
							 column-fit-style="evenFill"
							 use-state="[[formula('editable')]]"
							 use-selection="[[formula('editable')]]"
							 selection-able-function="onPaymentPlanSelectionAbleFn"
							 on-item-edit-end="onPaymentPlanEditEnd">
						<cc-grid-toolbar title-text="지급 조건">
							<sc-button text="지급 추가" on-click="onAddPaymentPlan" auth-s hidden="[[!formula('editable')]]"></sc-button>
							<sc-button text="삭제" on-click="onDeletePaymentPlan" auth-s hidden="[[!formula('editable')]]"></sc-button>
						</cc-grid-toolbar>
						<sc-grid-columns>
							<sc-combobox-column data-field="pymt_typ_ccd" header-text="지급 유형" width="100" required="true"
												display-field="label" value-field="data" items="{{codes.payClsCd}}"
												items-function="onItemsFn" item-editable-function="onPayPlanItemEditableFn" aggregate-title="합계"></sc-combobox-column>
							<sc-data-column data-field="pymt_ro" header-text="지급 비율(%)" width="80" required="true" text-align="right"
											data-type="number" format-type="decimal"
											aggregate-function="onPayPlanAggregateFn" aggregate-format="amt"></sc-data-column>
							<sc-data-column data-field="pymt_amt" header-text="지급 금액" width="180" editable="false" text-align="right"
											data-type="number" format-type="amt" item-editable-function="onPayPlanItemEditableFn" editor-regex-function="onPayPlanRegexFn"
											validator-function="paymentPlanGridValidatorFn" validate-on-cell-paste="true"
											aggregate-function="onPayPlanAmtAggregateFn" aggregate-format="amt" sort-compare-function="onSortCompareFn"></sc-data-column>
							<sc-date-column data-field="pymt_expt_dt" header-text="지급 예정 일자" width="100" editable="true" required="true"
											value-format="yyyyMMdd" string-date="true"
											validator-function="paymentPlanGridValidatorFn"></sc-date-column>
						</sc-grid-columns>
					</sc-grid>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="지급방법 설명"></sc-label>
					<sc-text-field value="{{poData.pymtmeth_expln}}" readonly="[[!formula('editable')]]" max-length="128" validation-group="basic"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="납품방법"></sc-label>
					<div class="field-box" style="width:100%">
						<!--<sc-checkbox-field class="w-120" input-value="{{poData.dlvymeth_use_yn}}" checked-value="Y" un-checked-value="N"
										   label="계약서표시" readonly="[[!formula('editable')]]">
						</sc-checkbox-field>-->
						<sc-combobox-field value="{{poData.dlvymeth_ccd}}" items="{{codes.delyTermsCd}}" display-field="label" value-field="data"
										   readonly="[[!formula('editable')]]" placeholder="선택">
						</sc-combobox-field>
					</div>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="납품방법 설명"></sc-label>
					<sc-text-field value="{{poData.dlvymeth_expln}}" readonly="[[!formula('editable')]]" max-length="128" validation-group="basic"></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="세금 유형"></sc-label>
					<sc-combobox-field value="{{poData.tax_typ_ccd}}" items="{{codes.taxTypCcd}}" display-field="label" value-field="data"
									   readonly="[[!formula('editable')]]" placeholder="선택" on-change="onChangeTaxCd">
					</sc-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="지급방법 조건"></sc-label>
					<sc-textarea-field class="h-50" value="{{poData.pymtmeth_cnd}}" readonly="[[!formula('editable')]]" max-length="500" validation-group="basic"></sc-textarea-field>
				</cc-fieldset>
			</cc-form-panel>
			
			<cc-form-panel title-text="[[getCntrInfoTitleText(poData.cntr_sgng_typ_ccd)]]" collapsible="true" validation-group="basic" column="3" i18n-disabled>
				<cc-fieldset>
					<sc-label text="[[getCntrInfoCntrAmtTitleText(poData.cntr_sgng_typ_ccd)]]" i18n-disabled></sc-label>
					<sc-number-field value="{{poData.cntr_amt}}" input-cover="true" format-type="amt"
									 class="w-150 align-right" readonly="true">
					</sc-number-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="공급 금액"></sc-label>
					<sc-number-field value="{{poData.sup_amt}}" input-cover="true" format-type="amt"
									 class="w-150 align-right" readonly="true">
					</sc-number-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="VAT" i18n-disabled></sc-label>
					<sc-number-field value="{{poData.vat_amt}}" input-cover="true" format-type="amt"
									 class="w-150 align-right" readonly="true">
					</sc-number-field>
				</cc-fieldset>
				<cc-fieldset hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="계약이행보증 금액" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-checkbox-field hidden="[[formula('isECntrSgngTyp')]]" input-value="{{poData.cpgur_use_yn}}" checked-value="Y" un-checked-value="N"
										   readonly="[[!formula('editable')]]" on-click="changePerforbondYn"></sc-checkbox-field>
						<sc-number-field ihidden="[[formula('isECntrSgngTyp')]]" d="perforBondRate" value="{{poData.cpgur_ro}}" format-type="decimal" min-value="0" max-value="100"
										 class="w-140 align-right" readonly="[[!formula('perforBondEditable')]]" required="[[formula('perforBondRequired')]]" validator="perforBondRateValidator">
						</sc-number-field>&nbsp;%&nbsp;
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.cpgur_amt}}" input-cover="true" format-type="amt"
										 class="align-right" readonly="true">
						</sc-number-field>
					</div>
				</cc-fieldset>
				<cc-fieldset column-span="2" hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="계약이행보증 기간" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-combobox-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.cpgur_typ_ccd}}" items="{{codes.bondCls}}" display-field="label" value-field="data"
										   class="w-150" readonly="[[!formula('perforBondEditable')]]" placeholder="선택" required="[[formula('perforBondEssential')]]">
						</sc-combobox-field>
						<sc-period-date-field hidden="[[formula('isECntrSgngTyp')]]" id="perforBondPeriod" from-value="{{poData.cpgur_st_dt}}" to-value="{{poData.cpgur_exp_dt}}" string-date="true" style="margin-left:5px"
											  readonly="[[!formula('perforBondEditable')]]" required="[[formula('perforBondRequired')]]"></sc-period-date-field>
					</div>
				</cc-fieldset>
				<cc-fieldset hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="선급금이행보증 금액" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-checkbox-field hidden="[[formula('isECntrSgngTyp')]]" input-value="{{poData.apymtgur_use_yn}}" checked-value="Y" un-checked-value="N"
										   readonly="[[!formula('editable')]]" on-click="changePrepaybondYn"></sc-checkbox-field>
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" id="prePayBondRate" value="{{poData.apymtgur_ro}}" format-type="decimal" min-value="0" max-value="100"
										 class="w-140 align-right" readonly="[[!formula('prePayBondEditable')]]" required="[[formula('prePayBondRequired')]]" validator="prePayBondRateValidator">
						</sc-number-field>&nbsp;%&nbsp;
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.apymtgur_amt}}" input-cover="true" format-type="amt"
										 class="align-right" readonly="true">
						</sc-number-field>
					</div>
				</cc-fieldset>
				<cc-fieldset column-span="2" hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="선급금보증 일자" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-combobox-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.apymtgur_typ_ccd}}" items="{{codes.bondCls}}" display-field="label" value-field="data"
										   class="w-150" readonly="[[!formula('prePayBondEditable')]]" placeholder="선택" required="[[formula('prePayBondEssential')]]">
						</sc-combobox-field>
						<sc-period-date-field hidden="[[formula('isECntrSgngTyp')]]" id="prePayBondPeriod" from-value="{{poData.apymtgur_st_dt}}" to-value="{{poData.apymtgur_exp_dt}}" string-date="true" style="margin-left:5px"
											  readonly="[[!formula('prePayBondEditable')]]" required="[[formula('prePayBondRequired')]]"></sc-period-date-field>
					</div>
				</cc-fieldset>
				<cc-fieldset hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="하자이행보증 금액" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-checkbox-field hidden="[[formula('isECntrSgngTyp')]]" input-value="{{poData.defpgur_use_yn}}" checked-value="Y" un-checked-value="N"
										   readonly="[[!formula('editable')]]"></sc-checkbox-field>
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" id="maintBondRate" value="{{poData.defpgur_ro}}" input-cover="true" format-type="decimal" min-value="0" max-value="100"
										 class="w-140 align-right" readonly="[[!formula('maintBondEditable')]]" required="[[formula('maintBondRequired')]]" validator="maintBondRateValidator">
						</sc-number-field>&nbsp;%&nbsp;
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.defpgur_amt}}" input-cover="true" format-type="amt"
										 class="align-right" readonly="true">
						</sc-number-field>
					</div>
				</cc-fieldset>
				<cc-fieldset column-span="2" hidden="[[formula('isECntrSgngTyp')]]">
					<sc-label text="하자보증기간" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-combobox-field hidden="[[formula('isECntrSgngTyp')]]" value="{{poData.defpgur_typ_ccd}}" items="{{codes.bondCls}}" display-field="label" value-field="data"
										   class="w-150" readonly="[[!formula('maintBondEditable')]]" placeholder="선택" required="[[formula('maintBondEssential')]]">
						</sc-combobox-field>
						<sc-combobox-field hidden="[[formula('isECntrSgngTyp')]]" id="maintBondTyp" value="{{poData.defpgur_pd_typ_ccd}}" items="{{codes.maintBondTyp}}" display-field="label" value-field="data"
										   class="w-150" readonly="[[!formula('maintBondEditable')]]" style="margin-left:5px" placeholder="선택" required="[[formula('maintBondRequired')]]">
						</sc-combobox-field>
						<sc-label text="로부터" style="margin:0 5px" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
						<sc-number-field hidden="[[formula('isECntrSgngTyp')]]" id="maintBondMon" value="{{poData.defpgur_pd}}" class="w-50 align-right" readonly="[[!formula('maintBondEditable')]]"
										 min-value="0" max-length="5" required="[[formula('maintBondRequired')]]" validator="maintBondMonValidator"></sc-number-field>
						<sc-label text="개월" style="margin:0 5px" hidden="[[formula('isECntrSgngTyp')]]"></sc-label>
					</div>
				</cc-fieldset>
				<cc-fieldset column-span="4">
					<sc-label text="지체상금"></sc-label>
					<div class="field-box" style="width:100%">
						<sc-number-field value="{{poData.dfrm_ro}}" input-cover="true" format-type="decimal" min-value="0" max-value="999"
										 class="w-100 align-right" readonly="[[!formula('editable')]]" style="margin-left:5px">
						</sc-number-field>
						<sc-label text="/1000" i18n-disabled></sc-label>
					</div>
				</cc-fieldset>
			</cc-form-panel>
			
			<sc-grid id="gridPanel" class="h-400" collapsible="true" editable="[[formula('editable')]]" aggregate="true"
					 use-state="[[formula('editable')]]"
					 use-selection="[[formula('editable')]]"
					 selection-able-function="onItemSelectionAbleFn"
					 calc-footer-include-invisible="true"
					 on-item-click="onItemClick"
					 on-item-edit-end="onItemEditEnd">
				<cc-grid-toolbar title-text="품목 정보">
					<sc-button text="삭제" on-click="onDeleteItem" hidden="[[!formula('editable')]]" auth-s></sc-button>
				</cc-grid-toolbar>
				<sc-grid-columns>
					<sc-data-column data-field="po_lno" header-text="항번" width="50" editable="false" data-type="number"></sc-data-column>
					<sc-data-column data-field="disp_item_cd" header-text="품목 코드" width="100" editable="false"></sc-data-column>
					<sc-data-column data-field="item_nm" header-text="[[getItemNmHdText(poData.purc_typ_ccd)]]" width="250" text-align="left" editable="false"></sc-data-column>
					<sc-data-column data-field="item_spec" header-text="품목 규격" width="250" text-align="left" editable="false"></sc-data-column>
					<sc-image-column data-field="img_dtl_spec" header-text="품목 규격 상세" width="100" visible="[[formula('hasNoCdItem')]]"
									 image-change-function="onImageChangeFn"></sc-image-column>
					<sc-checkbox-column data-field="df_yn" header-text="면세 여부" width="60" item-editable-function="onItemEditableFn"
										display-checkbox="false"></sc-checkbox-column>
					<sc-combobox-column data-field="uom_ccd" header-text="UOM" width="60"
										display-field="data" value-field="data" items="{{codes.unitCd}}"></sc-combobox-column>
					<sc-data-column data-field="po_qty" header-text="발주 수량" width="80" text-align="right" item-editable-function="onItemEditableFn"
									required="true" max-length="8" editor-regex-function="onRegexFn" validate-on-cell-paste="true"
									data-type="number" format-type="qty" validator-function="gridValidatorFn"></sc-data-column>
					<sc-data-column data-field="po_uprc" header-text="발주 단가" width="100" text-align="right" item-editable-function="onItemEditableFn"
									required="true" max-length="13" editor-regex-function="onRegexFn" validate-on-cell-paste="true"
									data-type="number" format-type="price" aggregate-title="합계" validator-function="gridValidatorFn"></sc-data-column>
					<sc-data-column data-field="po_amt" header-text="발주 금액" width="140" text-align="right"
									format-type="amt" validator-function="gridValidatorFn"
									aggregate-function="onAmtAggregateFn" aggregate-format="amt" sort-compare-function="onSortCompareFn"></sc-data-column>
					<sc-data-column data-field="item_vat" header-text="VAT" width="120" text-align="right" editable="false"
									format-type="amt" converter="onVatConvert"
									aggregate-function="onAmtAggregateFn" aggregate-format="amt" sort-compare-function="onSortCompareFn"></sc-data-column>
					<sc-data-column data-field="gr_qty" header-text="입고 수량" width="80" text-align="right"
									data-type="number" format-type="qty" visible="[[!formula('isPurcTypCT')]]"></sc-data-column>
					<sc-data-column data-field="gr_amt" header-text="기성 금액" width="140" text-align="right"
									data-type="number" format-type="amt" visible="[[formula('isPurcTypCT')]]"></sc-data-column>
					<sc-date-column data-field="const_st_dt" header-text="공사 시작 일자" width="80" item-editable-function="onItemEditableFn"
									required="true" visible="[[formula('isPurcTypCT')]]"></sc-date-column>
					<sc-date-column data-field="const_exp_dt" header-text="공사 종료 일자" width="80" item-editable-function="onItemEditableFn"
									required="true" visible="[[formula('isPurcTypCT')]]" validator-function="gridValidatorFn"></sc-date-column>
					<sc-date-column data-field="req_dlvy_dt" header-text="요청 납품 일자" width="120" editable="false" visible="[[!formula('isPurcTypCT')]]"></sc-date-column>
					<sc-date-column data-field="dlvy_dt" header-text="납품 일자" width="80" item-editable-function="onItemEditableFn"
									required="true" visible="[[!formula('isPurcTypCT')]]" validator-function="gridValidatorFn"></sc-date-column>
					<sc-group-column	hide-child-headers="true"	header-text="플랜트"			width="180"	text-align="center"	editable="false">
						<sc-data-column		data-field="plt_cd"				width="70"	text-align="center"	editable="false"></sc-data-column>
						<sc-data-column		data-field="plt_nm"				width="70"	text-align="center"	editable="false"></sc-data-column>
						<sc-image-column	image-cls="search" data-field="img_plant_select"		width="30"	text-align="center"
											editable="false"  visible="[[formula('noCdItemPlantAddable')]]" image-change-function="onImagePlantSelectShowFunction"></sc-image-column>
					</sc-group-column>
					<sc-data-column	data-field="dlvy_plc"		header-text="납품 장소"		width="150"	text-align="left"	item-editable-function="onItemEditableFn"
									max-length="1000" required="true"></sc-data-column>
					<sc-data-column data-field="purc_grp_nm" header-text="구매 그룹" width="100"></sc-data-column>
					<sc-data-column data-field="pr_realusr_nm" header-text="구매요청 실수요자" width="100"></sc-data-column>
					<sc-data-column data-field="gr_pic_nm" header-text="입고 담당자" width="100"></sc-data-column>
					<sc-data-column data-field="rfx_no" header-text="RFX 번호" width="120"></sc-data-column>
					<sc-data-column data-field="rfx_rnd" header-text="RFX 진행차수" width="90"></sc-data-column>
					<sc-data-column data-field="rfx_bid_no" header-text="RFX 투찰 번호" width="120"></sc-data-column>
					<sc-data-column data-field="pr_no" header-text="구매요청 번호" width="120"></sc-data-column>
					<sc-data-column data-field="pr_lno" header-text="구매요청 항번" width="80" data-type="number"></sc-data-column>
					<sc-data-column data-field="po_cmpld_yn" header-text="발주 완료 여부" width="60" converter="onPoCompleteYnConvert"></sc-data-column>
				</sc-grid-columns>
				<sc-grid-fields>
					<sc-grid-field data-field="po_item_uuid"></sc-grid-field>
					<sc-grid-field data-field="pr_item_uuid"></sc-grid-field>
					<sc-grid-field data-field="pr_revno" data-type="number"></sc-grid-field>
					<sc-grid-field data-field="pr_lno" data-type="number"></sc-grid-field>
					<sc-grid-field data-field="pr_realusr_id"></sc-grid-field>
					<sc-grid-field data-field="pr_realusr_nm"></sc-grid-field>
					<sc-grid-field data-field="rfx_item_uuid"></sc-grid-field>
					<sc-grid-field data-field="rfx_item_lno"></sc-grid-field>
					<sc-grid-field data-field="rfx_bid_item_uuid"></sc-grid-field>
					<sc-grid-field data-field="rfx_bid_revno"></sc-grid-field>
					<sc-grid-field data-field="rfx_bid_lno"></sc-grid-field>
					<sc-grid-field data-field="purc_typ_ccd"></sc-grid-field>
					<sc-grid-field data-field="cost_typ"></sc-grid-field>
					<sc-grid-field data-field="plt_cd"></sc-grid-field>
					<sc-grid-field data-field="item_oorg_cd"></sc-grid-field>
					<sc-grid-field data-field="cust_ro" data-type="number"></sc-grid-field>
					<sc-grid-field data-field="cust_amt" data-type="number"></sc-grid-field>
					<sc-grid-field data-field="itemcat_cd"></sc-grid-field>
					<sc-grid-field data-field="wh_ccd"></sc-grid-field>
					<sc-grid-field data-field="purc_grp_cd"></sc-grid-field>
					<sc-grid-field data-field="gr_pic_id"></sc-grid-field>
					<sc-grid-field data-field="uprccntr_no"></sc-grid-field>
					<sc-grid-field data-field="uprccntr_revno"></sc-grid-field>
					<sc-grid-field data-field="uprccntr_lno"></sc-grid-field>
					<sc-grid-field data-field="sg_cd"></sc-grid-field>
					<sc-grid-field data-field="athg_uuid"></sc-grid-field>
					<sc-grid-field data-field="asn_qty"></sc-grid-field>
					<sc-grid-field data-field="gr_qty"></sc-grid-field>
					<sc-grid-field data-field="po_cmpld_yn"></sc-grid-field>
					<sc-grid-field data-field="po_ery_ed_yn"></sc-grid-field>
					<sc-grid-field data-field="po_ery_ed_dttm" data-type="datetime"></sc-grid-field>
					<sc-grid-field data-field="pr_reg_id"></sc-grid-field>
					<sc-grid-field data-field="pr_sd" data-type="datetime"></sc-grid-field>
					<sc-grid-field data-field="pr_ed" data-type="datetime"></sc-grid-field>
					<sc-grid-field data-field="item_cd"></sc-grid-field>
					<sc-grid-field data-field="item_cd_crn_typ_ccd"></sc-grid-field>
					<sc-grid-field data-field="item_spec_dtl"></sc-grid-field>
					<sc-grid-field data-field="item_nm"></sc-grid-field>
					<sc-grid-field data-field="item_nm_en"></sc-grid-field>
					<sc-grid-field data-field="tax_rate" data-type="number"></sc-grid-field>
					<sc-grid-field data-field="cntr_uuid"></sc-grid-field>
					<sc-grid-field data-field="cntr_no"></sc-grid-field>
					<sc-grid-field data-field="cntr_revno"></sc-grid-field>
					<sc-grid-field data-field="purc_cntr_item_uuid"></sc-grid-field>
					<sc-grid-field data-field="po_req_item_rcpt_uuid"></sc-grid-field>
					<sc-grid-field data-field="po_req_item_rcpt_qta_aloc_uuid"></sc-grid-field>
				</sc-grid-fields>
			</sc-grid>
		</div>
	</template>
	
	<script>
		Polymer({
			is: "es-po-detail-mod",
			properties: {
				poData: {
					type: Object,
					value: function() {
						return {
							cntr_st_dt: "",
							cntr_exp_dt: "",
							po_crn_dt: "",
							openedApproval: false,
							saveAfterClose: false,
							showComparePopup: false,
							showCsPopup: false,
							poClose: false,
							bypassApproval: false
						};
					}
				},
				findInfo: {
					type: Object,
					value: function() {
						return {
							param: {}
						}
					}
				},
				codes: {
					type: Object,
					value: function() {
						return {
							unitCd: [],
							domovrsDivCcd: [],
							taxTypCcd: [],
							pymtmethCcd: [],
							delyTermsCd: [],
							payClsCd: [],
							aprvSts: [],
							voProgSts: [],
							poProgSts: [],
							purcTypCcd: [],
							maintBondTyp: [],
							bondCls: [],
							modTyp: [],
							stamptaxIssueRateTyp: [],
							csTypCd: [],
							setupCd: [],
							setupParam: {
								ccd: "C000",
								dtl_cd: "USE_YN"
							},
							setupInfo: {},
							cntrdocFormListParam: {
								cntr_typ_ccd: "PO_CNTRDOC"
							},
							cntrdocFormList: [],
							taxTypCcdParam: {
								ccd: "C031",
								cstr_cnd_cd: "TAXN_RATE"
							},
							cntrSignParam: {
								ccd: "P237",
								cstr_cnd_cd: "PO"
							},
							cntrSgngTypCcd:[]  /* 계약 체결 유형 */
						}
					},
					reset: false
				},
				paymentDateCheckObj: {
					type: Object,
					value: function() {
						return {
							minApDt: null,
							maxApDt: null,
							minMpDt: null,
							minMpDt: null,
							bpDt: null
						}
					}
				},
				// Url Copy
				copyValue: {
					type: Object,
					value: function() {
						return {};
					}
				},
				
				taxRate: {
					type: Number,
					value: 0
				}
			},
			getCntrInfoTitleText: function(cntrSgngTypCcd){
				var me = this;
				return  cntrSgngTypCcd === "NA" ? me.translate("발주 정보") : me.translate("계약 정보");
			},
			getCntrInfoCntrAmtTitleText: function(cntrSgngTypCcd){
				var me = this;
				return  cntrSgngTypCcd === "NA" ? me.translate("발주 금액(VAT포함)") : me.translate("계약 금액(VAT포함)");
			},
			getModTitleText: function(modReqTyp) {
				return modReqTyp === "PURC_REQR" ? "변경 요청 정보" : "변경 정보";
			},
			getModCauseText: function(modReqTyp) {
				return modReqTyp === "PURC_REQR" ? "변경 요청 사유" : "변경 사유";
			},
            /*getRdLocatHdText: function(purcTypCcd){
				var me = this;
				var headerText = me.translate("납품 장소");
				if(purcTypCcd === "CONSTSVC") {
					headerText = me.translate("수행 장소");
				}
				return headerText;
            },*/
			getItemNmHdText: function(purcTypCcd) {
				var me = this;
				var headerText = me.translate("품목 명");
				if(purcTypCcd === "CONSTSVC") {
					headerText = me.translate("공사/용역명");
				}
				return headerText;
			},
			observers: [
				"changedPerforBondRate(poData.cpgur_use_yn, poData.cpgur_ro, poData.cntr_amt)",
				"changedPerforBondCls(poData.cpgur_typ_ccd)",
				"changedPrePayBondRate(poData.apymtgur_use_yn, poData.apymtgur_ro, poData.apymt_amt)",
				"changedPrePayBondCls(poData.apymtgur_typ_ccd)",
				"changedMaintBondRate(poData.defpgur_use_yn, poData.defpgur_ro, poData.cntr_amt)",
				"changedMaintBondCls(poData.defpgur_typ_ccd)"
			],
			
			formulas: {
				// 변경요청
				isModReq: function() {
					var me = this;
					var modReqTyp = me.get("poData.po_chg_req_typ_ccd");   // 계약변경 요청유형 - PURC_PIC: 계약변경, PURC_REQR: 계약변경요청
					return (modReqTyp === "PURC_REQR");
				},
				// 변경
				isModified: function() {
					var me = this;
					var modTyp = me.get("poData.po_chg_typ_ccd");       // 변경유형 - NEW: 신규, CHG: 변경, TRMN: 해지
					return (modTyp === "CHG");
				},
				// 해지
				isClosed: function() {
					var me = this;
					var modTyp = me.get("poData.po_chg_typ_ccd");       // 변경유형 - NEW: 신규, CHG: 변경, TRMN: 해지
					return (modTyp === "TRMN");
				},
				// 변경요청사유 변경가능 여부
				editableModReqCause: function() {
					var me = this;
					var poRev = UT.toNumber(me.get("poData.po_revno")); // 차수
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poReqTyp = me.get("poData.po_req_typ_ccd"); // 발주 요청 유형 - PR: PR기준발주, RFX: 견적기준발주
					var modReqTyp = me.get("poData.po_chg_req_typ_ccd");   // 계약변경 요청유형 - PURC_PIC: 계약변경, PURC_REQR: 계약변경요청
					
					// 1차수 이상, 반송(B),임시저장(T), 해지(R)아님. 계약변경요청(PURC_REQR)
					var possible = (poRev > 1 && (poProgSts === "CHG_RET" || poProgSts === "CRNG") && !me.formula('isClosed') && (modReqTyp === "PURC_REQR" || modReqTyp === "PURC_PIC"));
					return possible;
				},
				// 해지사유 변경가능 여부
				editableCntrCloseCause: function() {
					var me = this;
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					
					// - 임시저장(CRNG), 해지(R). 종료아님
					return (poProgSts === "CRNG" && me.formula('isClosed') && poCompYn !== "Y");
				},
				editable: function() {
					var me = this;
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					
					// 변경요청(R),임시저장(CRNG), 변경(CHG_REQ). 종료아님
					return ((poProgSts === "CHG_REQ" || poProgSts === "CRNG") && me.formula('isModified') && poCompYn !== "Y");
				},
				// 변경이력 버튼
				showModHistory: function() {
					var me = this;
					var poId = me.get("poData.po_uuid");
					var maxPoRev = UT.toNumber(me.get("poData.max_po_rev")); // 차수
					var poProgSts = me.get("poData.po_sts_ccd");
					
					return UT.isNotEmpty(poId) && (maxPoRev > 1) && poProgSts !== "CHG_REQ" && poProgSts !== "CRNG";
				},
				// 변경비교 버튼
				showComparePrev: function() {
					var me = this;
					var poId = me.get("poData.po_uuid");
					var poRev = UT.toNumber(me.get("poData.po_revno")); // 차수
					var poProgSts = me.get("poData.po_sts_ccd");
					
					return (UT.isEmpty(poId) || poProgSts === "CHG_REQ" || poProgSts === "CRNG") && poRev > 1 && me.get("findInfo.param.modify_type") != "TRMN";
				},
				// 변경 임시저장 버튼
				modifyDraftBtn: function() {
					var me = this;
					var poRev = UT.toNumber(me.get("poData.po_revno")); // 차수
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					
					// - 1차수 이상, 변경요청(R),임시저장(T), 변경(C). 종료아님
					return (poRev > 1 && (poProgSts === "CHG_REQ" || poProgSts === "CRNG") && me.formula('isModified') && poCompYn !== "Y");
				},
				// 무코드품목 추가 가능여부
				noCdItemAddable: function() {
					var me = this;

					// 수정가능 && 단가계약 아님
					return me.formula("editable") && !me.formula("isPrPurpUC");
				},
				// 변경승인 버튼
				modifySubmitBtn: function() {
					var me = this;
					return me.formula('modifyDraftBtn');
				},
				// 반송 버튼
				modifyReturnBtn: function() {
					var me = this;
					var poRev = UT.toNumber(me.get("poData.po_revno")); // 차수
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					var modReqTyp = me.get("poData.po_chg_req_typ_ccd");   // 계약변경 요청유형 - PURC_PIC: 계약변경, PURC_REQR: 계약변경요청
					
					// - 1차수 이상, 변경요청(R),임시저장(T), 계약변경요청(PURC_REQR). 종료아님
					return (poRev > 1 && (poProgSts === "CHG_REQ" || poProgSts === "CRNG") && modReqTyp === "PURC_REQR" && poCompYn !== "Y");
				},
				// 해지승인 버튼
				modifyCloseBtn: function() {
					var me = this;
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					// - 임시저장(T), 해지(R). 종료아님
					return (poProgSts === "CRNG" && me.formula('isClosed') && poCompYn !== "Y");
				},
				// 변경 결재요청 버튼
				modifyApprovalBtn: function() {
					var me = this;
					return me.formula('modifyDraftBtn');
				},
				// 삭제 버튼
				deleteBtn: function() {
					var me = this;
					var poId = me.get("poData.po_uuid");
					var poProgSts = me.get("poData.po_sts_ccd"); // 발주진행상태 - WTG: 대기중, CRNG: 임시저장, PRGSG: 발주진행중, APVD: 발주승인완료, CHG_REQ: 변경요청, CHG: 발주변경, CHG_RET: 변경반송, TRMN: 발주해지
					var poCompYn = me.get("poData.po_cmpld_yn"); // 발주완료여부
					var modTyp = me.get("poData.po_chg_typ_ccd");       // 변경유형 - NEW: 신규, CHG: 변경, TRMN: 해지
					var modReqTyp = me.get("poData.po_chg_req_typ_ccd");   // 계약변경 요청유형 - PURC_PIC: 계약변경, PURC_REQR: 계약변경요청
					
					// - poId 있음, 임시저장(T), 계약변경요청(PURC_REQR)아님, 해지(R)아님. 종료아님
					return (!UT.isEmpty(poId) && poProgSts === "CRNG" && modReqTyp !== "PURC_REQR" && me.formula('isModified') && poCompYn !== "Y");
				},
				perforBondEditable: function() {
					var me = this;
					return me.formula("editable") && me.get("poData.cpgur_use_yn") === "Y";
				},
				perforBondRequired: function() {
					var me = this;
					// 계약이행보증 유형: 보증보험
					return me.get("poData.cpgur_typ_ccd") === "GUR_INS";
				},
				maintBondEditable: function() {
					var me = this;
					return me.formula("editable") && me.get("poData.defpgur_use_yn") === "Y";
				},
				maintBondRequired: function() {
					var me = this;
					// 하자이행보증 유형: 보증보험
					return me.get("poData.defpgur_typ_ccd") === "GUR_INS";
				},
				prePayBondEditable: function() {
					var me = this;
					return me.formula("editable") && me.get("poData.apymtgur_use_yn") === "Y";
				},
				prePayBondRequired: function() {
					var me = this;
					// 선급금이행보증 유형: 보증보험
					return me.get("poData.apymtgur_typ_ccd") === "GUR_INS";
				},
				isPurcTypMT: function() {
					var me = this;
					var purcTypCcd = me.get("poData.purc_typ_ccd");
					return (purcTypCcd === "QTY");
				},
				isPurcTypCT: function() {
					var me = this;
					var purcTyp = me.get("poData.purc_typ_ccd");
					return (purcTyp === "CONSTSVC");
				},
				isPurcTypMTEditable: function() {
					var me = this;
					return me.formula("isPurcTypMT") && me.formula("editable");
				},
				hasNoCdItem: function() {
					var me = this;
					return me.get("poData.has_no_cd_item") === "Y";
				},
				noCdItemPlantAddable: function() {
					var me = this;
					return me.formula("editable") && me.formula("hasNoCdItem");
				},
				checkAbleStamptaxYn: function() {
					var me = this;
					return me.formula('checkableElecCntrYn') && (me.poData.cntr_use_yn === "Y");
				},
				checkAbleStamptaxIssueRateTyp: function() {
					var me = this;
					return me.formula('checkAbleStamptaxYn') && (me.poData.stax_yn === "Y");
				},
				// 전자계약여부 체크가능여부
				checkableElecCntrYn: function() {
					var me = this;
					
					if(UT.isNotEmpty(me.get("poData.uprccntr_no")) || me.formula('isECntrSgngTyp')) {
						return false;
					}
					return me.formula("editable");
				},
				// 컨소시엄유형 보이기
				showCsTyp: function() {
					return this.get("poData.cstm_yn") === "Y";
				},
				showElecStamptax: function() {
					return this.get("codes.setupInfo.estax_yn") === "Y";
				},
				checkAbleElecStamptaxYn: function() {
					var me = this;
					return me.formula('checkableElecCntrYn') && me.get("poData.stax_yn") === "Y" && me.formula('showElecStamptax');
				},
				saveEcntrDraftBtn: function() {
					var me = this;
					return (UT.isEmpty(me.poData.cntr_uuid) && me.poData.cntr_use_yn === "Y");
				},
				showEcntrViewBtn: function() {
					var me = this;
					var poId = me.get("poData.po_uuid");
					return (UT.isNotEmpty(poId) && UT.isNotEmpty(me.poData.cntr_uuid) && me.poData.cntr_use_yn === "Y");
				},
				/* 계약기간 필수 여부 (보증종류가 보증보험일 경우) */
				isRequiredCntrDate: function(){
					return this.get("poData.apymtgur_typ_ccd") === "GUR_INS"
						|| this.get("poData.defpgur_typ_ccd") === "GUR_INS"
						|| this.get("poData.cpgur_typ_ccd") === "GUR_INS";
				},
				hasEdocModule: function(){
					return SCModuleManager.exist("EDOC");
				},

				isEcntrUseAndAutoCrn: function(){
					var me = this;
					return  me.get("poData.cntr_sgng_typ_ccd") === "ECNTR" && me.codes.setupInfo.ecntr_drt_crn_yn === 'Y';
				},
				// 계약이행보증기간
				perforBondEssential : function(){
					var me = this;
					return (me.poData.cpgur_use_yn === "Y");
				},
				// 선급금보증기간
				prePayBondEssential : function(){
					var me = this;
					return (me.poData.apymtgur_use_yn === "Y");
				},
				// 하자보증기간
				maintBondEssential : function(){
					var me = this;
					return (me.poData.defpgur_use_yn === "Y");
				},
				isECntrSgngTyp: function(){
					var me = this;
					return me.get("poData.cntr_sgng_typ_ccd") !== "NA";
				},
				poEvalSetBtn: function() {
					var me = this;
					return me.get("poData.ge_subj_yn") === "Y" && !me.formula('isViewMode');
				},
				geEvalSetBtnTxt: function() {
					var me = this;
					var purcTypCcd = me.get("poData.purc_typ_ccd");
					return purcTypCcd === "QTY" ? me.translate("입고평가 설정") : me.translate("기성평가 설정");
				},
				purcTypTxt: function() {
					var me = this;
					var poData = me.get("poData");
					if(poData == null) {
						return "";
					}
					return poData.purc_typ_ccd === "QTY" ? me.translate("입고") : me.translate("기성");
				}
			},
			
			// 화면 생성 완료
			initialized: function() {
				var me = this;
				
				// SETUP 정보 설정
				if(SCModuleManager.exist('EDOC') && me.get("codes.setupInfo.ecntr_drt_crn_yn") === "Y") {
					UT.request(me.$.findCntrdocFormList);
				}
				me.applyFormula('showElecStamptax');
			},
			// 기본 파라미터 설정
			load: function(param) {
				var me = this;
				me.set("findInfo.param", UT.copy(param));
				// Url Copy Param Set
				me.set("copyValue", {
					app_id: param.po_uuid
				});
				me.onFindInfo();
			},
			
			// 상세정보 조회
			onFindInfo: function() {
				var me = this;
				UT.request(me.$.findInfo);
			},
			
			// 상세정보 조회 완료
			completeFindInfo: function(e, res) {
				var me = this;
				var data = res.response;
				if(data) {
					me.set("poData", data || me.getPropertyInfo("poData").value());
					
					if(me.get("findInfo.param.modify_type") === "CHG") {
						var provider = me.$.gridPanel.getDataProvider();
						provider.removeAll(false);	// 그리드 데이터 초기화. removeItems에 담지 않도록 collectionRemoveItems를 false로 넘김
						provider.addItems(data.items);
						me.set("poData.items", undefined);
					} else if(me.get("findInfo.param.modify_type") === "TRMN") {
						me.$.gridPanel.setDataProvider(data.items);
						me.set("poData.items", undefined);
					} else {
						me.$.gridPanel.setDataProvider(data.items);
					}
					me.$.paymentPlanGrid.setDataProvider(data.paymentPlans);
					me.afterLoadingPaymentPlans();
					
					me.applyFormula();
					me.onChangeCntrSgngTypCcdCombo();
				}
			},
			
			// 지불조건 조회 후 처리
			afterLoadingPaymentPlans: function() {
				var me = this;
				var provider = me.$.paymentPlanGrid.getDataProvider(),
					plans    = provider.getItems();
				
				var apAmt = new BigNumber(0);
				for(var i = 0, len = plans.length; i < len; i++) {
					var plan = plans[i];
					if(plan["pymt_typ_ccd"] === "APYMT") {			// 선급금
						apAmt = apAmt.plus(new BigNumber(plan["pymt_amt"]));
					}
				}
				me.set("poData.apymt_amt", new BigNumber(apAmt.toFixed()));
			},
			
			// 지급예정일 validator 수행 전 min-max 날짜 계산
			calculatePaymentDate: function() {
				var me       = this,
					provider = me.$.paymentPlanGrid.getDataProvider(),
					plans    = provider.getItems(),
					minApDt, maxApDt, minMpDt, maxMpDt;
				
				plans.forEach(function(plan) {
					var payClsCd = plan["pymt_typ_ccd"],
						exptDt   = plan["pymt_expt_dt"];
					
					if(payClsCd === "APYMT") {
						if(UT.isEmpty(minApDt) || (minApDt > exptDt)) minApDt = exptDt;
						if(UT.isEmpty(maxApDt) || (maxApDt < exptDt)) maxApDt = exptDt;
					} else if(payClsCd === "IPYMT") {
						if(UT.isEmpty(minMpDt) || (minMpDt > exptDt)) minMpDt = exptDt;
						if(UT.isEmpty(maxMpDt) || (maxMpDt < exptDt)) maxMpDt = exptDt;
					}
				});
				me.set("paymentDateCheckObj", {
					"minApDt": minApDt,
					"maxApDt": maxApDt,
					"minMpDt": minMpDt,
					"maxMpDt": maxMpDt
				});
			},
			
			onPayPlanRegexFn: function(data, item) {
				var me = this;
				if(item.dataField === "pymt_amt") {
					return CCPrecManager.regex("amt", me.get("poData.cur_ccd"));
				}
				return null;
			},
			// 지불조건 그리드 validator-function
			paymentPlanGridValidatorFn: function(headerText, dataField, data) {
				var me    = this,
					value = data[dataField];
				
				if(dataField === "pymt_amt") {				// 지급액
					if(UT.isEmpty(value) || value <= 0) {
						return me.translate("STD.E1008", null, me.translate(headerText), "0");		// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}
					var cur = me.get("poData.cur_ccd");
					if(!CCPrecManager.validate("amt", value, cur)) {
						return me.translate("STD.E1021", null, CCPrecManager.validateInfo("amt", cur).decimalprecision);	// 이 필드는 소수점 '{0}' 자리까지 입력 가능합니다.
					}
				} else if(dataField === "pymt_expt_dt") {	// 지급예정일
					if(UT.isEmpty(value)) {
						return me.translate("STD.E1001", null, me.translate(headerText));
					}
					
					var payClsCd            = data["pymt_typ_ccd"],
						paymentDateCheckObj = me.get("paymentDateCheckObj"),
						minApDt             = paymentDateCheckObj.minApDt,	// MIN 선급금 지급예정일
						maxApDt             = paymentDateCheckObj.maxApDt,	// MAX 선급금 지급예정일
						minMpDt             = paymentDateCheckObj.minMpDt,	// MIN 중도금 지급예정일
						maxMpDt             = paymentDateCheckObj.maxMpDt,	// MAX 중도금 지급예정일
						nowDate             = UT.formatDate(new Date(), "yyyyMMdd");
					
					// 현재 데이터가 MIN 중도금 지급예정일인 경우,
					if(payClsCd === "IPYMT" && value == minMpDt) {
						// 선급금 존재 시
						if(UT.isNotEmpty(maxApDt)) {
							// MAX 선급금 지급예정일과 비교
							if(UT.isNotEmpty(value) && (maxApDt >= value)) {
								// {0}은(는) {1}이후 날짜로 입력하십시오
								return me.translate("STD.E1013", null, me.translate("중도금 지급 예정 일자"), me.translate("선급금 지급 예정 일자"));
							}
						}
					}
					
					// 잔금 지급예정일인 경우 (잔금은 항상 1건임)
					if(payClsCd === "BAL") {
						// 중도금 존재 시
						if(UT.isNotEmpty(maxMpDt)) {
							// MAX 중도금 지급예정일과 비교
							if(maxMpDt >= value) {
								// {0}은(는) {1}이후 날짜로 입력하십시오
								return me.translate("STD.E1013", null, me.translate("잔금 지급 예정 일자"), me.translate("중도금 지급 예정 일자"));
							}
							// 중도금 미존재, 선급금 존재 시
						} else if(UT.isNotEmpty(maxApDt)) {
							// MAX 선급금 지급예정일과 비교
							if((maxApDt >= value)) {
								// {0}은(는) {1}이후 날짜로 입력하십시오
								return me.translate("STD.E1013", null, me.translate("잔금 지급 예정 일자"), me.translate("선급금 지급 예정 일자"));
							}
						}
					}
				}
				return true;
			},
			
			// 지불조건 그리드 selection-able-function
			onPaymentPlanSelectionAbleFn: function(data) {
				var me = this;
				
				// 선급금인 경우 이미 기성 승인건 하나라도 존재하면 선택 불가
				if(data["pymt_typ_ccd"] === "APYMT" && me.get("poData.pay_comp_cnt") > 0) {
					return false;
				}
				
				// 잔금 삭제 불가
				if(data["pymt_typ_ccd"] === "BAL") {
					return false;
				}
				
				return true;
			},
			
			// 지불조건 그리드 item-edit-end
			/*
			 * item-edit-begin에서 설정에 관한 오류 메시지 처리 및 변경이벤트 취소를 구현하려 했으나,
			 * 붙여넣기 시 제어가 불가하여 item-edit-end에서 모두 수행함
			 */
			onPaymentPlanEditEnd: function(event) {
				var me = this, e = event.detail,
					data         = e.data,
					item         = e.item,
					newValue     = e.newValue,
					oldValue     = e.oldValue,
					provider     = e.provider;
				
				if(item.dataField === "pymt_typ_ccd") {		// 지급구분코드 변경 시
					if(oldValue === "APYMT" && newValue === "IPYMT") {		// 선급금 -> 중도금
						var mpIndexes = provider.filterIndexes(function(data) {
							return data["pymt_typ_ccd"] === "IPYMT";
						});
						// 선급금은 항상 중도금 앞이었으므로 이동할 필요 없음
						//provider.moveRow(item.rowIndex, mpIndexes[0]);		// 중도금의 첫 번째로 이동
						
					} else if(oldValue === "IPYMT" && newValue === "APYMT") {	// 중도금 -> 선급금
						var apIndexes = provider.filterIndexes(function(data) {
							return data["pymt_typ_ccd"] === "APYMT";
						});
						if(apIndexes.length === 1) {						// 선급금이 지금 바꾼 데이터 하나뿐이면
							provider.moveRow(item.rowIndex, 0);					// 제일 첫 번째로 이동
						}/* else {											// 선급금이 지금 바꾼 데이터 외에도 존재하는 경우 -> onItemsFn에 의해 애초에 바꿀 수 없음
            				//provider.setItemAt(item.rowIndex, {pymt_typ_ccd: oldValue});
            			}*/
					}
				} else if(item.dataField === "pymt_amt") {	// 지급금 변경 시
					var newPayAmt = new BigNumber(newValue || 0),
						oldPayAmt = new BigNumber(oldValue || 0);
					
					if(newPayAmt.isZero()) {
						UT.alert(me.translate("STD.E1008", null, me.translate(headerText), "0"), null, true);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
						provider.setItemAt(item.rowIndex, {"pymt_amt": oldValue});
					}
					
					var poAmt = new BigNumber(me.get("poData.po_amt") || 0);
					var payRate = CCPrecManager.format("decimal", (new BigNumber(100)).mul(newPayAmt).div(poAmt).toFixed());
					provider.setItemAt(item.rowIndex, {"pymt_ro": payRate});
					
					// 지급율 재계산 (잔금 지급율 소수점 때문)
					me.calculatePaymentPlanRate();
					
					// 선급금 변경완료 시 : 선급금이행보증금 계산
					if(data["pymt_typ_ccd"] === "APYMT") {
						me.changedPrePayAmt(newPayAmt);
					}
					
				} else if(item.dataField === "pymt_expt_dt" && UT.isNotEmpty(newValue)) {	// 지급예정일 변경 시
					if(provider.filterItems({"pymt_expt_dt": UT.formatDate(newValue, 'yyyyMMdd')}).length > 1) {
						// 지급예정일은 중복이 불가합니다.
						UT.alert("STD.PO1069");
						provider.setItemAt(item.rowIndex, {"pymt_expt_dt": oldValue});
					}
				}
			},
			
			// 지불조건 - 지급율 계산
			calculatePaymentPlanRate: function() {
				var me             = this,
					poAmt          = new BigNumber(me.get("poData.po_amt") || 0),
					provider       = me.$.paymentPlanGrid.getDataProvider(),
					payPlans       = provider.getItems(),
					sumPayAmt      = new BigNumber(0),
					sumPayRateExBp = new BigNumber(0),
					cur            = me.get("poData.cur_ccd");
				
				for(var i = 0, len = payPlans.length; i < len; i++) {
					var payPlan = payPlans[i];
					sumPayAmt = sumPayAmt.plus(new BigNumber(payPlan["pymt_amt"] || 0));
					
					if(payPlan["pymt_typ_ccd"] !== "BAL") {
						sumPayRateExBp = sumPayRateExBp.plus(new BigNumber(payPlan["pymt_ro"]) || 0);
					}
				}
				// 발주총액과 지급금액 합이 동일하게 입력되었다면
				if(poAmt.eq(sumPayAmt)) {
					// 잔금의 지급율을 100-[잔금 외 지급율 합]으로 한다. (소수점 절사에 의해 총 지급율 합이 100이 되지 않을 수 있기 때문)
					payRate = CCPrecManager.format("decimal", (new BigNumber(100)).minus(sumPayRateExBp).toFixed());
				}
				
				// 지급율 계산
				provider.setItemAtBatch(true, function(nodeIndex, data) {
					if(data["pymt_typ_ccd"] === "BAL" && poAmt.eq(sumPayAmt)) {
						return {"pymt_ro": CCPrecManager.format("decimal", (new BigNumber(100)).minus(sumPayRateExBp).toFixed())};
					} else {
						return {"pymt_ro": CCPrecManager.format("decimal", (new BigNumber(100)).mul(new BigNumber(data["pymt_amt"] || 0)).div(poAmt).toFixed())};
					}
				});
			},
			
			// 선급금 변경완료 시
			changedPrePayAmt: function(apAmt) {
				var me = this;
				me.set("poData.apymt_amt", new BigNumber(apAmt.toFixed() || 0));
			},
			
			// 지급추가 버튼 클릭
			onAddPaymentPlan: function() {
				var me = this;
				var provider = me.$.paymentPlanGrid.getDataProvider(),
					items    = provider.getItems();
				
				var apIndexes = provider.filterIndexes(function(data) {
					return data["pymt_typ_ccd"] === "APYMT";
				});
				var mpIndexes = provider.filterIndexes(function(data) {
					return data["pymt_typ_ccd"] === "IPYMT";
				});
				var bpIndexes = provider.filterIndexes(function(data) {
					return data["pymt_typ_ccd"] === "BAL";
				});
				
				var addPayPlan = function(index, payClsCd) {
					provider.addItemAt(index, {
						"pymt_typ_ccd": payClsCd,
						"pymt_ro": 0,
						"pymt_amt": 0
					});
				};
				
				if(me.get("poData.pay_comp_cnt") === 0 && apIndexes.length === 0) {
					// 1. 기성 승인 건 미존재, 그리드에 선급금 미존재 시 선급금 추가 (선급금은 0개 또는 1개 존재 가능)
					addPayPlan(0, "APYMT");
				} else {
					// 2. 기성 승인 건 존재하거나, 그리드에 선급금 존재 시 잔금 앞에 중도금 추가 (잔금은 항상 1개 필수 존재해야 함)
					addPayPlan(bpIndexes[0], "IPYMT");
				}
			},
			
			// 지급삭제 버튼 클릭
			onDeletePaymentPlan: function() {
				var me = this;
				var provider = me.$.paymentPlanGrid.getDataProvider();
				var checked = provider.selectionCheckedItems();
				
				if(checked.length === 0) {
					UT.alert("STD.N1600"); // 선택된 항목이 없습니다
					return;
				}
				
				UT.confirm("STD.N1300", function() {	// "삭제 하시겠습니까?"
					// 선급금
					var apChanged = false, apAmt = new BigNumber(me.get("poData.apymt_amt") || 0);
					for(var i = 0, len = checked.length; i < len; i++) {
						var item = checked[i],
							amt  = new BigNumber(item["pymt_amt"] || 0);
						
						if(item["pymt_typ_ccd"] === "APYMT") {	// 선급금 삭제라면
							apAmt = apAmt.minus(amt);			// 선급금 = 선급금 - 삭제할 금액
							apChanged = true;
						}
					}
					provider.removeItems(true);
					
					// 선급금 변경완료 시 : 선급금이행보증금 계산
					if(apChanged) {
						me.changedPrePayAmt(apAmt);
					}
					// 지급율 재계산 (잔금 지급율 소수점 때문)
					me.calculatePaymentPlanRate();
				});
			},
			
			// 지급구분 items-function
			onItemsFn: function(data, item) {
				var me       = this,
					provider = me.$.paymentPlanGrid.getDataProvider();
				
				if(item.dataField === "pymt_typ_ccd") {
					var items    = me.get("codes.payClsCd"),
						payClsCd = data["pymt_typ_ccd"];
					
					if(payClsCd === "APYMT") {						// 1. 선급금
						return items.filter(function(obj) {
							return (obj["data"] !== "BAL");			// 잔금 제외: 선급금,중도금
						});
					} else if(payClsCd === "BAL") {				// 2. 잔금 (onPayPlanItemEditableFn에 의해 수정 불가)
						return items.filter(function(obj) {
							return (obj["data"] === "BAL");			// 잔금
						});
					} else {									// 3. 중도금 or 빈값
						var aps = provider.filterItems({"pymt_typ_ccd": "APYMT"});
						// 기성 승인 건 미존재하고, 그리드의 선급금 데이터 미존재 시
						if(me.get("poData.pay_comp_cnt") === 0 && aps.length === 0) {
							return items.filter(function(obj) {
								return (obj["data"] !== "BAL");		// 잔금 제외: 선급금,중도금
							});
						} else {	// 기성 승인 건이 존재하거나, 그리드의 선급금 데이터가 존재할 때
							return items.filter(function(obj) {
								return (obj["data"] === "IPYMT");		// 중도금
							});
						}
					}
				}
			},
			
			// 지불조건 item-editable-function
			onPayPlanItemEditableFn: function(data, item) {
				var me = this;
				// 지급구분이 선급금이고, 이미 기성 승인건 하나라도 존재하면 변경 불가
				if(item.dataField === "pymt_typ_ccd" && data["pymt_typ_ccd"] === "APYMT" && me.get("poData.pay_comp_cnt") > 0) {
					return false;
				}
				
				// 지급구분이 잔금인 경우: 지급금 변경 불가
				if(data["pymt_typ_ccd"] === "BAL" && item.dataField === "pymt_typ_ccd") {
					return false;
				}
				return true;
			},
			
			onPayPlanAggregateFn: UT.plusBigNumber,
			onPayPlanAmtAggregateFn: UT.plusBigNumber,
			
			onItemSelectionAbleFn: function(data) {
				var me       = this,
					crcEndYn = data["po_ery_ed_yn"] || "N",
					compYn   = data["po_cmpld_yn"] || "N";
				
				// 이미 종료된 품목 삭제 불가
				if(crcEndYn === "Y" || compYn === "Y") {
					return false;
				}
				
				var purcTyp = data["purc_typ_ccd"],
					grQty   = new BigNumber(data["gr_qty"] || 0),
					grAmt   = new BigNumber(data["gr_amt"] || 0);
				
				// 물품일 때, 검수수량 존재 시 해당 품목 삭제 불가
				if(purcTyp === "QTY" && grQty.gt(new BigNumber(0))) {
					return false;
					// 공사용역일 때, 기성금액 존재 시 해당 품목 삭제 불가
				} else if(purcTyp === "CONSTSVC" && grAmt.gt(new BigNumber(0))) {
					return false;
				}
				return true;
			},
			
			//그리드 셀 edit완료 함수
			onItemEditEnd: function(event) {
				var me = this, e = event.detail,
					data         = e.data,
					item         = e.item,
					newValue     = e.newValue,
					oldValue     = e.oldValue,
					provider     = e.provider,
					fieldName    = item.dataField,
					itemIndex    = item.rowIndex;
				
				me.itemIndex = itemIndex;
				me.fieldName = fieldName;
				
				if(fieldName === "po_qty" || fieldName === "po_uprc") {
					var unitCd = data["uom_ccd"],
						qty    = data["po_qty"] || 0,
						price  = data["po_uprc"] || 0;
					
					// UOM/수량 변경 시
					if(item.dataField === "uom_ccd") {
						// 수량 소수점처리
						qty = CCPrecManager.format("qty", qty, unitCd);
					}
					
					// 금액 계산 소수점처리
					var amt = CCPrecManager.format("amt", (new BigNumber(qty)).mul(new BigNumber(price)).toFixed(), me.get("poData.cur_ccd"));
					
					provider.setItemAt(item.rowIndex, {
						"po_qty": qty,
						"po_amt": amt
					});
					
				} else if(fieldName === "df_yn") {
					
					// 공급가액, 세액, 계약금액 등 변경
					me.changedPoTotAmt();
					
				} else if(fieldName === "const_st_dt" || fieldName === "const_exp_dt") {
					me.computeCntrPrdDate(); // 계약기간 계산
				}
			},
			//그리드 데이터 클릭 함수
			onItemClick: function(event) {
				var me = this, detail = event.detail,
					data              = detail.data,
					item              = detail.item;
				
				if(item.dataField === "img_dtl_spec" && data["item_cd_crn_typ_ccd"] === "CDLS") {	// 상세규격(미등록 품목인 경우)
					var popup = UT.popup('ep-item-detail-spec', me, 400, 260);
					popup.show();
					popup.getWindowContent().load(data);
				}else if(item.dataField === 'img_plant_select' && (UT.isNotEmpty(data["item_cd_crn_typ_ccd"]) && data["item_cd_crn_typ_ccd"] === 'CDLS')){
					// 팝업 호출
					UT.popupOperOrgLinkSearch(me,me.poData.oorg_cd,'POIO',function(selectedItems) {
						provider.setItemAt(item.rowIndex, {
							"plt_cd": selectedItems[0].org_cd,
							"item_oorg_cd": selectedItems[0].oorg_cd,
							"plt_nm": selectedItems[0].logic_org_nm
						});
					});
				}
			},
			// 그리드 image-change-function
			onImageChangeFn: function(data, item) {
				if(item.dataField === "img_dtl_spec" && data["item_cd_crn_typ_ccd"] === "CDLS") {	// 상세규격(미등록 품목인 경우)
					return "link";
				}
				return null;
			},
			// 품목그리드 item editable 제어
			onItemEditableFn: function(data, item) {
				if(item.dataField === "po_uprc") {
					return UT.isEmpty(data["rfx_no"]) && UT.isEmpty(data["uprccntr_no"]) && (data["po_cmpld_yn"] !== "Y");
				} else if(item.dataField === "po_qty") {
					return UT.isEmpty(data["pr_item_uuid"]) && (data["po_cmpld_yn"] !== "Y");
				} else {
					// 발주완료여부
					return (data["po_cmpld_yn"] != "Y");
				}
			},
			// grid column editor-regex-function
			onRegexFn: function(data, item) {
				var me = this;
				switch(item.dataField) {
					case "po_qty":
						return CCPrecManager.regex("qty", data["uom_ccd"]);
					case "po_uprc":
						return CCPrecManager.regex("price", me.get("poData.cur_ccd"));
					default:
						return null;
				}
			},
			// 발주종료 컬럼 converter
			onPoCompleteYnConvert: function(rowIndex, fieldName, data) {
				var crcYn = data["po_ery_ed_yn"] || "N"; // 강제종료
				var compYn = data["po_cmpld_yn"] || "N"; // 완료
				// 강제종료, 발주완료
				return crcYn === "Y" || compYn === "Y" ? "Y" : "N";
			},
			
			perforBondRateValidator: function(value) {
				var me = this;
				if(me.formula("perforBondRequired")) {
					var rate = new BigNumber(value || 0);
					if(rate.isZero()) {
						return me.translate("STD.E1008", null, me.translate("계약이행보증 비율"), 0);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}
				}
				return true;
			},
			prePayBondRateValidator: function(value) {
				var me = this;
				if(me.formula("prePayBondRequired")) {
					var rate = new BigNumber(value || 0);
					if(rate.isZero()) {
						return me.translate("STD.E1008", null, me.translate("선급금이행보증 비율"), 0);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}
				}
				return true;
			},
			maintBondRateValidator: function(value) {
				var me = this;
				if(me.formula("maintBondRequired")) {
					var rate = new BigNumber(value || 0);
					if(rate.isZero()) {
						return me.translate("STD.E1008", null, me.translate("하자이행보증 비율"), 0);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}
				}
				return true;
			},
			maintBondMonValidator: function(value) {
				var me = this;
				if(me.formula("maintBondRequired")) {
					var rate = new BigNumber(value || 0);
					if(rate.isZero()) {
						return me.translate("STD.E1008", null, me.translate("하자이행보증 개월 수"), 0);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}
				}
				return true;
			},
			//그리드 validator-function
			gridValidatorFn: function(headerText, dataField, data) {
				var me = this;
				var value = data[dataField];
				var purcTyp = me.get("poData.purc_typ_ccd");
				
				// 구매유형이 공사용역일 경우, 발주금액은 기성금액보다 커야 함
				if(purcTyp === "CONSTSVC" && dataField === "po_amt") {
					value = new BigNumber(value || 0);
					if(value.isZero()) {
						// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
						return me.translate("STD.E1008", null, me.translate(headerText), 0);
					}
					
					// 기성금액
					var compareValue = new BigNumber(data["gr_amt"] || 0);
					// value <= compareValue
					if(value.lte(compareValue)) {
						// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
						return me.translate("STD.E1008", null, me.translate(headerText), me.translate("기성금액"));
					}
					// 구매유형이 공사용역일 경우 (필수값) 공사 종료 일자은 공사 시작 일자보다 이후여야 함
				} else if(purcTyp === "CONSTSVC" && dataField === "const_exp_dt" && UT.isNotEmpty(value)) {
					value = UT.toTime(UT.toDate(value, "yyyyMMdd"));
					// 공사 시작 일자
					var minDate = UT.toTime(UT.toDate(data['const_st_dt'], "yyyyMMdd"));
					if(value < minDate) {
						// {0}은(는) {1}이후 날짜로 입력하십시오
						return me.translate("STD.E1013", null, me.translate(headerText), me.translate("공사 시작 일자"));
					}
				} else if(["po_qty", "po_uprc"].indexOf(dataField) > -1) {
					value = new BigNumber(value || 0);
					if(value.isZero()) {
						// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
						return me.translate("STD.E1008", null, me.translate(headerText), 0);
					}
					
					// 구매유형이 물품인 경우, 발주수량이 입고수량보다 커야 함
					if(purcTyp === "QTY" && dataField === "po_qty") {
						// 입고수량
						var minValue = new BigNumber(data["gr_qty"] || 0);
						// value <= minValue
						if(value.lt(minValue)) {
							// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
							return me.translate("STD.E1008", null, me.translate(headerText), me.translate("입고 수량"));
						}
					}
					var formatterName, dtlCd;
					if(dataField === "po_qty") {
						// UOM 존재 시 단위별 수량 포맷유형, UOM 미존재 시 기본 수량 포맷유형
						formatterName = "qty";
						dtlCd = data["uom_ccd"];
					} else {
						formatterName = "amt";
						dtlCd = me.get("poData.cur_ccd");
					}
					if(!CCPrecManager.validate(formatterName, value, dtlCd)) {
						return me.translate("STD.E1021", null, CCPrecManager.validateInfo(formatterName, dtlCd).decimalprecision);	// 이 필드는 소수점 '{0}' 자리까지 입력 가능합니다.
					}
				}
				return true;
			},
			/* 그리드 이벤트 헨들링  END */
			
			// 데이터 유효성 검사
			isValid: function(saveType) {
				var me = this;
				
				if(saveType !== "draft" && !me.formula("isModReq") && !me.validate('modReq')) {
					UT.alert("STD.E0000");	// 유효하지 않은 입력값이 있습니다. 오류 정보를 확인해 주세요.
					return false;
				}
				
				if(!me.validate("basic")) {
					UT.alert("STD.E0000");
					return false;
				}
				
				var provider = me.$.gridPanel.getDataProvider();
				if(!provider || provider.getItemSize() === 0) {
					UT.alert("STD.PR1002"); //"품목 정보가 없습니다."
					return false;
				}
				
				if(!me.$.gridPanel.validate()) {
					UT.alert("STD.N1102");
					return false;
				}
				
				// 지급조건그리드 validate
				me.calculatePaymentDate();
				if(!me.$.paymentPlanGrid.validate()) {
					UT.alert("STD.PO1064");	// 지불조건에 오류가 있습니다. 확인 바랍니다.
					return false;
				}
				
				var poAmt     = new BigNumber(me.get("poData.po_amt") || 0),
					sumPayAmt = new BigNumber(0),
					payPlans  = me.$.paymentPlanGrid.getDataProvider().getItems();
				for(var i = 0, len = payPlans.length; i < len; i++) {
					var payPlan = payPlans[i];
					sumPayAmt = sumPayAmt.plus(new BigNumber(payPlan["pymt_amt"] || 0));
				}
				if(!sumPayAmt.eq(poAmt)) {
					UT.alert("STD.PO1080"); // 총 지급액은 발주금액과 동일해야 합니다.
					return false;
				}
				// 선급금이행보증금에 대한 지불조건 validate
				var provider = me.$.paymentPlanGrid.getDataProvider(),
					Items    = provider.getItems();
				var Item = [];
				for(var i = 0, len = Items.length; i < len; i++) {
					var Item = Items[i];
					/* 지불조건그리드 선급금존재X 이고, 선급금이행보증금 체크박스의 check-value값이 "Y"일 경우 */
					if(Item["pymt_typ_ccd"] !== "APYMT" && me.formula("prePayBondEssential")) {
						UT.alert("STD.PO1084");	//선급금 이행보증금이 있는 경우, 선급금이 존재해야합니다. 지불조건을 확인하세요.
						return false;
					}
					return true;
				}
				return true;
			},
			
			// 변경 임시저장
			onModifyDraft: function() {
				var me = this;
				
				if(me.isValid("draft") === false) {
					return;
				}
				me.set("poData.openedApproval", false);
				me.set("poData.saveAfterClose", false);
				me.set("poData.showComparePopup", false);
				me.set("poData.showCsPopup", false);
				me.onSave(me.$.modifyDraft, "STD.N1200");
			},
			
			// 반송
			onModifyReturn: function() {
				var me = this;
				me.set("poData.openedApproval", false);
				me.set("poData.saveAfterClose", true);
				me.set("poData.showComparePopup", false);
				me.set("poData.showCsPopup", false);
				UT.confirm("STD.PO1005", function() {
					UT.request(me.$.modifyReturn);
				});
			},
			
			// 변경승인
			onModifySubmit: function() {
				var me = this;
				
				if(me.isValid("submit") === false) {
					return;
				}
				//me.set("poData.openedApproval", false);
				//me.set("poData.saveAfterClose", true);
				//me.set("poData.showComparePopup", false);
				//me.set("poData.showCsPopup", false);
				me.set("poData.bypassApproval", true);
				me.onSave(me.$.modifySubmit, "STD.PO1006");
			},
			
			// 발주해지
			onModifyClose: function() {
				var me = this;
				
				if(!me.validate('modifyClose')) {
					UT.alert("STD.E0000");
					return;
				}
				if(!me.validate("basic")) {
					UT.alert("STD.E0000");
					return;
				}
				me.set("poData.openedApproval", false);
				me.set("poData.saveAfterClose", true);
				me.set("poData.showComparePopup", false);
				me.set("poData.showCsPopup", false);
				
				
				UT.confirm("STD.PO1007", function() {
					Promise.all([me.$.upload1.upload(), me.$.upload2.upload()]).then(function() {
						me.set("poData.poClose", true);	//발주해지
						me.$.modifyClose.body = {
							poData: me.get("poData")
						};
						
						UT.request(me.$.modifyClose);
					});
				});
			},
			
			// 변경결재요청 - 데이터 저장후 결재 팝업
			onModifyApproval: function() {
				var me = this;
				
				if(me.isValid("approval") === false) {
					return;
				}
				me.set("poData.openedApproval", true);
				me.set("poData.saveAfterClose", false);
				me.set("poData.showComparePopup", false);
				me.set("poData.showCsPopup", false);
				me.onSave(
						me.$.modifyDraft,
						"STD.N2300", // 결재 상신하시겠습니까?
						function() {
							me.set("poData.openedApproval", false);
						}
				);
			},
			
			// 저장
			onSave: function(ajax, message, cancelCallback) {
				var me              = this,
					itemProvider    = me.$.gridPanel.getDataProvider(),
					payPlanProvider = me.$.paymentPlanGrid.getDataProvider();

				var saveFn = function() {
					Promise.all([me.$.upload1.upload(), me.$.upload2.upload()]).then(function() {
						ajax.body = {
							poData: me.get("poData"),
							insertItems: itemProvider.getNewItems(),
							updateItems: itemProvider.getUpdateItems(),
							deleteItems: itemProvider.getRemoveItems(),
							paymentPlans: payPlanProvider.getItems()		// 지불조건은 전체 데이터
						};
						UT.request(ajax);
					}, cancelCallback);
				};
				
				if(UT.isNotEmpty(message)) {
					UT.confirm(message, function() {
						saveFn();
					}, cancelCallback); // 저장하시겠습니까?
				} else {
					saveFn();
				}
			},
			
			// 저장 완료
			completeSaveInfo: function(e, res) {
				var me = this;
				var result     = res.response,
					status     = result.resultStatus,
					resultData = result.resultData;
				
				if(status === "S") {
					var poId = resultData["po_uuid"];
					me.procAfterSave(poId);
					
				} else if(status === "HAS_GR_ITEM") {	//검수/기성 요청 및 진행중인 품목 존재시
					UT.alert("STD.PO1031");	//"검수/기성중인 품목이 존재하여 발주변경 및 해지를 진행할 수 없습니다."
					
				} else if(status === "INVALID_STATUS_ERR") {
					UT.alert("STD.E9400");	// 유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다.
					me.onFindInfo();
					
				} else if(status === "N") {
					UT.alert("STD.E9300");	// 삭제되었거나 존재하지 않는 데이터입니다.
					me.onClose();
					
				} else {
					UT.alert("STD.E9999");
				}
			},
			
			// 발주 삭제
			onDelete: function() {
				var me = this;
				UT.confirm("STD.N1300", function() { // 삭제하시겠습니까?
					UT.request(me.$.deleteInfo);
				});
			},
			
			// 삭제 완료
			completeDelete: function(e, res) {
				var me = this;
				var result = res.response,
					status = result.resultStatus;
				
				if(status === "S") {
					UT.completeAlert(); // 요청을 완료 하였습니다
					me.onClose();
					
				} else if(status === "INVALID_STATUS_ERR") {
					UT.alert("STD.E9400");	// 유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다.
					me.onFindInfo();
					
				} else {
					UT.alert("STD.E9999");
				}
			},
			
			// 품목 삭제
			onDeleteItem: function() {
				var me = this, provider = me.$.gridPanel.getDataProvider();
				var checked = provider.selectionCheckedItems();
				
				if(checked.length === 0) {
					UT.alert("STD.N1600"); // 선택된 항목이 없습니다
				} else {
					UT.confirm("STD.N1300", function() {	// "삭제 하시겠습니까?"
						provider.removeItems(true);	// 그리드에서 체크된 데이터를 지워준다. getRemoveItems에서 지워진 데이터를 가져올 수 있다.
						me.set("poData.has_no_cd_item", (provider.filterItem({item_cd_crn_typ_ccd: "CDLS"}) != null) ? "Y" : "N");
						me.applyFormula("hasNoCdItem");
						
						if(UT.toNumber(me.get("poData.po_revno")) <= 1) {
							var poLno = 0;
							provider.setItemAtBatch(true, function(index, data) {
								poLno += 10;
								return {"po_lno": poLno}
							});
						}
					});
				}
			},
			
			// 변경이력 버튼 클릭
			onShowModHistory: function() {
				var me = this;
				me.showPoModHistoryPopup();
			},
			
			// 변경비교 버튼 클릭
			onShowComparePrev: function() {
				var me = this;
				
				// 이전 차수와의 비교를 위해 현재 내용을 임시저장합니다.<br/>계속 하시겠습니까?
				UT.confirm("STD.PO1081", function() {
					if(me.isValid('draft') === false) {
						return;
					}
					me.set("poData.openedApproval", false);
					me.set("poData.saveAfterClose", false);
					me.set("poData.showComparePopup", true);
					me.set("poData.showCsPopup", false);
					me.onSave(me.$.modifyDraft);
				});
			},
			showPoModHistoryPopup: function(isCompareOnly) {
				var me            = this,
					param         = {"po_no": me.get("poData.po_no")},
					isCompareOnly = UT.isBoolean(isCompareOnly) ? isCompareOnly : false,
					popupTitle    = isCompareOnly ? "계약 변경 비교" : "계약 변경 이력";
				
				if(isCompareOnly) {
					var poRev = UT.toNumber(me.get("poData.po_revno"));
					param.prev_po_revno = poRev - 1;
					param.post_po_revno = poRev;
					param.purc_typ_ccd = me.get("poData.purc_typ_ccd");
					param.compareOnly = isCompareOnly;
				}
				
				var historyPopup = UT.popup("ep-po-mod-history", me, 1000, 600, null, {titleText: popupTitle});
				historyPopup.show();
				historyPopup.getWindowContent().load(param);
			},
			
			// 발주금액
			changedPoTotAmt: function() {
				var me = this, provider = me.$.gridPanel.getDataProvider();
				
				var cur = me.get("poData.cur_ccd");
				
				// 품목의 면세여부를 체크하여 VAT 및 계약 금액(VAT포함)을 계산하도록 함.
				var vatAmt = new BigNumber(0);
				var lists = provider.getItems();
				
				for(var i = 0; i < lists.length; i++) {
					var item = lists[i];
					
					if(item.df_yn !== "Y") {
						var itemAmt = new BigNumber(item.po_amt || 0);
						
						var dp = CCPrecManager.validateInfo('amt', cur).decimalprecision;
						var rm = 1;	// ROUND_DOWN (절사하기로 함 - 2019.07.10)
						var itemVat = itemAmt.mul(new BigNumber(me.get("taxRate"))).toFixed(dp, rm);
						
						vatAmt = vatAmt.plus(new BigNumber(itemVat));
					}
				}
				
				// VAT 금액
				me.set("poData.vat_amt", vatAmt.toFixed());
				
				// 공급가액 = 발주금액
				var supplyAmt = new BigNumber(me.get("poData.po_amt") || 0);
				me.set("poData.sup_amt", supplyAmt.toFixed());
				
				// 계약 금액(VAT포함) = 공급가액 + VAT 금액
				me.set("poData.cntr_amt", supplyAmt.plus(vatAmt).toFixed());
				
				// 지불조건 - 지급율 재계산
				me.calculatePaymentPlanRate();
			},
			/* 계약이행보증기간 on-click 이벤트 */
			changePerforbondYn: function() {
				var me = this;
				me.applyFormula("perforBondEssential");
			},
			/* 선급금보증기간 on-click 이벤트 */
			changePrepaybondYn: function() {
				var me = this;
				me.applyFormula("prePayBondEssential");
			},
			/* 하자보증기간 on-click 이벤트 */
			changeMaintbondYn: function() {
				var me = this;
				me.applyFormula("maintBondEssential");
			},
			// 계약이행 보증금
			changedPerforBondRate: function() {
				var me = this;
				var perforBondYn = me.get("poData.cpgur_use_yn");
				if("Y" === perforBondYn) {
					var perforBondRate = new BigNumber(me.get("poData.cpgur_ro") || 0); // 계약이행 지급율
					// BigNumber 생성 시 15자리 이상의 숫자 타입은 error 발생 -> toString하여 생성
					var cntrAmt = new BigNumber(UT.toString(me.get("poData.cntr_amt") || 0)); // 계약 금액(VAT포함)
					
					// cntrAmt * perforBondRate / 100
					var preforBondAmt = (cntrAmt.isZero() || perforBondRate.isZero()) ? 0 : cntrAmt.mul(perforBondRate).div(new BigNumber(100)).toFixed();
					me.set("poData.cpgur_amt", CCPrecManager.format("amt", preforBondAmt, me.get("poData.cur_ccd")));
				} else {
					me.set("poData.cpgur_ro", 0);
					me.set("poData.cpgur_amt", 0);
					me.set("poData.cpgur_typ_ccd", "");
					me.set("poData.cpgur_st_dt", "");
					me.set("poData.cpgur_exp_dt", "");
				}
				me.applyFormula("perforBondEditable");
			},
			changedPerforBondCls: function() {
				var me = this;
				if(me.get("poData.cpgur_typ_ccd") !== "GUR_INS") {
					if(UT.isNotEmpty(me.$.perforBondRate)){
						me.$.perforBondRate.clearInvalid();
						me.$.perforBondPeriod.clearInvalid();
					}
				}
				me.applyFormula("perforBondRequired");
				me.applyFormula("isRequiredCntrDate");
			},
			
			// 하자이행 보증금
			changedMaintBondRate: function() {
				var me = this;
				var maintBondYn = me.get("poData.defpgur_use_yn");
				if("Y" === maintBondYn) {
					var maintBondRate = new BigNumber(me.get("poData.defpgur_ro") || 0); // 하자이행 지급율
					// BigNumber 생성 시 15자리 이상의 숫자 타입은 error 발생 -> toString하여 생성
					var cntrAmt = new BigNumber(UT.toString(me.get("poData.cntr_amt") || 0)); // 계약 금액(VAT포함)
					
					// cntrAmt * maintBondRate / 100
					var maintBondAmt = (cntrAmt.isZero() || maintBondRate.isZero()) ? 0 : cntrAmt.mul(maintBondRate).div(new BigNumber(100)).toFixed();
					me.set("poData.defpgur_amt", CCPrecManager.format("amt", maintBondAmt, me.get("poData.cur_ccd")));
				} else {
					me.set("poData.defpgur_ro", 0);
					me.set("poData.defpgur_amt", 0);
					me.set("poData.defpgur_typ_ccd", "");
					me.set("poData.defpgur_pd_typ_ccd", "");
					me.set("poData.defpgur_pd", null);
				}
				me.applyFormula("maintBondEditable");
			},
			changedMaintBondCls: function() {
				var me = this;
				if(me.get("poData.defpgur_typ_ccd") !== "GUR_INS") {
					if(UT.isNotEmpty(me.$.maintBondRate)){
						me.$.maintBondRate.clearInvalid();
						me.$.maintBondTyp.clearInvalid();
						me.$.maintBondMon.clearInvalid();
					}
				}
				me.applyFormula("maintBondRequired");
				me.applyFormula("isRequiredCntrDate");
			},
			
			// 선급금이행 보증금
			changedPrePayBondRate: function() {
				var me = this;
				var prePayBondYn = me.get("poData.apymtgur_use_yn");
				if("Y" === prePayBondYn) {
					var prePayBondRate = new BigNumber(me.get("poData.apymtgur_ro") || 0); // 선급금이행 지급율
					
					// BigNumber 생성 시 15자리 이상의 숫자 타입은 error 발생 -> toString하여 생성
					var prePayAmt = new BigNumber(UT.toString(me.get("poData.apymt_amt") || 0)); // 선급금
					
					// cntrAmt * prePayBondRate / 100
					var prePayBondAmt = (prePayAmt.isZero() || prePayBondRate.isZero()) ? 0 : prePayAmt.mul(prePayBondRate).div(new BigNumber(100)).toFixed();
					me.set("poData.apymtgur_amt", CCPrecManager.format("amt", prePayBondAmt, me.get("poData.cur_ccd")));
				} else {
					me.set("poData.apymtgur_ro", 0);
					me.set("poData.apymtgur_amt", 0);
					me.set("poData.apymtgur_typ_ccd", "");
					me.set("poData.apymtgur_st_dt", "");
					me.set("poData.apymtgur_exp_dt", "");
				}
				me.applyFormula("prePayBondEditable");
			},
			changedPrePayBondCls: function() {
				var me = this;
				if(me.get("poData.apymtgur_typ_ccd") !== "GUR_INS") {
					me.$.prePayBondRate.clearInvalid();
					me.$.prePayBondPeriod.clearInvalid();
				}
				me.applyFormula("prePayBondRequired");
				me.applyFormula("isRequiredCntrDate");
			},
			
			// 계약기간 계산
			computeCntrPrdDate: function() {
				var me = this, provider = me.$.gridPanel.getDataProvider();
				
				var max = function(a, b) {
					if(UT.isDate(a) && UT.isDate(b)) {
						return a.getTime() >= b.getTime() ? a : b;
					} else if(UT.isString(a) && UT.isString(b)) {
						return parseInt(a, 10) >= parseInt(b, 10) ? a : b;
					} else {
						return UT.isString(a) ? a : UT.isString(b) ? b : null;
					}
				}
				var min = function(a, b) {
					if(UT.isDate(a) && UT.isDate(b)) {
						return a.getTime() <= b.getTime() ? a : b;
					} else if(UT.isString(a) && UT.isString(b)) {
						return parseInt(a, 10) <= parseInt(b) ? a : b;
					} else {
						return UT.isString(a) ? a : UT.isString(b) ? b : null;
					}
				}
				var sd = null, ed = null;
				var items = provider.getItems(); // 전체 데이터
				for(var i = 0, len = items.length; i < len; i++) {
					sd = min(sd, items[i].const_st_dt);
					ed = max(ed, items[i].const_exp_dt);
				}
				if(UT.isDate(sd)) {
					me.set("poData.cntr_st_dt", UT.formatDate(sd, "yyyyMMdd"));
				} else {
					me.set("poData.cntr_st_dt", sd);
				}
				if(UT.isDate(ed)) {
					me.set("poData.cntr_exp_dt", UT.formatDate(ed, "yyyyMMdd"));
				} else {
					me.set("poData.cntr_exp_dt", ed);
				}
			},
			
			// 닫기
			onClose: function() {
				var me = this;
				me.reset();
				me.fire("close");
			},
			// 세액 convert
			onVatConvert: function(rowIndex, dataField, data) {
				var me = this;
				
				if(data.df_yn === "Y") {
					return 0;
				}
				
				var cur = me.get("poData.cur_ccd");
				var itemAmt = new BigNumber(data["po_amt"] || 0);
				
				// 품목 별 세액 계산
				var dp = CCPrecManager.validateInfo('amt', cur).decimalprecision;
				var rm = 1;	// ROUND_DOWN
				
				return itemAmt.mul(new BigNumber(me.get("taxRate"))).toFixed(dp, rm);
			},
			//합계
			onAmtAggregateFn: function(dataField, datas) {
				var me = this;
				
				if(dataField === "po_amt") {
					var amtSum = new BigNumber('0');
					
					for(var i = 0; i < datas.length; ++i) {
						var data = datas[i];
						amtSum = amtSum.plus(new BigNumber(data[dataField] || 0));
					}
					
					var cur   = me.get("poData.cur_ccd"),
						value = amtSum.toFixed();
					
					// 금액 소수점처리(value)
					me.set("poData.po_amt", CCPrecManager.format("amt", value, cur));
					
					// 발주금액 변경 시
					me.changedPoTotAmt();
					return value;
					
				} else if(dataField === "item_vat") {
					return me.get("poData.vat_amt");
				}
				return null;
			},
			changeStamptaxYn: function() {
				var me = this;
				if(me.poData.stax_yn != "Y") {
					me.set("poData.sttpymt_ro_typ_ccd", null);
				}
				
				if(me.poData.stax_yn != "Y") {
					me.set("poData.estax_yn", "N");
				}
				me.applyFormula();
			},
			onShowCsPopup: function() {
				var me = this;
				if(UT.isEmpty(me.get("poData.po_uuid"))) {
					// 구성원 정보를 조회하기 전에 현재 내용을 임시저장합니다.<br/>계속 하시겠습니까?
					UT.confirm("STD.CS1021", function() {
						if(me.isValid('draft') === false) {
							return;
						}
						me.set("poData.openedApproval", false);
						me.set("poData.saveAfterClose", false);
						me.set("poData.showComparePopup", false);
						me.set("poData.showCsPopup", true);
						me.onSave(me.$.modifyDraft);
					});
				} else {
					me.showCsPopup(me.get("poData.po_uuid"));
				}
			},
			showCsPopup: function(poId) {
				var me = this;
				var popup = UT.popup('ep-po-cs-detail', me, 950, 500, null, {titleText: "구성원 정보"});
				popup.show();
				popup.getWindowContent().load({"po_uuid": poId, "readonly": !me.formula("editable")});
			},
			// 금액 정렬
			onSortCompareFn: UT.sortBigNumber,
			onViewCntr: function() {
				var me = this;
				var data = {
					cntr_uuid: me.get("poData.cntr_uuid")
				};
				me.$.findElecContract.body = data;
				UT.request(me.$.findElecContract, function(e, res) {
					var result = res.response;
					
					if(result.tmpl_use_yn === "Y") {
						me.popupElecStdPaper(result);
					} else if(result.tmpl_use_yn === "N") {
						me.popupElecNonStdPaper(result);
					}
				});
			},
			
			popupElecStdPaper: function(data) {
				var me = this;
				var cntrManagerPopup = UT.popup("es-cntrmanager", me, "85%", "75%", {
					"close-remove": function(popup, e) {
						popup.close();
						me.onFindInfo();
					}
				}, {titleText: "계약서"});
				data.isPopup = true;
				cntrManagerPopup.show();
				cntrManagerPopup.getWindowContent().load(data);
			},
			
			popupElecNonStdPaper: function(data) {
				var me = this;
				var cntrNonManagerPopup = UT.popup("ep-non-standard-cntrmanager", me, "85%", "75%", {
					"close-remove": function(popup, e) {
						popup.close();
						me.onFindInfo();
					}
				}, {titleText: "계약서", alwaysNew: true});
				data.isPopup = true;
				cntrNonManagerPopup.show();
				cntrNonManagerPopup.getWindowContent().load(data);
			},
			
			procAfterSave: function(poId) {
				var me = this;
				
				if(me.get("poData.openedApproval") === true) { // 결재요청일 경우
					me.onFindInfo();	//데이터 저장 후 재조회
					me.set("poData.openedApproval", false);
					
					var aprvTypcd = "PO_CHG";
					
					// 결재팝업 호출 (PO_CHG: 계약및발주변경품의)
					UT.popupApproval(me, {
								task_uuid: poId, apvl_typ_ccd: aprvTypcd, apvl_tit: me.get("poData.po_tit"),
								appData: me.get("poData"),
								appAmt: me.get("poData.po_amt")
							},
							// savedCallback (결재 팝업에서 이벤트 처리후 실행되는 callback 함수 내용을 정의한다.)
							function(aprvSts) {
								if(aprvSts === "PRGSG") {	// 결재상신 시
									me.onClose();
								} else {					// 결재 임시저장 시
									me.onFindInfo();
								}
							});
				} else if(me.get("poData.showComparePopup") === true) {
					me.onFindInfo();	// 데이터 저장 후 재조회
					me.set("poData.showComparePopup", false);
					
					me.showPoModHistoryPopup(true);
					
				} else if(me.get("poData.showCsPopup") === true) {
					me.onFindInfo();
					me.set("poData.showCsPopup", false);
					
					me.showCsPopup(poId);
					
				} else if(me.get("poData.bypassApproval") === true) { // 발주요청일 경우
					me.set("poData.bypassApproval", false);
					
					UT.completeAlert();
					me.onClose();
				} else if(me.get("poData.showPoEvalSet") === true) {
					me.set("poData.showPoEvalSet", false);
					me.showPoEval(poId);
				} else {
					UT.completeAlert();
					
					if(me.get("poData.saveAfterClose") === true) {
						me.onClose();
					} else {
						me.onFindInfo();
					}
				}
			},
			
			onChangeTaxCd: function(e) {
				this.setTaxRate(e.detail.selectedItem);
				this.changePoItemTaxRate();
			},
			
			setTaxRate: function(taxCodeInfo) {
				var taxRate = new BigNumber(0);
				
				if(UT.isNotEmpty(taxCodeInfo)) {
					taxRate = (new BigNumber(taxCodeInfo.cstr_cnd_val).div(100));
				}
				
				if(taxRate.comparedTo(new BigNumber(this.get("taxRate")))) {
					//과세율이 다를 경우 변경
					this.set("taxRate", taxRate.toNumber());
				}
				
			},
			
			changePoItemTaxRate: function() {
				var provider = this.$.gridPanel.getDataProvider();
				provider.setItemAtBatch(true, function(nodeIndex, data) {
					if(data["df_yn"] !== "Y") {
						return {tax_rate: this.get("taxRate")};
					}
				});
			},
			completeFindListCommonCodeAttributeCode: function(e, res){
				var me = this;
				me.codes.cntrSgngTypCcd = me.codes.cntrSgngTypCcd.filter((code) => code.cstr_cnd_val === "Y");
				me.$.cntrSgngTypCcdCombo.items = me.codes.cntrSgngTypCcd;
			},
			onChangeCntrSgngTypCcdCombo: function(){
				var me = this;
				var poData = me.get("poData");
				me.$.cntrSgngTypCcdCombo.items = me.get("codes.cntrSgngTypCcd");
			},
			onPoEvalSet: function() {
				var me            = this,
					poUuid        = me.get("poData.po_uuid"),
					poStsCcd = me.get("poData.po_sts_ccd");
				if(UT.isEmpty(poUuid) && (me.formula("editable") && poStsCcd === "WTG" || poStsCcd === "CRNG" || UT.isEmpty(poStsCcd))) {
					var purcTypCcd = me.get("poData.purc_typ_ccd");
					UT.alert(me.translate("STD.PO1072", null, purcTypCcd === "QTY" ? me.translate("입고") : me.translate("기성")), function() { // {0}평가 설정은 임시저장 이후 설정가능합니다.
						me.set("poData.showPoEvalSet", true);
						me.onModifyDraft();
					});
				} else {
					me.showPoEval(poUuid);
				}
			},
			showPoEval: function(poUuid) {
				var me = this;
				me.fire("show-po-gr-eval-detail", {
					'po_uuid': poUuid,
					'closeView': "PO_MOD",
					'isView': true
				});
			},
			onImagePlantSelectShowFunction : function(data, item) {
				if(UT.isNotEmpty(data["item_cd_crn_typ_ccd"]) && data["item_cd_crn_typ_ccd"] === 'CDLS'){ // 무품목코드 일 경우만 표기
					return "search";
				}
				return "";
			},
		});
	</script>

</dom-module>