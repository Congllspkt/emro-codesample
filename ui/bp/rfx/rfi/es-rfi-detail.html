<sc-link rel="import" href="../../shared/ep-vendor-list.html"></sc-link>
<sc-link rel="import" href="../shared/ep-item-detail-spec.html"></sc-link>
<sc-link rel="import" href="../shared/ep-item-perform.html"></sc-link>

<dom-module id="es-rfi-detail">
	<style>
		:host {
			@apply(--vbox-layout);
		}
	</style>

	<template>
		<!-- 조회 -->
		<sc-ajax id="findRfi"
				 url="findRfi.do"
				 body="{{searchParam}}">
		</sc-ajax>
		
		<sc-ajax id="findRfiDefaultDataByReqItemIds"
				 url="findRfiDefaultDataByReqItemIds.do">
		</sc-ajax>
		
		<sc-ajax id="checkPrStatus"
				 url="checkPrStatus.do">
		</sc-ajax>
		
		<!-- 저장 -->
		<sc-ajax id="tempSaveRfi"
				 url="temporarySaveRfi.do">
		</sc-ajax>

		<!-- 요청 -->
		<sc-ajax id="requestRfi"
				 url="requestRfi.do">
		</sc-ajax>

		<!-- 삭제 -->
		<sc-ajax id="deleteRfi"
				 url="deleteRfi.do"
				 body="{{rfiData}}">
		</sc-ajax>

		<!-- 코드 조회 -->
		<sc-code-group>
			<!-- UOM -->
			<sc-code code="C007" value="{{codes.uomCcd}}"></sc-code>
		</sc-code-group>

		<cc-auth-checker check-list="auth-s, auth-r"></cc-auth-checker>

		<cc-page-title-bar title-text="{{formula('title')}}" i18n-disabled>
			<sc-button text="RFQ 작성" on-click="onShowCreate" hidden="[[!formula('createRfx')]]" data-args="RFQ" auth-s></sc-button>
			<sc-button text="RFP 작성" on-click="onShowCreate" hidden="[[!formula('createRfx')]]" data-args="RFP" auth-s></sc-button>
			<sc-button text="역경매" on-click="onShowCreate" hidden="[[!formula('createRfx')]]" data-args="RAUC" auth-s></sc-button>
			<sc-button text="RFX 정보" on-click="onShowRfxDetail" hidden="[[!formula('checkRfxTypCcd')]]" data-args="RA" auth-s></sc-button>
			<sc-button text="저장" on-click="onSaveRfi" hidden="[[!formula('editable')]]" data-args="tempSave" auth-s></sc-button>
			<sc-button text="요청" on-click="onSaveRfi" hidden="[[!formula('editable')]]" data-args="request" auth-s></sc-button>
			<sc-button text="삭제" on-click="onDelete" hidden="[[!formula('deletable')]]" auth-s></sc-button>
			<sc-button text="닫기" on-click="onClose"></sc-button>
		</cc-page-title-bar>

		<div class="flex page">
			<cc-form-panel title-text="일반 정보" collapsible="true" validation-group="rfiInfo">
				<cc-fieldset>
					<sc-label text="운영조직"></sc-label>
					<cc-operorg-combobox-field id="operorgcombobox" oper-unit-cd="PO"
											   value="{{rfiData.oorg_cd}}" selected-index="0" placeholder="필수"
											   required="true" disabled="[[!formula('creatable')]]"
											   on-change="onChangeOperOrgCd"></cc-operorg-combobox-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="RFI 번호"></sc-label>
					<sc-text-field value="{{rfiData.rfi_no}}" readonly></sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="제목"></sc-label>
					<sc-text-field required="true" value="{{rfiData.rfi_tit}}"
								   readonly="[[!formula('editable')]]" max-length="100">
					</sc-text-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="마감 일시"></sc-label>
					<div class="field-box">
						<sc-date-field default-value="7d"
									   required="true"
									   string-date="false"
									   value="{{rfiData.rfi_clsg_dttm}}"
									   readonly="[[!formula('editable')]]"
									   validator="rfiCloseDtValidator"
									   validation-group="rfiCloseDt">
						</sc-date-field>
						<span style="margin-right:5px"></span>
						<sc-number-field class="w-60" min-value="0" max-value="23" max-length="2"
										 input-cover="true" format-type="disp_time"
										 value="{{rfiData.rfi_clsg_dttm_hour}}"
										 regex="/^([0-1]?[0-9]|2[0-3])$/"
										 readonly="[[!formula('editable')]]"
										 validator="rfiCloseDtValidator"
										 validation-group="rfiCloseDt">
						</sc-number-field>
						<span style="margin-right: 2px;">:</span>
						<sc-number-field class="w-60" min-value="0" max-value="59" max-length="2"
										 input-cover="true" format-type="disp_time"
										 value="{{rfiData.rfi_clsg_dttm_min}}"
										 regex="/^[0-5]?[0-9]$/"
										 readonly="[[!formula('editable')]]"
										 validator="rfiCloseDtValidator"
										 validation-group="rfiCloseDt">
						</sc-number-field>
					</div>
				</cc-fieldset>
			</cc-form-panel>

			<cc-form-panel form-cls="label-column" title-text="첨부파일" collapsible="true">
				<cc-fieldset>
					<sc-label text="내부용"></sc-label>
					<sc-upload id="upload_in" class="h-200" value="{{rfiData.buyer_athg_uuid}}" editable="[[formula('editable')]]"></sc-upload>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="협력사용"></sc-label>
					<sc-upload id="upload_out" class="h-200" value="{{rfiData.vd_athg_uuid}}" editable="[[formula('editable')]]"></sc-upload>
				</cc-fieldset>
			</cc-form-panel>

			<cc-form-panel title-text="비고" collapsible="true">
				<cc-fieldset>
					<sc-label text="구매사 비고"></sc-label>
					<sc-textarea-field class="h-150" value="{{rfiData.buyer_rfi_rmk}}" max-length="1000" readonly="[[!formula('editable')]]"></sc-textarea-field>
				</cc-fieldset>
				<cc-fieldset>
					<sc-label text="협력사 비고"></sc-label>
					<sc-textarea-field class="h-150" value="{{rfiData.vd_rfi_rmk}}" max-length="1000" readonly="[[!formula('editable')]]"></sc-textarea-field>
				</cc-fieldset>
			</cc-form-panel>
			
		    <sc-grid id="itemGridPanel" class="h-400" collapsible="true" use-dummy="false"
					 editable="[[formula('editable')]]"
					 use-state="[[formula('editable')]]"
					 use-selection="[[formula('editable')]]"
					 on-item-edit-end="onItemEditEnd"
					 on-item-click="onItemClick">
				<cc-grid-toolbar title-text="품목 정보">
					<sc-button text="무코드 품목 추가"		on-click="onAddNoCdItem"	hidden="[[!formula('noCdItemAddable')]]"	auth-s></sc-button>
					<sc-button text="품목 추가"			on-click="onShowItemPopup"	hidden="[[!formula('itemAddable')]]"	auth-s></sc-button>
					<sc-button text="삭제"				on-click="onDeleteItem"		hidden="[[!formula('itemDeletable')]]"	auth-s></sc-button>
				</cc-grid-toolbar>
				<sc-grid-columns>
					<sc-data-column		data-field="rfi_lno"		header-text="항번"			width="60"	text-align="center"	editable="false"	data-type="number"	></sc-data-column>
					<sc-data-column		data-field="disp_item_cd"	header-text="품목 코드"		width="100"	text-align="center"	editable="false"	></sc-data-column>
					<sc-group-column	hide-child-headers="true"	header-text="품목 명"		width="280">
						<sc-data-column		data-field="item_nm"		width="250"	text-align="left"	editable="false" item-editable-function="onItemEditableFn"		max-length="500"	required="true"></sc-data-column>
						<sc-image-column	data-field="img_item_cd"	image-change-function="onImageChangeFn"	width="30"	text-align="center" editable="false"></sc-image-column>
					</sc-group-column>
					<sc-data-column		data-field="item_spec"			header-text="품목 규격"			width="250"	text-align="left"	editable="false"	item-editable-function="onItemEditableFn"	max-length="1000"
										item-style-function="onItemStyleFn"		validator-function="gridValidatorFn"></sc-data-column>
					<sc-image-column	data-field="img_item_spec_dtl"	header-text="품목 규격 상세"		width="60"	text-align="center"	visible="[[formula('hasNoCdItem')]]"
										image-change-function="onImageChangeFn"></sc-image-column>
					<sc-combobox-column	data-field="uom_ccd"		header-text="UOM"			width="60"	text-align="center"	editable="[[!formula('hasPrAndUpcrItem')]]"		required="true"
										display-field="data"		value-field="data"			items="{{codes.uomCcd}}"	></sc-combobox-column>
					<sc-data-column		data-field="rfi_qty"		header-text="수량"			width="80"	text-align="right"	editable="[[!formula('hasPrAndUpcrItem')]]"		required="true"
										data-type="number"			format-type="qty"			validator-function="gridValidatorFn"
										max-length="8"				editor-regex-function="onRegexFn" 	validate-on-cell-paste="true"></sc-data-column>
					<sc-group-column	hide-child-headers="true"	header-text="플랜트"			width="180"	text-align="center"	editable="false">
						<sc-data-column		data-field="plt_cd"				width="70"	text-align="center"	editable="false"></sc-data-column>
						<sc-data-column		data-field="plt_nm"				width="70"	text-align="center"	editable="false"></sc-data-column>
						<sc-image-column	image-cls="search" data-field="img_plant_select"		width="30"	text-align="center"
											editable="false"  visible="[[formula('noCdItemPlantAddable')]]" image-change-function="onImagePlantSelectShowFunction"></sc-image-column>
					</sc-group-column>
					<sc-data-column		data-field="pr_no"			header-text="구매요청 번호"	width="120"	text-align="center"	editable="false"	visible="[[formula('hasPrItem')]]"	></sc-data-column>
					<sc-data-column		data-field="pr_lno"			header-text="구매요청 항번"	width="120"	text-align="center"	editable="false"	visible="[[formula('hasPrItem')]]"	data-type="number"	></sc-data-column>
					<sc-data-column		data-field="upcr_no"			header-text="단가계약요청 번호"	width="120"	text-align="center"	editable="false"	visible="[[formula('hasUpcrItem')]]"	></sc-data-column>
					<sc-data-column		data-field="upcr_lno"			header-text="단가계약요청 항번"	width="120"	text-align="center"	editable="false"	visible="[[formula('hasUpcrItem')]]"	data-type="number"	></sc-data-column>
				</sc-grid-columns>
				<sc-grid-fields>
					<sc-grid-field	data-field="rfi_item_uuid"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="rfi_uuid"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="oorg_cd"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="pr_item_uuid"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="pr_no"				data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="pr_lno"				data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="upcr_item_uuid"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="upcr_no"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="upcr_lno"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="sg_cd"				data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="item_cd"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="item_cd_crn_typ_ccd"	data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="item_spec_dtl"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="rfx_req_rcpt_uuid"></sc-grid-field>
				</sc-grid-fields>
			</sc-grid>
			
			<sc-grid id="vdGridPanel" class="h-400" collapsible="true" use-dummy="false"
					 editable="[[formula('editable')]]"
					 use-state="[[formula('editable')]]"
					 use-selection="[[formula('editable')]]">
				<cc-grid-toolbar title-text="협력사 정보">
					<sc-button text="협력사 검색"	on-click="onShowVendorPopup"	hidden="[[!formula('editable')]]"	auth-s></sc-button>
					<sc-button text="삭제"			on-click="onDeleteVendor"		hidden="[[!formula('editable')]]"	auth-s></sc-button>
				</cc-grid-toolbar>
				<sc-grid-columns>
					<sc-data-column		data-field="vd_cd"				header-text="협력사 코드"			width="100"	text-align="center"	editable="false"></sc-data-column>
					<sc-data-column		data-field="vd_nm"				header-text="협력사 명"				width="200"	text-align="left"	editable="false"></sc-data-column>
					<sc-data-column		data-field="vd_pic_nm"			header-text="협력사 담당자 명"			width="120"	text-align="center"	editable="false"></sc-data-column>
					<sc-data-column		data-field="vd_pic_tel"			header-text="협력사 담당자 전화"	width="150"	text-align="left"	editable="true"	max-length="18"></sc-data-column>
					<sc-data-column		data-field="vd_pic_eml"			header-text="협력사 담당자 이메일"		width="150"	text-align="left"	editable="true"	max-length="100"></sc-data-column>
				</sc-grid-columns>
				<sc-grid-fields>
					<sc-grid-field	data-field="rfi_uuid"			data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="rfi_no"				data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="rfi_vd_uuid"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="vd_pic_uuid"		data-type="text"></sc-grid-field>
					<sc-grid-field	data-field="rfx_uuid"			data-type="text"></sc-grid-field>
				</sc-grid-fields>
			</sc-grid>
       	</div>
	</template>

	<script>
		Polymer({
			is: 'es-rfi-detail',
			properties: {
				searchParam: {
					type: Object,
					value: function() {
						return {
							rfi_uuid: ""
						}
					}
				},
				rfiData: {
					type: Object,
					value: function() {
						return {
							rfi_uuid: "",
							rfi_sts_ccd: "CRNG",
							has_pr_item_yn: "N",
							has_upcr_item_yn: "N"
						}
					}
				},
				codes: {
					type: Object,
					value: function() {
						return {
							uomCcd: [],
							param: {
								purc_grp_typ_ccd: "PURC",
								co_cd: SCSessionManager.currentUser.co_cd
							}
						}
					},
					reset: false
				}
			},
			formulas: {
				editable: function() {
					return (this.rfiData.rfi_sts_ccd === "CRNG");
				},
				creatable: function() {
					return (UT.isEmpty(this.rfiData.rfi_uuid) && (this.rfiData.has_pr_item_yn === "N") && (this.rfiData.has_upcr_item_yn === "N"));
				},
				deletable: function() {
					return (UT.isNotEmpty(this.rfiData.rfi_uuid) && this.formula("editable"));
				},
				createRfx: function() {
					return (this.rfiData.rfi_sts_ccd === "ED" && this.rfiData.rfx_typ_ccd === null && (this.rfiData.has_pr_item_yn === "Y" || this.rfiData.has_upcr_item_yn === "Y"));
				},
				hasPrItem: function() {
					return (this.rfiData.has_pr_item_yn === "Y");
				},
				hasUpcrItem: function() {
					return (this.rfiData.has_upcr_item_yn === "Y");
				},
				hasPrAndUpcrItem: function() {
					return this.formula("hasPrItem") || this.formula("hasUpcrItem");
				},
				itemAddable: function() {
					return !(this.formula("hasPrItem") || this.formula("hasUpcrItem")) && this.formula("editable");
				},
				itemDeletable: function() {
					return this.formula("editable");
				},
				// 무코드품목 추가 가능여부
				noCdItemAddable: function() {
					var me = this;

					return me.formula("itemAddable");
				},
				hasNoCdItem: function() {
					var me = this;

					return me.get("rfiData.has_no_cd_item") === "Y";
				},
				noCdItemPlantAddable: function() {
					var me = this;
					return me.formula("editable") && me.formula("hasNoCdItem");
				},
				title: function() {
					var me = this;

					if(UT.isEmpty(me.get("rfiData.rfi_no"))) {
						return me.translate("RFI 작성");
					}
					return "RFI" + " : " + me.get("rfiData.rfi_no");
				},
				checkRfxTypCcd: function() {
					var me = this;
					
					return (UT.isNotEmpty(me.get("rfiData.rfx_typ_ccd")));
				},
				dupLnos: {
					type: Array,
					value: function() {
						return []
					}
				}
			},
			initialized: function() {

			},
			load: function(param) {
				var me = this;

				me.set("loadCompleted", false);

				if(UT.isNotEmpty(param.rfi_uuid)) {
					me.findRfiDetail(param.rfi_uuid);
				} else if(UT.isNotEmpty(param.rfx_req_rcpt_uuids) && UT.isArray(param.rfx_req_rcpt_uuids)) {
					me.findDefaultDataByReqItems(param.rfx_req_rcpt_uuids);
				} else {	// RFI 현황에서 신규 작성
					me.set("rfiData.has_pr_item_yn", "N");
					me.set("rfiData.has_upcr_item_yn", "N");

					me.applyFormula();
					me.set('loadCompleted', true);
				}
			},
			findRfiDetail: function(rfiId) {
				var me = this;

				me.set("searchParam.rfi_uuid", rfiId);
				UT.request(me.$.findRfi, function(e, res) {
					var result = res.response;
					me.set("rfiData", UT.convertDtToDayHourMin(result.rfiData));

					me.$.itemGridPanel.setDataProvider(result.rfiItems);
					me.$.vdGridPanel.setDataProvider(result.rfiVendors);

					me.applyFormula();
					me.set('loadCompleted', true);
				});
			},
			// 요청 품목으로 일반 정보 설정
			findDefaultDataByReqItems: function(rfxReqRcptUuids) {
				var me = this;
				
				me.$.findRfiDefaultDataByReqItemIds.body = {
					rfx_req_rcpt_uuids: rfxReqRcptUuids
				};
				UT.request(me.$.findRfiDefaultDataByReqItemIds, function(e, res) {
					var result = res.response;
					me.set("rfiData", UT.convertDtToDayHourMin(result.rfiData));
					
					var rfiItems = result.rfiItems, itemSize = rfiItems.length;
					var rfiTitle = itemSize > 0 ? rfiItems[0].item_nm : "";
					if(itemSize > 1) {
						rfiTitle = me.translate("STD.N3100", null, rfiTitle, itemSize - 1);
					}
					me.set("rfiData.rfi_tit", rfiTitle);
					me.$.itemGridPanel.getDataProvider().addItems(rfiItems);
					
					me.applyFormula();
					me.set('loadCompleted', true);
				});
			},
			//운영조직 변경 시 호출
			onChangeOperOrgCd: function(e) {
				var me = this;
				if(!e.isTrusted) {
					if(me.formula('creatable') && me.get('loadCompleted')) {
						var itemProvider = me.$.itemGridPanel.getDataProvider();
						var vdProvider = me.$.vdGridPanel.getDataProvider();

						if(UT.isNotEmpty(itemProvider) && UT.isNotEmpty(vdProvider) && (itemProvider.getItemSize() + vdProvider.getItemSize() > 0)) {
							UT.alert("STD.RFX1033");	//"운영조직 변경시 품목 및 협력사 목록 정보가 초기화 됩니다."

							itemProvider.removeAll();
							vdProvider.removeAll();
							/*
							 * removeAll(collectionRemoveItems=default:true)
							 * -> removeItems에 담아두고 getRemoveItems()를 사용하여 DB에서 삭제할 데이터를 반환
							 */
						}
					}
				}
			},
			// grid column editor-regex-function
			onRegexFn: function(data, item) {
				var me = this;

				// 수량
				if(item.dataField === "rfi_qty") {
					return CCPrecManager.regex("qty", data["uom_ccd"]);
				}
				return null;
			},
			// grid validator-function
			gridValidatorFn: function(headerText, dataField, data) {
				var me    = this,
					value = data[dataField];

				if(dataField === "rfi_qty") {
					if((new BigNumber(value || 0)).isZero()) {
						return me.translate("STD.E1008", null, me.translate(headerText), 0);	// '{0}'은(는) '{1}'보다 큰값을 입력해야 합니다.
					}

					// UOM 존재 시 단위별 수량 포맷유형, UOM 미존재 시 기본 수량 포맷유형
					var unitCd = data["uom_ccd"];

					if(!CCPrecManager.validate("qty", value, unitCd)) {
						return me.translate("STD.E1021", null, CCPrecManager.validateInfo("qty", unitCd).decimalprecision);	// 이 필드는 소수점 '{0}' 자리까지 입력 가능합니다.
					}
				} else if(dataField === "item_spec") {
					// 구매품목유형: 미등록(무코드) 인 경우 품목 규격 필수 입력
					if(data["item_cd_crn_typ_ccd"] === "CDLS" && UT.isEmpty(value)) {
						// '{0}'은(는) 필수 입력 항목입니다.
						return me.translate("STD.E1001", null, me.translate(headerText));
					}
				}
				return true;
			},
			// grid item edit end 이벤트
			onItemEditEnd: function(event) {
				var me       = this,
					e        = event.detail,
					data     = e.data,
					item     = e.item,
					newValue = e.newValue,
					oldValue = e.oldValue,
					provider = e.provider;

				if(item.dataField === "uom_ccd") {
					var qty = CCPrecManager.format("qty", data["rfi_qty"] || 0, newValue);

					provider.setItemAt(item.rowIndex, {"rfi_qty": qty});
				}
			},
			onItemClick: function(event) {
				var me = this;
				var data     = event.detail.data,
					item     = event.detail.item,
					provider = event.detail.provider;

				if(item.dataField === "img_item_spec_dtl" && data["item_cd_crn_typ_ccd"] === "CDLS") {	// 품목 규격 상세(미등록 품목인 경우)
					//현재 row 인덱스를 담아둔다.
					me.rowIndex = item.rowIndex;

					me.showDetailSpec(data, provider);
				} else if(item.dataField === "img_item_cd" && data["item_cd_crn_typ_ccd"] === "ITEM_CD") {
					me.showItemContractHistory(data["item_cd"]);
				} else if(item.dataField === 'img_plant_select' && (UT.isNotEmpty(data["item_cd_crn_typ_ccd"]) && data["item_cd_crn_typ_ccd"] === 'CDLS')){
					// 팝업 호출
					UT.popupOperOrgLinkSearch(me,me.rfiData.oorg_cd,'POIO',function(selectedItems) {
						provider.setItemAt(item.rowIndex, {
							"plt_cd": selectedItems[0].org_cd,
							"item_oorg_cd": selectedItems[0].oorg_cd,
							"plt_nm": selectedItems[0].logic_org_nm
						});
					});
				}
			},
			getNewItemLno: function(provider) {
				var me = this;

				var maxNo = 10;
				if(provider.getItemSize() > 0) {
					var allRows = provider.getItems();

					var maxRow = allRows.reduce(function(a, b) {
						if(!a.rfi_lno)
							a.rfi_lno = 0;
						if(!b.rfi_lno)
							b.rfi_lno = 0;
						return (a.rfi_lno > b.rfi_lno) ? a : b;
					});
					maxNo = parseInt(maxRow.rfi_lno, 10) + 10;
				}
				return maxNo;
			},
			// 무코드품목추가 버튼 클릭 시
			onAddNoCdItem: function() {
				var me = this;

				var rfiData = me.get("rfiData");
				var provider = me.$.itemGridPanel.getDataProvider();
				var rfiLno = me.getNewItemLno(provider);
				var defaultUnit = me.codes.uomCcd.length > 0 ? me.codes.uomCcd[0].data : null;

				var addRow = {
					rfi_lno: rfiLno,					//항번
					oorg_cd: rfiData.oorg_cd,	//운영조직
					uom_ccd: defaultUnit,			//UOM
					rfi_qty: 1,						//수량
					item_cd_crn_typ_ccd: 'CDLS'						//구매품목유형: 미등록(무코드)
				};
				provider.addItem(addRow);
				me.set("rfiData.has_no_cd_item", "Y");
				me.applyFormula("hasNoCdItem");
				me.applyFormula("noCdItemPlantAddable");
			},
			// 품목 추가 버튼 click
			onShowItemPopup: function() {
				var me = this;

				if(UT.isEmpty(me.get("rfiData.oorg_cd"))) {
					UT.alert("STD.N3400"); //'운영조직 선택하세요.'
					return;
				}

				var param = {
					oorg_cd: me.get("rfiData.oorg_cd"),
					purc_grp_typ_ccd: "PURC"
				};

				// 팝업 재사용
				UT.popupItemSearch(me, param, function(selectedItems) {
					// 품목정보 리스트 추가
					me.onAddItemList(selectedItems);
				});
			},
			// 품목정보 리스트 추가
			onAddItemList: function(selectedList) {
				var me = this;

				if(selectedList.length > 0) {
					var rfiData = me.get("rfiData");
					var provider = me.$.itemGridPanel.getDataProvider();
					var rfiLno = me.getNewItemLno(provider);

					for(var i = 0; i < selectedList.length; i++) {
						var selected = selectedList[i];
						var addRow = {
							rfi_lno: rfiLno,					//항번
							oorg_cd: rfiData.oorg_cd,	//운영조직
							plt_cd 		: selected.org_cd,
							item_oorg_cd	: selected.oorg_cd,
							plt_nm 		: selected.logic_org_nm,
							disp_item_cd: selected.item_cd,
							item_cd: selected.item_cd,		//품목 코드
							item_nm: selected.item_nm,		//품목 코드
							item_spec: selected.item_spec,			//품목 규격
							uom_ccd: selected.bas_uom_ccd,	//UOM (기본단위)
							sg_cd: selected.sg_cd,			//소싱그룹코드
							rfi_qty: 1,
							item_cd_crn_typ_ccd: 'ITEM_CD'						//구매품목유형: 등록
							//	purc_grp_cd  : selected.purc_grp_cd,	//구매그룹코드
							//	purc_grp_nm  : selected.purc_grp_nm,	//구매그룹명
							//	cur_ccd          : selected.cur_ccd
						};
						provider.addItem(addRow);
						rfiLno += 10;
					}
				} else {
					UT.alert("STD.N1600"); // 선택된 항목이 없습니다
				}
			},
			// 품목 삭제 버튼 click
			onDeleteItem: function() {
				var me = this;

				var provider = me.$.itemGridPanel.getDataProvider();
				var checked = provider.selectionCheckedItems();

				if(checked.length === 0) {
					UT.alert("STD.N1600"); // 선택된 항목이 없습니다
				} else {
					UT.confirm("STD.N1300", function() {	// "삭제 하시겠습니까?"
						provider.removeItems(true);	// 그리드에서 체크된 데이터를 지워준다. getRemoveItems에서 지워진 데이터를 가져올 수 있다.
						me.set("rfiData.has_no_cd_item", (provider.filterItem({item_cd_crn_typ_ccd: "CDLS"}) != null) ? "Y" : "N");
						me.applyFormula("hasNoCdItem");
					});
				}
			},
			// 협력사 추가 버튼 click
			onShowVendorPopup: function() {
				var me = this;

				if(UT.isEmpty(me.get("rfiData.oorg_cd"))) {
					UT.alert("STD.N3400"); //'운영조직 선택하세요.'
					return;
				}

				var itemProvider = me.$.itemGridPanel.getDataProvider(),
					itemRows     = itemProvider.getItems();
				var itemSGUniqueList = itemRows.reduce(function(a, b) {
					if(!UT.isEmpty(b.sg_cd) && a.indexOf(b.sg_cd) < 0) {
						a.push(b.sg_cd);
					}
					return a;
				}, []);

				var defaultParam = {
					co_cd: me.codes.param.co_cd,
					oorg_cd: me.rfiData.oorg_cd,
					conn_typ_ccd: "POEO",
					task_typ_ccd: "RX",	//RFX 담당자 정보 조회,
					item_sgs: itemSGUniqueList,
					obd_job_type_code : "RFI_TARGET" // 온보딩 유형
				};

				var vendorPopup = UT.popup("ep-vendor-list", me, "65%", "95%", {
					'selected-items': function(popup, e) {
						var selectedList = e.detail;

						me.addVdList(selectedList);
					}
				}, {maximizable: true, titleText: "협력사 검색"});
				vendorPopup.show();
				vendorPopup.getWindowContent().load({'defaultParam': defaultParam});
			},
			// 협력사 리스트 추가
			addVdList: function(selectedList) {
				var me = this;

				var provider = me.$.vdGridPanel.getDataProvider();

				var dupCnt = 0;
				if(selectedList.length > 0) {
					for(var i = 0; i < selectedList.length; i++) {
						var selected = selectedList[i];

						if(provider.filterItem({vd_cd: selected.vd_cd}) === null) {
							var addRow = {
								vd_cd: selected.vd_cd,
								erp_vd_cd: selected.erp_vd_cd,
								disp_vd_cd: selected.disp_vd_cd,
								vd_nm: selected.disp_vd_nm,
								vd_pic_uuid: selected.chr_id,
								vd_pic_nm: selected.chr_nm,
								vd_chr_mobile: selected.mob,
								vd_pic_eml: selected.eml,
								vd_pic_tel: selected.tel
							};
							provider.addItem(addRow);
						} else {
							dupCnt++;
						}
					}

					if(dupCnt > 0) {
						UT.alert(me.translate("STD.N2010", null, dupCnt), null, true); // "중복 데이터 {0}건 제외 후 추가하였습니다."
					}
				} else {
					UT.alert("STD.N1600"); // "선택된 항목이 없습니다."
				}
			},
			// 협력사 삭제 버튼 click
			onDeleteVendor: function() {
				var me = this;
				var provider = me.$.vdGridPanel.getDataProvider();
				var checked = provider.selectionCheckedItems();

				if(checked.length === 0) {
					UT.alert("STD.N1600"); // 선택된 항목이 없습니다
				} else {
					UT.confirm("STD.N1300", function() {	// "삭제 하시겠습니까?"
						provider.removeItems(true);	// 그리드에서 체크된 데이터를 지워준다. getRemoveItems에서 지워진 데이터를 가져올 수 있다.
					});
				}
			},
			isValid: function(saveType) {
				var me = this;

				me.set("rfiData", UT.convertDayHourMinToDt(me.rfiData));

				if(!me.validate("rfiInfo")) {
					UT.alert("STD.E0000");
					return false;
				}

				// PR 없이 생성한 경우, 품목 중복체크
				if(!me.formula("hasPrItem") && me.hasDupItems()) {
					// 중복된 '{0}'(이)가 존재합니다.
					var msg = me.translate("STD.E1042", null, me.translate("품목 정보"))
							+ "<br/>[" + me.translate("항번") + "] " + me.dupLnos.toString();
					UT.alert(msg, null, true);
					return false;
				}

				if(saveType !== "tempSave") {
					var itemProvider = me.$.itemGridPanel.getDataProvider();
					if(itemProvider.getItemSize() < 1) {
						UT.alert("STD.PR1002");	//"품목 정보가 없습니다."
						return false;
					}

					var vdProvider = me.$.vdGridPanel.getDataProvider();
					if(vdProvider.getItemSize() < 1) {
						UT.alert("STD.RFX1019");	//"업체를 한개이상 선택하세요."
						return false;
					}
				}

				//그리드 validator 함수 호출
				if(!me.$.itemGridPanel.validate() || !me.$.vdGridPanel.validate()) {
					UT.alert("STD.E0000");
					return false;
				}

				return true;
			},
			// RFI 마감 일시 validator
			rfiCloseDtValidator: function() {
				var me = this;

				var rfiCloseTime = UT.toTime(me.rfiData.rfi_clsg_dttm);
				var nowDate = new Date();
				// RFI 마감 일시 > 현재일시
				if(rfiCloseTime === null || rfiCloseTime <= nowDate.getTime()) {
					return me.translate("STD.E1013", null, me.translate("RFI 마감 일시"), me.translate("현재 일시"));
				}
				return true;
			},
			// 품목 중복체크
			hasDupItems: function() {
				var me           = this,
					itemProvider = me.$.itemGridPanel.getDataProvider(),
					items        = itemProvider.getItems(),
					len          = items.length;
				if(len > 1) {
					// 중복체크 대상 컬럼
					var cols = ["item_nm", "item_spec", "uom_ccd"];
					// 두 row 데이터 중복체크
					var isEquals = function(row1, row2, cols) {
						var eq = true;
						for(var i = 0, colsLen = cols.length; i < colsLen; i++) {
							var col = cols[i];
							if(row1[col] !== row2[col]) {
								eq = false;
								break;
							}
						}
						return eq;
					};
					// 중복체크
					var hasDup = false, dupLnos = [];
					for(var i = 0; i < len - 1; i++) {
						var item = items[i];
						for(var j = i + 1; j < len; j++) {
							var compItem = items[j];
							if(isEquals(item, compItem, cols)) {
								hasDup = true;
								if(dupLnos.indexOf(item["rfi_lno"]) === -1)
									dupLnos.push(item["rfi_lno"]);
								dupLnos.push(compItem["rfi_lno"]);
							}
						}
						if(hasDup) break;	// item 기준으로 중복되는 compItem들을 dupLnos에 담음 (item도 포함)
					}
					me.dupLnos = dupLnos;
					return hasDup;
				}
				return false;
			},
			// RFI 에서 RFX 생성
			onShowCreate: function(e) {
				var me = this;
				var rfxTyp = e.target.dataset.args,
					itemProvider = me.$.itemGridPanel.getDataProvider(),
					items = itemProvider.getItems();
			
				if(items.length > 0) {
					var prItemIds = [],
						upcrItemIds = [],
						rfxReqRcptUuids = [];
					
					for(var i=0; i<items.length; i++) {
						var item = items[i];
						if(UT.isNotEmpty(item.pr_item_uuid)){
						   prItemIds.push(item.pr_item_uuid);
					   }
					    if(UT.isNotEmpty(item.upcr_item_uuid)){
						   upcrItemIds.push(item.upcr_item_uuid);
					   }
						if(UT.isNotEmpty(item.rfx_req_rcpt_uuid)) {
							rfxReqRcptUuids.push(item.rfx_req_rcpt_uuid);
						}
					}
					// prItemIds 중복제거
					prItemIds = prItemIds.filter((value ,index) => prItemIds.indexOf(value) === index);
					// upcrItemIds 중복제거
					upcrItemIds = upcrItemIds.filter((value ,index) => upcrItemIds.indexOf(value) === index);
				}
				
				me.$.checkPrStatus.body = {prItemIds: prItemIds, upcrItemIds: upcrItemIds};
				
				UT.request(me.$.checkPrStatus, function(e, res) {
					var lastResponse = res.response,
						status = lastResponse.resultStatus;
					
					if(status == "S") {
						if(rfxTyp === "RAUC") {
							me.fire("show-auction-detail", {
								rfx_typ_ccd: rfxTyp,
								rfi_uuid: me.searchParam.rfi_uuid,
								rfx_req_rcpt_uuids: rfxReqRcptUuids
							});
						} else if(rfxTyp === "RFQ" || rfxTyp === "RFP") {
							me.fire("show-rfx-detail", {
								rfx_typ_ccd: rfxTyp,
								rfi_uuid: me.searchParam.rfi_uuid,
								rfx_req_rcpt_uuids: rfxReqRcptUuids
							});
						}
					} else if(status === "PR_ITEM_STS_ERR") {
						var resultData     = lastResponse.resultData,
							invalidPrItems = resultData.invalid_datas || [],
							notExistIds    = resultData.not_exist_ids || [];
						
						// STD.E9400 : "유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다."
						var msg = me.translate("STD.E9400");
						
						invalidPrItems.forEach(function(invalidPrItem) {
							// [구매요청 번호 : {0}, 항번 : {1}] 은(는) '{2}' 상태입니다.
							msg += "<br/>" + me.translate("STD.PR1035", null, invalidPrItem.pr_no, invalidPrItem.pr_lno, invalidPrItem.pr_prog_sts_nm);
						});
						
						if(notExistIds.length > 0) {
							var checkedRows = me.$.itemGridPanel.getDataProvider().selectionCheckedItems();
							notExistIds.forEach(function(notExistId) {
								var notExistItem = null;
								checkedRows.forEach(function(row) {
									if(row.pr_item_uuid === notExistId) {
										notExistItem = row;
									}
								});
								if(notExistItem) {
									// [구매요청 번호 : {0}, 항번 : {1}] 은(는) 삭제되었거나 존재하지 않는 데이터입니다.
									msg += "<br/>" + me.translate("STD.PR1037", null, notExistItem.pr_no, notExistItem.pr_lno);
								}
							});
						}
						UT.alert(msg, null, true);
					} else if(status === "UPCR_ITEM_STS_ERR") {
					var resultData     = lastResponse.resultData,
						invalidItems = resultData.invalid_datas || [],
						notExistIds    = resultData.not_exist_ids || [];

					// STD.E9400 : "유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다."
					var msg = me.translate("STD.E9400");

					invalidItems.forEach(function(invalidPrItem) {
						// [단가계약요청번호 : {0}, 항번 : {1}] 은(는) '{2}' 상태입니다.
						msg += "<br/>" + me.translate("STD.UPCR0002", null, invalidPrItem.upcr_no, invalidPrItem.upcr_lno, invalidPrItem.upcr_prog_sts_nm);
					});

					if(notExistIds.length > 0) {
						var checkedRows = me.$.itemGridPanel.getDataProvider().selectionCheckedItems();
						notExistIds.forEach(function(notExistId) {
							var notExistItem = null;
							checkedRows.forEach(function(row) {
								if(row.upcr_item_uuid === notExistId) {
									notExistItem = row;
								}
							});
							if(notExistItem) {
								// [단가계약요청번호 : {0}, 항번 : {1}] 은(는) 삭제되었거나 존재하지 않는 데이터입니다.
								msg += "<br/>" + me.translate("STD.UPCR0001", null, notExistItem.upcr_no, notExistItem.upcr_lno);
							}
						});
					}
					UT.alert(msg, null, true);
					} else {
						UT.alert("STD.RFX1077");
					}
				})
			},
			// RFX 유형 별 상세화면 조회
			onShowRfxDetail: function() {
				var me = this,
					rfxTyp = me.get("rfiData.rfx_typ_ccd"),
					rfxId = me.get("rfiData.rfx_uuid");
				
				if(rfxTyp === "RFQ") {
					me.fire("show-rfx-detail", {rfx_typ_ccd: rfxTyp, rfx_uuid: rfxId});
				} else if(rfxTyp === "RFP") {
					me.fire("show-rfx-detail", {rfx_typ_ccd: rfxTyp, rfx_uuid: rfxId});
				} else if(rfxTyp == "RAUC") {
					me.fire("show-auction-detail", {rfx_typ_ccd: rfxTyp, rfx_uuid: rfxId});
				}
			},
			// RFI 저장
			onSaveRfi: function(e, data) {
				var me = this;
				var saveType = e.target.dataset.args;
				if(!me.isValid(saveType)) {
					return;
				}

				var msg = (saveType === "tempSave") ? "STD.N1200" : "STD.RFI1003";

				UT.confirm(msg, function() {
					Promise.all([me.$.upload_in.upload(), me.$.upload_out.upload()]).then(function() {
						var rfiData = me.get("rfiData");
						var itemProvider = me.$.itemGridPanel.getDataProvider();
						var vdProvider = me.$.vdGridPanel.getDataProvider();

						var saveAjax = (saveType === "tempSave") ? me.$.tempSaveRfi : me.$.requestRfi;
						saveAjax.body = {
							rfiData: rfiData,
							insertRfiItems: itemProvider.getNewItems(),
							updateRfiItems: itemProvider.getUpdateItems(),
							deleteRfiItems: itemProvider.getRemoveItems(),
							insertRfiVendors: vdProvider.getNewItems(),
							updateRfiVendors: vdProvider.getUpdateItems(),
							deleteRfiVendors: vdProvider.getRemoveItems(),
							prItemIds: UT.getArrayValuesByKey(itemProvider.getItems(), "pr_item_uuid"),	// validation을 위해 전체 품목의 pr_item_uuid 리스트를 보낸다.
							upcrItemIds: UT.getArrayValuesByKey(itemProvider.getItems(), "upcr_item_uuid")	// validation을 위해 전체 품목의 upcr_item_uuid 리스트를 보낸다.
						};

						UT.request(saveAjax, function(e, res) {
							var result = res.response;

							if(result.resultStatus === "S") {
								var rfiId = result.resultData.rfi_uuid;
								if(saveType == "tempSave") {
									UT.completeAlert();
								} else {
									UT.completeAlert();
								}
								me.findRfiDetail(rfiId);
							} else if(result.resultStatus === "PR_ITEM_STS_ERR") {
								var resultData     = result.resultData,
									invalidPrItems = resultData.invalid_datas || [],
									notExistIds    = resultData.not_exist_ids || [];

								// STD.E9400 : "유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다."
								var msg = me.translate("STD.E9400");

								invalidPrItems.forEach(function(invalidPrItem) {
									// [구매요청 번호 : {0}, 항번 : {1}] 은(는) '{2}' 상태입니다.
									msg += "<br/>" + me.translate("STD.PR1035", null, invalidPrItem.pr_no, invalidPrItem.pr_lno, invalidPrItem.pr_prog_sts_nm);
								});

								if(notExistIds.length > 0) {
									var checkedRows = me.$.itemGridPanel.getDataProvider().selectionCheckedItems();
									notExistIds.forEach(function(notExistId) {
										var notExistItem = null;
										checkedRows.forEach(function(row) {
											if(row.pr_item_uuid === notExistId) {
												notExistItem = row;
											}
										});
										if(notExistItem) {
											// [구매요청 번호 : {0}, 항번 : {1}] 은(는) 삭제되었거나 존재하지 않는 데이터입니다.
											msg += "<br/>" + me.translate("STD.PR1037", null, notExistItem.pr_no, notExistItem.pr_lno);
										}
									});
								}
								UT.alert(msg, null, true);
							} else if(result.resultStatus === "UPCR_ITEM_STS_ERR") {
								var resultData     = result.resultData,
									invalidItems = resultData.invalid_datas || [],
									notExistIds    = resultData.not_exist_ids || [];

								// STD.E9400 : "유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다."
								var msg = me.translate("STD.E9400");

								invalidItems.forEach(function(invalidPrItem) {
									// [단가계약요청번호 : {0}, 항번 : {1}] 은(는) '{2}' 상태입니다.
									msg += "<br/>" + me.translate("STD.UPCR0002", null, invalidPrItem.upcr_no, invalidPrItem.upcr_lno, invalidPrItem.upcr_prog_sts_nm);
								});

								if(notExistIds.length > 0) {
									var checkedRows = me.$.itemGridPanel.getDataProvider().selectionCheckedItems();
									notExistIds.forEach(function(notExistId) {
										var notExistItem = null;
										checkedRows.forEach(function(row) {
											if(row.upcr_item_uuid === notExistId) {
												notExistItem = row;
											}
										});
										if(notExistItem) {
											// [단가계약요청번호 : {0}, 항번 : {1}] 은(는) 삭제되었거나 존재하지 않는 데이터입니다.
											msg += "<br/>" + me.translate("STD.UPCR0001", null, notExistItem.upcr_no, notExistItem.upcr_lno);
										}
									});
								}
								UT.alert(msg, null, true);
							} else if(result.resultStatus === "N") {
								UT.alert("STD.E9300");	// 삭제되었거나 존재하지 않는 데이터입니다.
								me.onClose();

							} else {
								UT.alert("STD.E9999");
							}
						});
					});
				});
			},
			// 삭제 버튼 click
			onDelete: function() {
				var me = this;

				UT.confirm("STD.N1300", function() {
					UT.request(me.$.deleteRfi, function(e, res) {
						var result = res.response;

						if(result.resultStatus === "S") {
							UT.alert("STD.N2500");	//"삭제하였습니다."
							me.onClose();

						} else if(result.resultStatus === "INVALID_STATUS_ERR") {
							UT.alert("STD.E9400");	// 유효한 상태가 아니거나 상태가 변경되어 요청을 수행할 수 없습니다.
							me.findRfiDetail(me.get("rfiData.rfi_uuid"));

						} else {
							UT.alert("STD.E9999");
						}
					});
				});
			},
			// 데이터 초기화
			clearData: function() {
				var me = this;

				//데이터 clear 이전에 초기화 해주어야 함
				me.set('loadCompleted', false);

				//properties 초기화 및 grid provider 초기화
				me.reset();
			},
			// 닫기 버튼 click
			onClose: function() {
				var me = this;

				me.clearData();
				me.fire("close");
			},
			// 품목 규격 상세 팝업
			showDetailSpec: function(data, provider) {
				var me = this;

				var readonly = !me.formula('noCdItemAddable');
				var popup = UT.popup('ep-item-detail-spec', me, 400, (readonly ? 240 : 260), {
					"clear-dtl-spec": function(popup, e) {
						provider.setItemAt(me.rowIndex, {
							"item_spec_dtl": null
						});
						popup.close();
					},
					"apply-dtl-spec": function(popup, e) {
						var dtlSpec = e.detail.item_spec_dtl;

						provider.setItemAt(me.rowIndex, {
							"item_spec_dtl": dtlSpec
						});
						popup.close();
					}
				});
				popup.show();
				popup.getWindowContent().load(data, readonly);
			},
			// 그리드 item-editable-function
			onItemEditableFn: function(data, item) {
				var me = this;

				if(["item_nm", "item_spec"].indexOf(item.dataField) > -1) {
					return data["item_cd_crn_typ_ccd"] === "CDLS" && me.formula("noCdItemAddable");
				}
			},
			// 그리드 item-style-function
			onItemStyleFn: function(data, item) {
				var me       = this,
					styleObj = {};

				if(item.dataField === "item_spec" && me.onItemEditableFn(data, item)) {
					styleObj = {
						iconLocation: "leftSide",
						iconOffset: 0,
						iconPadding: 0,
						paddingLeft: 0,
						paddingTop: 0,
						iconUrl: "bower_components/sc-grid/resources/img/icon_required.png"
					};
				}
				return styleObj;
			},
			// 그리드 image-change-function
			onImageChangeFn: function(data, item) {
				if(item.dataField === "img_item_spec_dtl" && data["item_cd_crn_typ_ccd"] === "CDLS") {	// 품목 규격 상세(미등록 품목인 경우)
					return "link";
				} else if(item.dataField === "img_item_cd" && data["item_cd_crn_typ_ccd"] === "ITEM_CD") {
					return "link";
				}
				return null;
			},
			onImagePlantSelectShowFunction : function(data, item) {
				if(UT.isNotEmpty(data["item_cd_crn_typ_ccd"]) && data["item_cd_crn_typ_ccd"] === 'CDLS'){ // 무품목코드 일 경우만 표기
					return "search";
				}
				return "";
			},
			// 품목 별 계약 및 발주 이력 조회
			showItemContractHistory: function(itemCd) {
				var me = this;

				var itemHistoryPopup = UT.popup("ep-item-perform", me, "90%", "80%", null, {titleText : I18N.translate("품목 정보")});
				itemHistoryPopup.show();
				itemHistoryPopup.getWindowContent().load({item_cd: itemCd});
			}
		});
	</script>
</dom-module>