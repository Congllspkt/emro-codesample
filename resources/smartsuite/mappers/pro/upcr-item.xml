<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="upcr-item">
	<delete id="deleteUpcrItem">
		/* upcr-item.deleteUpcrItem */
		DELETE
		  FROM UPCR_ITEM
		 WHERE TEN_ID     = #{g.tenant}
		   AND UPCR_ITEM_UUID = #{p.upcr_item_uuid}
	</delete>
	<insert id="insertUpcrItem">
		/* upcr-item.insertUpcrItem */
		INSERT INTO UPCR_ITEM (
			TEN_ID
			, UPCR_ITEM_UUID
			, UPCR_UUID
			, UPCR_NO
			, UPCR_REVNO
			, UPCR_LNO
			, OORG_CD
			, PURC_TYP_CCD
			, PLT_CD
			, ITEM_OORG_CD
			, ITEM_CD_CRN_TYP_CCD
			, ITEM_CD
			, ITEM_NM
			, ITEM_NM_EN
			, ITEM_SPEC
			, ITEM_SPEC_DTL
			, UOM_CCD
			, UPCR_QTY
			, CUR_CCD
			, UPCR_UPRC
			, UPCR_AMT
			, WH_CCD
			, DLVY_PLC
			, PURC_GRP_CD
			, GR_PIC_ID
			, UPCR_REALUSR_ID
			, UPCR_REALUSR_REQ_CONT
			, SG_CD
			, REQ_DLVY_DT
			, ATHG_UUID
			, UPCR_RET_RSN
			, UPCR_STS_CCD
			, UPCR_CHG_YN
			, STS
			, REGR_ID
			, REG_DTTM
			, MODR_ID
			, MOD_DTTM
			, UPCR_PURP_CCD
			, BOM_UUID
		) VALUES (
			#{g.tenant}
			, #{p.upcr_item_uuid}
			, #{p.upcr_uuid}
			, #{p.upcr_no}
			, CAST(#{p.upcr_revno} AS INT)
			, TO_CHAR(#{p.upcr_lno})  , #{p.oorg_cd}
			, #{p.purc_typ_ccd}
			, #{p.plt_cd}
			, #{p.item_oorg_cd}
			, #{p.item_cd_crn_typ_ccd}
			, #{p.item_cd}
			, #{p.item_nm}
			, #{p.item_nm_en}
			, #{p.item_spec}
			, #{p.item_spec_dtl}
			, #{p.uom_ccd}
			, CAST(#{p.upcr_qty} AS FLOAT  )
			, #{p.cur_ccd}
			, CAST(#{p.upcr_uprc} AS FLOAT  )
			, CAST(#{p.upcr_amt} AS FLOAT  )
			, #{p.wh_ccd}
			, #{p.dlvy_plc}
			, #{p.purc_grp_cd}
			, #{p.gr_pic_id}
			, #{p.upcr_realusr_id}
			, #{p.upcr_realusr_req_cont}
			, #{p.sg_cd}
			, #{p.req_dlvy_dt}
			, #{p.athg_uuid}
			, #{p.upcr_ret_rsn}
			, #{p.upcr_sts_ccd}
			, #{p.upcr_chg_yn}
			, 'C'
			, #{g.username}
			, #{g.now}
			, #{g.username}
			, #{g.now}
			, #{p.upcr_purp_ccd}
			, #{p.bom_uuid}
		)
	</insert>
	<update id="updateUpcrItem">
		/* upcr-item.updateUpcrItem */
		UPDATE UPCR_ITEM
		   SET PLT_CD          = #{p.plt_cd}
		     , ITEM_OORG_CD          = #{p.item_oorg_cd}
		     , ITEM_SPEC            = #{p.item_spec}
		     , ITEM_SPEC_DTL        = #{p.item_spec_dtl}
		     , UOM_CCD         = #{p.uom_ccd}
		     , UPCR_QTY        = CAST(#{p.upcr_qty} AS FLOAT  )
		     , CUR_CCD             = #{p.cur_ccd}
		     <choose>
		         <when test="p.upcr_uprc != null">
		             , UPCR_UPRC = CAST(#{p.upcr_uprc} AS FLOAT  )
		         </when>
		         <otherwise>
		             , UPCR_UPRC = NULL
		         </otherwise>
		     </choose>
		     <choose>
		         <when test="p.upcr_amt != null">
		             , UPCR_AMT = CAST(#{p.upcr_amt} AS FLOAT  )
		         </when>
		         <otherwise>
		             , UPCR_AMT = NULL
		         </otherwise>
		     </choose>
		     , WH_CCD           = #{p.wh_ccd}
		     , PURC_GRP_CD     = #{p.purc_grp_cd}
		     , UPCR_REALUSR_ID       = #{p.upcr_realusr_id}
		     , UPCR_REALUSR_REQ_CONT     = #{p.upcr_realusr_req_cont}
		     , DLVY_PLC        = #{p.dlvy_plc}
		     , REQ_DLVY_DT         = #{p.req_dlvy_dt}
		     , GR_PIC_ID       = #{p.gr_pic_id}
		     , SG_CD           = #{p.sg_cd}
		     , ATHG_UUID          = #{p.athg_uuid}
		     , UPCR_RET_RSN    = #{p.upcr_ret_rsn}
		     , UPCR_CHG_YN = #{p.upcr_chg_yn}
		  	 , UPCR_STS_CCD     = #{p.upcr_sts_ccd}
		     , UPCR_PURP_CCD    = #{p.upcr_purp_ccd}
		     , STS             = 'U'
		     , MODR_ID          = #{g.username}
		     , MOD_DTTM          = #{g.now}
		 WHERE TEN_ID     = #{g.tenant}
		   AND UPCR_ITEM_UUID = #{p.upcr_item_uuid}
	</update>
	<select id="findUpcrItemByUpcr" resultType="map">
		/* upcr-item.findUpcrItemByUpcr */
		SELECT UPCR_ITEM.TEN_ID
		     , UPCR_ITEM.UPCR_ITEM_UUID
		     , UPCR_ITEM.UPCR_UUID
		     , UPCR_ITEM.UPCR_NO
		     , UPCR_ITEM.UPCR_REVNO
		     , UPCR_ITEM.UPCR_LNO
		     , UPCR_ITEM.OORG_CD
		     , UPCR_ITEM.PURC_TYP_CCD
		     , UPCR_ITEM.UPCR_PURP_CCD
		     , UPCR_ITEM.PLT_CD
		     , (SELECT
		            CASE WHEN 'en_US' = #{g.locale}
		                THEN LOGIC_ORG.LOGIC_ORG_NM_EN
		                ELSE LOGIC_ORG.LOGIC_ORG_NM
		                END AS LOGIC_ORG_NM
		        FROM LOGIC_ORG LOGIC_ORG
		        INNER JOIN OORG OORG
		        ON LOGIC_ORG.TEN_ID = OORG.TEN_ID
		        AND LOGIC_ORG.LOGIC_ORG_CD = OORG.LOGIC_ORG_CD
		        WHERE LOGIC_ORG.TEN_ID = UPCR_ITEM.TEN_ID
		          AND LOGIC_ORG.ORG_CD = UPCR_ITEM.PLT_CD
				 AND OORG.OORG_CD = UPCR_ITEM.ITEM_OORG_CD) AS PLT_NM
		     , UPCR_ITEM.ITEM_OORG_CD
		     , UPCR_ITEM.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCR_ITEM.ITEM_CD_CRN_TYP_CCD = 'CDLS'  -- 구매품목유형: 미등록(무코드품목)
		                 THEN NULL
		            ELSE UPCR_ITEM.ITEM_CD
		       END  AS DISP_ITEM_CD
		     , UPCR_ITEM.ITEM_CD
		     , CASE WHEN 'en_US' = #{g.locale}
                       THEN UPCR_ITEM.ITEM_NM_EN
                	   ELSE UPCR_ITEM.ITEM_NM
                	    END AS DISP_ITEM_NM
		     , UPCR_ITEM.ITEM_NM
		     , UPCR_ITEM.ITEM_NM_EN
		     , UPCR_ITEM.ITEM_SPEC
		     , UPCR_ITEM.ITEM_SPEC_DTL
		     , UPCR_ITEM.UOM_CCD
		     , UPCR_ITEM.UPCR_QTY
		     , UPCR_ITEM.CUR_CCD
		     , UPCR_ITEM.UPCR_UPRC
		     , UPCR_ITEM.UPCR_AMT
		     , UPCR_ITEM.WH_CCD
		     , UPCR_ITEM.DLVY_PLC
		     , UPCR_ITEM.PURC_GRP_CD
		     , UPCR_ITEM.GR_PIC_ID
		     , UPCR_ITEM.UPCR_REALUSR_ID
		     , UPCR_ITEM.UPCR_REALUSR_REQ_CONT
		     , UPCR_ITEM.SG_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN SG.SG_NM_EN
		            ELSE SG.SG_NM
		        END AS SG_NM
		     , UPCR_ITEM.REQ_DLVY_DT
		     , UPCR_ITEM.ATHG_UUID
		     , UPCR_ITEM.UPCR_RET_RSN
		     , UPCR_ITEM.UPCR_STS_CCD
		     , UPCR_ITEM.UPCR_CHG_YN
		     , UPCR_ITEM.STS
		     , UPCR_ITEM.REGR_ID
		     , UPCR_ITEM.REG_DTTM
		     , UPCR_ITEM.MODR_ID
		     , UPCR_ITEM.MOD_DTTM
		     , CASE WHEN 'en_US' = #{g.locale}
                       THEN JOB.PURC_GRP_NM_EN
                	   ELSE JOB.PURC_GRP_NM
                	    END AS PURC_GRP_NM
		     , CASE WHEN 'en_US' = #{g.locale}
                       THEN UPCR_SUG_USR.USR_NM_EN
                	   ELSE UPCR_SUG_USR.USR_NM
                	    END AS UPCR_REALUSR_NM
		     , CASE WHEN 'en_US' = #{g.locale}
                       THEN GR_CHR_USR.USR_NM_EN
                	   ELSE GR_CHR_USR.USR_NM
                	    END AS GR_PIC_NM
		     <choose>
		         <when test="p.modify_yn != null and p.modify_yn eq 'Y'.toString()">
		             , 'Y'  AS HAS_PREV_YN
		         </when>
		         <otherwise>
		             , CASE WHEN PREV_UPCR_ITEM.UPCR_ITEM_UUID IS NOT NULL  THEN 'Y'
		                    ELSE 'N'
		                END AS HAS_PREV_YN
		         </otherwise>
		     </choose>
		  FROM UPCR_ITEM UPCR_ITEM
		  LEFT OUTER JOIN USR UPCR_SUG_USR        /* UPCR_SUG_USR : 구매요청 의뢰자 */
		    ON UPCR_ITEM.TEN_ID    = UPCR_SUG_USR.TEN_ID
		   AND UPCR_ITEM.UPCR_REALUSR_ID = UPCR_SUG_USR.USR_ID
		  LEFT OUTER JOIN USR GR_CHR_USR        /* GR_CHR_USR : 검수 담당자 */
		    ON UPCR_ITEM.TEN_ID    = GR_CHR_USR.TEN_ID
		   AND UPCR_ITEM.GR_PIC_ID = GR_CHR_USR.USR_ID
		  LEFT OUTER JOIN PURC_GRP JOB               /* JOB : 직무(그룹) */
		    ON JOB.TEN_ID       = UPCR_ITEM.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCR_ITEM.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		  <if test="p.modify_yn == null or p.modify_yn eq 'N'.toString()">
		  LEFT OUTER JOIN UPCR_ITEM PREV_UPCR_ITEM
		    ON PREV_UPCR_ITEM.TEN_ID     = UPCR_ITEM.TEN_ID
		   AND PREV_UPCR_ITEM.UPCR_NO      = UPCR_ITEM.UPCR_NO
		   AND PREV_UPCR_ITEM.UPCR_REVNO     = UPCR_ITEM.UPCR_REVNO -1
		   AND PREV_UPCR_ITEM.UPCR_LNO     = UPCR_ITEM.UPCR_LNO
		   AND PREV_UPCR_ITEM.ITEM_CD    = UPCR_ITEM.ITEM_CD
		  </if>
		  LEFT OUTER JOIN SG SG
		    ON SG.TEN_ID = UPCR_ITEM.TEN_ID
		   AND SG.SG_CD = UPCR_ITEM.SG_CD
		 WHERE UPCR_ITEM.TEN_ID = #{g.tenant}
		   AND UPCR_ITEM.UPCR_UUID  = #{p.upcr_uuid}
		   AND UPCR_ITEM.STS   != 'D'
	</select>
	<select id="findListRfxItemDefaultDataByUpcrItemIds" resultType="map">
		/* upcr-item.findListRfxItemDefaultDataByUpcrItemIds */
		SELECT CASE WHEN UPCRDT.UPCR_PURP_CCD = 'UPRCCNTR_PURC'
		                 THEN NULL
		            ELSE UPCRDT.UPCR_ITEM_UUID
		       END                                       AS UPCR_ITEM_UUID
		     , CASE WHEN UPCRDT.UPCR_PURP_CCD = 'UPRCCNTR_PURC'
		                 THEN NULL
		            ELSE UPCRDT.UPCR_UUID
		       END                                       AS UPCR_UUID
		     , CASE WHEN UPCRDT.UPCR_PURP_CCD = 'UPRCCNTR_PURC'
		                 THEN NULL
		            ELSE UPCRDT.UPCR_NO
		       END                                       AS UPCR_NO
		     , CASE WHEN UPCRDT.UPCR_PURP_CCD = 'UPRCCNTR_PURC'
		                 THEN NULL
		            ELSE UPCRDT.UPCR_REVNO
		       END                                       AS UPCR_REVNO
		     , CASE WHEN UPCRDT.UPCR_PURP_CCD = 'UPRCCNTR_PURC'
		                 THEN NULL
		            ELSE UPCRDT.UPCR_LNO
		       END                                       AS UPCR_LNO
		     , UPCRDT.OORG_CD
		     , UPCRDT.UPCR_PURP_CCD
		     , UPCRDT.PURC_TYP_CCD
		     , UPCRDT.PLT_CD
		     , UPCRDT.ITEM_OORG_CD
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS'  -- 구매품목유형: 미등록(무코드품목)
		                 THEN NULL
		            ELSE UPCRDT.ITEM_CD
		       END                                       AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCRDT.ITEM_NM_EN ELSE UPCRDT.ITEM_NM END AS DISP_ITEM_NM
		     , UPCRDT.ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.UPCR_QTY								AS RFX_QTY
		     , UPCRDT.CUR_CCD                                  AS CUR_CCD
		     , UPCRDT.CUR_CCD                                  AS RFX_CUR
		     , CASE WHEN UPCRDT.UPCR_UPRC IS NULL
		                 THEN 0
		            ELSE UPCRDT.UPCR_UPRC
		       END                                       AS RFX_REQ_UPRC
		     , CASE WHEN UPCRDT.UPCR_AMT IS NULL
		                 THEN 0
		            ELSE UPCRDT.UPCR_AMT
		       END                                       AS RFX_REQ_AMT
		     , UPCRDT.WH_CCD
		     , UPCRDT.PURC_GRP_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN JOB.PURC_GRP_NM_EN ELSE JOB.PURC_GRP_NM END AS PURC_GRP_NM
		     , UPCRDT.SG_CD
		     , UPCRDT.REQ_DLVY_DT
		     , UPCRDT.DLVY_PLC
		  FROM UPCR_ITEM UPCRDT
		 INNER JOIN TEMP_TBL TEMP
		    ON TEMP.TEN_ID = UPCRDT.TEN_ID
		   AND TEMP.TASK_ID = UPCRDT.UPCR_ITEM_UUID
		   AND TEMP.USR_ID = #{g.username}
		  LEFT OUTER JOIN PURC_GRP JOB               /* JOB : 직무(그룹) */
		    ON JOB.TEN_ID       = UPCRDT.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		 WHERE UPCRDT.TEN_ID = #{g.tenant}
		 ORDER BY UPCRDT.UPCR_NO, CAST(UPCRDT.UPCR_LNO AS INT)
	</select>
	<select id="findListRfiItemDefaultDataByUpcrItemIds" resultType="map">
		/* upcr-item.findListRfiItemDefaultDataByUpcrItemIds */
		SELECT UPCRDT.OORG_CD
		     , UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS'  -- 구매품목유형: 미등록(무코드품목)
		                 THEN NULL
		            ELSE UPCRDT.ITEM_CD
		       END  AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCRDT.ITEM_NM_EN ELSE UPCRDT.ITEM_NM END AS DISP_ITEM_NM
		     , UPCRDT.ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.UPCR_QTY				AS RFI_QTY
		     , UPCRDT.CUR_CCD
		  FROM UPCR_ITEM UPCRDT
		 WHERE UPCRDT.TEN_ID      = #{g.tenant}
		   AND UPCRDT.UPCR_ITEM_UUID IN
		   <foreach close=")" collection="p.upcr_item_uuids" item="upcr_item_uuid" open="(" separator=",">
		       #{upcr_item_uuid}
		   </foreach>
		 ORDER BY UPCRDT.UPCR_NO, CAST(UPCRDT.UPCR_LNO AS INT)
	</select>
	<sql id="subSqlRevTable">
		SELECT PHD.TEN_ID
		     , PHD.UPCR_UUID
		     , PHD.UPCR_NO
		     , PHD.UPCR_REVNO
		     , PHD.OORG_CD
		     , PHD.UPCR_TIT
		     , PHD.PURC_TYP_CCD
		     , PHD.UPCR_PURP_CCD
		     , PHD.UPCR_STS_CCD
		     , PHD.UPCR_CRTR_ID
		     , PHD.UPCR_REQ_DT
		     , PHD.UPCR_CRTR_DEPT_CD
		     , (
		        SELECT MAX(CAST(A.UPCR_REVNO AS INT))
		          FROM UPCR A
		         WHERE A.TEN_ID = PHD.TEN_ID
		           AND A.UPCR_NO  = PHD.UPCR_NO
		           AND A.STS   != 'D'
		       ) AS LAST_REV
		  FROM UPCR PHD
		 WHERE PHD.TEN_ID = #{g.tenant}
		   AND PHD.STS   != 'D'
	</sql>
	<select id="findListUpcrItemProg" resultType="map">
		/* upcr-item.findListUpcrItemProg : 구매요청 진행현황 조회 */
		SELECT UPCRHD.TEN_ID
		     , UPCRHD.UPCR_UUID
		     , UPCRHD.UPCR_REVNO
		     , UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.OORG_CD
		     , UPCRDT.UPCR_STS_CCD
		     , UPCRDT.UPCR_GRP_STS_CCD
		     , UPCRHD.PURC_TYP_CCD
		     , UPCRHD.UPCR_PURP_CCD
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_LNO
		     , UPCRHD.UPCR_TIT
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE UPCRDT.ITEM_CD
		        END AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCRDT.ITEM_NM_EN
		            ELSE UPCRDT.ITEM_NM
		        END AS ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.CUR_CCD
		     , UPCRDT.UPCR_QTY
		     , UPCRDT.UPCR_UPRC
		     , UPCRDT.UPCR_AMT
		     , UPCRDT.REQ_DLVY_DT
		     , UPCRDT.PLT_CD
		     , UPCRDT.ITEM_OORG_CD
		     , UPCRDT.PURC_GRP_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN JOB.PURC_GRP_NM_EN
		            ELSE JOB.PURC_GRP_NM
		        END AS PURC_GRP_NM         /* 요청자 명 */
		     , UPCRDT.DLVY_PLC
		     , UPCRHD.UPCR_CRTR_ID
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_REQ_USER.USR_NM_EN
		            ELSE UPCR_REQ_USER.USR_NM
		        END AS UPCR_CRTR_NM         /* 요청자 명 */
		     , UPCRHD.UPCR_CRTR_DEPT_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_CRTR_DEPT_CD.DEPT_NM_EN
		            ELSE UPCR_CRTR_DEPT_CD.DEPT_NM
		        END AS UPCR_REQ_DEPT_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_SUG_USER.USR_NM_EN
		            ELSE UPCR_SUG_USER.USR_NM
		        END AS UPCR_REALUSR_NM
		     , UPCRHD.UPCR_REQ_DT
		     , UPCRDT.UPCR_REALUSR_ID         /* 구매의뢰자 명 */
		     , UPCRDT.UPCR_REALUSR_REQ_CONT
		     , UPCRDT.UPCR_RET_RSN
		     , PODATA.PO_QTY  /* 발주수량 */
		     , PODATA.GR_QTY
		     , PODATA.PO_NO
		     , PODATA.VD_CD
		     , PODATA.ERP_VD_CD
		     , PODATA.VD_NM
		     , PODATA.UPRCCNTR_NO
		     , PODATA.PO_TYP_CCD
		     , RFXDATA.RFX_NO
		  FROM (
		        <include refid="subSqlRevTable"/>
		       ) UPCRHD
		 INNER JOIN UPCR_ITEM UPCRDT
		    ON UPCRDT.TEN_ID = UPCRHD.TEN_ID
		   AND UPCRDT.UPCR_UUID  = UPCRHD.UPCR_UUID
		   AND UPCRHD.UPCR_REVNO = UPCRHD.LAST_REV
		  LEFT OUTER JOIN (
		                   SELECT RFXHD.TEN_ID
		                        , RFXDT.UPCR_ITEM_UUID
		                        , RFXDT.RFX_NO
		                     FROM RFX RFXHD
		                    INNER JOIN RFX_ITEM RFXDT
		                       ON RFXDT.TEN_ID = RFXHD.TEN_ID
		                      AND RFXDT.RFX_UUID = RFXHD.RFX_UUID
		                      AND RFXDT.STS   != 'D'
		                    WHERE RFXHD.TEN_ID       = #{g.tenant}
		                      AND RFXHD.RFX_RES_STS_CCD NOT IN ('REQTA', 'CNCL') /* R: 재견적 */
		                      AND RFXHD.STS         != 'D'
		                  ) RFXDATA
		    ON UPCRDT.TEN_ID = RFXDATA.TEN_ID
		   AND UPCRDT.UPCR_ITEM_UUID = RFXDATA.UPCR_ITEM_UUID
		  LEFT OUTER JOIN (
		                   SELECT POHD.TEN_ID
		                        , PODT.UPCR_ITEM_UUID
		                        , PODT.PO_QTY
		                        , PODT.GR_QTY
		                        , PODT.PO_NO
		                        , POHD.VD_CD
		                        , CASE WHEN 'en_US' = #{g.locale} THEN VDGL.VD_NM_EN ELSE VDGL.VD_NM END AS VD_NM
		                        , VDGL.ERP_VD_CD
		                        , POHD.UPRCCNTR_NO
		                        , POHD.PO_TYP_CCD
		                     FROM PO POHD
		                    INNER JOIN PO_ITEM PODT
		                       ON PODT.TEN_ID = POHD.TEN_ID
		                      AND PODT.PO_UUID  = POHD.PO_UUID
		                      AND PODT.STS   != 'D'
		                   INNER JOIN VD VDGL
		                      ON VDGL.TEN_ID = POHD.TEN_ID
		                     AND VDGL.VD_CD  = POHD.VD_CD
		                     AND VDGL.STS   != 'D'
		                   WHERE POHD.TEN_ID      = #{g.tenant}
		                     AND POHD.PO_STS_CCD IN ('APVD', 'TRMN') /* C:발주승인완료, D:발주해지 */
		                     AND POHD.EFCT_PO_YN  = 'Y'
		                     AND POHD.STS        != 'D'
		                  ) PODATA
		    ON PODATA.TEN_ID     = UPCRDT.TEN_ID
		   AND PODATA.UPCR_ITEM_UUID = UPCRDT.UPCR_ITEM_UUID
		  LEFT OUTER JOIN USR UPCR_SUG_USER
		    ON UPCR_SUG_USER.TEN_ID  = UPCRDT.TEN_ID
		   AND UPCR_SUG_USER.USR_ID  = UPCRDT.UPCR_REALUSR_ID
		   AND UPCR_SUG_USER.STS    != 'D'
		 INNER JOIN USR UPCR_REQ_USER
		    ON UPCR_REQ_USER.TEN_ID  = UPCRHD.TEN_ID
		   AND UPCR_REQ_USER.USR_ID  = UPCRHD.UPCR_CRTR_ID
		   AND UPCR_REQ_USER.STS    != 'D'
		  LEFT OUTER JOIN LOGIC_ORG B         /* B : 조직 */
		    ON UPCR_REQ_USER.TEN_ID   = B.TEN_ID
		   AND UPCR_REQ_USER.CO_CD  = B.LOGIC_ORG_CD
		   AND B.LOGIC_ORG_TYP_CCD = 'COMPANY'
		   AND B.STS       != 'D'
		  LEFT OUTER JOIN LOGIC_ORG_DEPT_MAPG ODM
						  ON UPCR_REQ_USER.TEN_ID = ODM.TEN_ID
							  AND UPCR_REQ_USER.CO_CD = ODM.LOGIC_ORG_CD
							  AND UPCRHD.UPCR_CRTR_DEPT_CD = ODM.DEPT_CD
							  AND ODM.STS != 'D'
		  LEFT OUTER JOIN DEPT UPCR_CRTR_DEPT_CD
		    ON ODM.TEN_ID      = UPCR_CRTR_DEPT_CD.TEN_ID
		   AND ODM.DEPT_CD = UPCR_CRTR_DEPT_CD.DEPT_CD
		   AND UPCR_CRTR_DEPT_CD.STS        != 'D'
		  LEFT OUTER JOIN PURC_GRP JOB
		    ON JOB.TEN_ID       = UPCRDT.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		 WHERE UPCRHD.TEN_ID  = #{g.tenant}
		   AND UPCRDT.STS    != 'D'
		   AND UPCRDT.UPCR_STS_CCD IS NOT NULL  AND UPCRDT.UPCR_STS_CCD NOT IN ('PR_CRNG', 'PR_APVL_RPTG', 'PR_APVL_RET', 'PR_CHG_CRNG')
		   AND UPCRDT.UPCR_GRP_STS_CCD IS NOT NULL <if test="p.oorg_cds != null and p.oorg_cds.size() != 0">
		       AND UPCRHD.OORG_CD           IN
		       <foreach close=")" collection="p.oorg_cds" item="oorg_cd" open="(" separator=",">
		           #{oorg_cd}
		       </foreach>
		   </if>
		   <if test="p.from_upcr_req_date != null">
		       AND UPCRHD.UPCR_REQ_DT <![CDATA[>=]]> #{p.from_upcr_req_date}
		   </if>
		   <if test="p.to_upcr_req_date != null">
		       <bind name="toDatePattern" value="g.getPlusDays(p.to_upcr_req_date,1)"/>
		       AND UPCRHD.UPCR_REQ_DT <![CDATA[<]]> #{toDatePattern}
		   </if>
		   <if test="p.upcr_purp_ccd != null and p.upcr_purp_ccd != ''">
		            AND UPCRHD.UPCR_PURP_CCD = #{p.upcr_purp_ccd}
		   </if>
		   <if test="p.purc_typ_ccd != null and p.purc_typ_ccd != ''">
		       AND UPCRHD.PURC_TYP_CCD = #{p.purc_typ_ccd}
		   </if>
		   <choose>
		       <when test="p.upcr_nos != null and p.upcr_nos.size() != 0">
		           AND UPCRHD.UPCR_NO IN
		           <foreach close=")" collection="p.upcr_nos" item="upcr_no" open="(" separator=",">
		               #{upcr_no}
		           </foreach>
		       </when>
		       <otherwise>
		           <if test="p.upcr_no != null and p.upcr_no != ''">
		               <bind name="upcrNoPattern" value="'%' + p.upcr_no + '%'"/>
		               AND UPPER(UPCRHD.UPCR_NO) LIKE UPPER(#{upcrNoPattern})
		           </if>
		       </otherwise>
		   </choose>
		   <if test="p.upcr_tit != null and p.upcr_tit != ''">
		       <bind name="upcrTitPattern" value="'%' + p.upcr_tit + '%'"/>
		       AND UPPER(UPCRHD.UPCR_TIT) LIKE UPPER(#{upcrTitPattern})
		   </if>
		   <choose>
		       <when test="p.upcr_crtr_dept_cd != null and p.upcr_crtr_dept_cd != ''">
		           AND UPCRHD.UPCR_CRTR_DEPT_CD = #{p.upcr_crtr_dept_cd}
		       </when>
		       <otherwise>
		           <if test="p.upcr_req_dept_nm != null and p.upcr_req_dept_nm != ''">
		               <bind name="upcrReqDeptNmPattern" value="'%' + p.upcr_req_dept_nm + '%'"/>
		               AND (UPPER(UPCR_CRTR_DEPT_CD.DEPT_NM) LIKE UPPER(#{upcrReqDeptNmPattern}) OR UPPER(UPCR_CRTR_DEPT_CD.DEPT_NM_EN) LIKE UPPER(#{upcrReqDeptNmPattern}))
		           </if>
		       </otherwise>
		   </choose>
		   <choose>
		       <when test="p.upcr_crtr_id != null and p.upcr_crtr_id != ''">
		           AND UPCRHD.UPCR_CRTR_ID = #{p.upcr_crtr_id}
		       </when>
		       <otherwise>
		           <if test="p.upcr_crtr_nm != null and p.upcr_crtr_nm != ''">
		               <bind name="upcrReqUserNmPattern" value="'%' + p.upcr_crtr_nm + '%'"/>
		               AND (UPPER(UPCR_REQ_USER.USR_NM) LIKE UPPER(#{upcrReqUserNmPattern}) OR UPPER(UPCR_REQ_USER.USR_NM_EN) LIKE UPPER(#{upcrReqUserNmPattern}))
		           </if>
		       </otherwise>
		   </choose>
		   <choose>
		       <when test="p.upcr_realusr_id != null and p.upcr_realusr_id != ''">
		           AND UPCRDT.UPCR_REALUSR_ID = #{p.upcr_realusr_id}
		       </when>
		       <otherwise>
		           <if test="p.upcr_realusr_nm != null and p.upcr_realusr_nm != ''">
		               <bind name="upcrSugUserNmPattern" value="'%' + p.upcr_realusr_nm + '%'"/>
		               AND (UPPER(UPCR_SUG_USER.USR_NM) LIKE UPPER(#{upcrSugUserNmPattern}) OR UPPER(UPCR_SUG_USER.USR_NM_EN) LIKE UPPER(#{upcrSugUserNmPattern}) )
		           </if>
		       </otherwise>
		   </choose>
		   <choose>
		       <when test="p.item_cds != null and p.item_cds.size() != 0">
		           AND UPCRDT.ITEM_CD IN
		           <foreach close=")" collection="p.item_cds" item="item_cd" open="(" separator=",">
		               #{item_cd}
		           </foreach>
		       </when>
		       <otherwise>
		           <if test="p.item_cd != null and p.item_cd != ''">
		               <bind name="itemCdPattern" value="'%' + p.item_cd + '%'"/>
		               AND UPPER(UPCRDT.ITEM_CD) LIKE UPPER(#{itemCdPattern})
		           </if>
		       </otherwise>
		   </choose>
		   <choose>
		       <when test="p.rfx_nos != null and p.rfx_nos.size() != 0">
		           AND RFXDATA.RFX_NO IN
		           <foreach close=")" collection="p.rfx_nos" item="rfx_no" open="(" separator=",">
		               #{rfx_no}
		           </foreach>
		       </when>
		       <otherwise>
		           <if test="p.rfx_no != null and p.rfx_no != ''">
		               <bind name="rfxNoPattern" value="'%' + p.rfx_no + '%'"/>
		               AND UPPER(RFXDATA.RFX_NO) LIKE UPPER(#{rfxNoPattern})
		           </if>
		       </otherwise>
		   </choose>
		   <if test="p.upcr_grp_sts_ccd != null and p.upcr_grp_sts_ccd != ''">
		       AND UPCRDT.UPCR_GRP_STS_CCD       = #{p.upcr_grp_sts_ccd}
		   </if>
		 ORDER BY UPCRHD.UPCR_NO DESC, UPCRHD.UPCR_REVNO DESC, CAST(UPCRDT.UPCR_LNO AS INT) ASC
	</select>
	<select id="findListUpcrAndUpcrItems" resultType="map">
		/* upcr-item.findListUpcrAndUpcrItems 구매품목 목록 조회 */
		SELECT CASE WHEN 'en_US' = #{g.locale} THEN USR.USR_NM_EN
		            ELSE USR.USR_NM
		        END AS UPCR_CRTR_NM
		     , UPCRHD.UPCR_REQ_DT
		     , UPCRHD.PURC_TYP_CCD
		     , UPCRHD.UPCR_TIT
		     , UPCRHD.UPCR_PURP_CCD
		     , UPCRDT.TEN_ID
		     , UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.UPCR_UUID
		     , TASK_UPCR.TASK_UUID AS TASK_UPCR_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_REVNO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.OORG_CD
		     , UPCRDT.PLT_CD
		     , UPCRDT.ITEM_OORG_CD
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE UPCRDT.ITEM_CD
		        END AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     ,	CASE WHEN 'en_US' = #{g.locale} THEN UPCRDT.ITEM_NM_EN
		            ELSE UPCRDT.ITEM_NM
		        END AS DISP_ITEM_NM
		     , UPCRDT.ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.UPCR_QTY
		     , UPCRDT.CUR_CCD
		     , UPCRDT.UPCR_UPRC
		     , UPCRDT.UPCR_AMT
		     , UPCRDT.WH_CCD
		     , UPCRDT.DLVY_PLC
		     , UPCRDT.PURC_GRP_CD
		     , UPCRDT.GR_PIC_ID
		     , UPCRDT.UPCR_REALUSR_ID
		     , UPCRDT.UPCR_REALUSR_REQ_CONT
		     , UPCRDT.SG_CD
		     <if test="g.existModule('SRM')">
		     , CASE WHEN 'en_US' = #{g.locale} THEN SG.SG_NM_EN
			        ELSE SG.SG_NM
			    END AS SG_NM
			 </if>
		     , UPCRDT.CONST_ST_DT
		     , UPCRDT.CONST_EXP_DT
		     , UPCRDT.REQ_DLVY_DT
		     , UPCRDT.ATHG_UUID
		     , UPCRDT.UPCR_RET_RSN
		     , CASE WHEN UPCRDT.UPCR_STS_CCD = 'RFI_CMPLD' THEN 'PR_RCPT' /* RFI 종료인 경우 접수 상태로 보이도록 함*/
		            ELSE UPCRDT.UPCR_STS_CCD
		        END AS UPCR_STS_CCD
		     , UPCRDT.UPCR_CHG_YN
		     , UPCRDT.STS
		     , UPCRDT.REGR_ID
		     , UPCRDT.REG_DTTM
		     , UPCRDT.MODR_ID
		     , UPCRDT.MOD_DTTM
		     ,	CASE WHEN 'en_US' = #{g.locale} THEN JOB.PURC_GRP_NM_EN
		            ELSE JOB.PURC_GRP_NM
		        END AS PURC_GRP_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_SUG_USR.USR_NM_EN
		            ELSE UPCR_SUG_USR.USR_NM
		        END AS UPCR_REALUSR_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN GR_CHR_USR.USR_NM_EN
		            ELSE GR_CHR_USR.USR_NM
		        END AS GR_PIC_NM
		     , CASE WHEN ITEM_OORG.TL_YN IS NOT NULL  THEN ITEM_OORG.TL_YN
		            ELSE 'N'
		        END AS TL_YN
		  FROM UPCR_ITEM UPCRDT
		LEFT OUTER JOIN ITEM_OORG
		      ON ITEM_OORG.TEN_ID = UPCRDT.TEN_ID
		      AND ITEM_OORG.ITEM_CD = UPCRDT.ITEM_CD
		      AND ITEM_OORG.OORG_CD = UPCRDT.ITEM_OORG_CD
		      AND ITEM_OORG.STS  != 'D'
		 INNER JOIN (
		             <include refid="subSqlRevTable"/>
		            ) UPCRHD
		    ON UPCRDT.UPCR_UUID  = UPCRHD.UPCR_UUID
		   AND UPCRHD.UPCR_REVNO = UPCRHD.LAST_REV
		  LEFT OUTER JOIN USR USR  /* 구매요청자 */
		    ON UPCRHD.TEN_ID    = USR.TEN_ID
		   AND UPCRHD.UPCR_CRTR_ID = USR.USR_ID
		  LEFT OUTER JOIN USR UPCR_SUG_USR /* 구매요청 의뢰자 */
		    ON UPCRDT.TEN_ID    = UPCR_SUG_USR.TEN_ID
		   AND UPCRDT.UPCR_REALUSR_ID = UPCR_SUG_USR.USR_ID
		  LEFT OUTER JOIN USR GR_CHR_USR /* 검수 담당자 */
		    ON UPCRDT.TEN_ID    = GR_CHR_USR.TEN_ID
		   AND UPCRDT.GR_PIC_ID = GR_CHR_USR.USR_ID
		  LEFT OUTER JOIN PURC_GRP JOB        /* 직무(그룹) */
		    ON JOB.TEN_ID       = UPCRDT.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		<if test="g.existModule('SRM')">
		  LEFT OUTER JOIN SG SG
		    ON SG.TEN_ID = UPCRDT.TEN_ID
		   AND SG.SG_CD = UPCRDT.SG_CD
		  AND SG.STS != 'D'
		  </if>
		  LEFT OUTER JOIN TASK_APVL TASK_UPCR
		    ON TASK_UPCR.TEN_ID = UPCRHD.TEN_ID
		   AND TASK_UPCR.TASK_UUID = UPCRHD.UPCR_UUID
		   AND TASK_UPCR.APVL_TYP_CCD IN ('PR', 'PR_CHG')
		   AND TASK_UPCR.USE_YN = 'Y'
		 WHERE UPCRDT.TEN_ID = #{g.tenant}
		   AND UPCRDT.STS   != 'D'
		   <if test="p.upcr_crtr_nm != null and p.upcr_crtr_nm != ''">
		       <bind name="userNamePattern" value="'%' + p.upcr_crtr_nm + '%'"/>
		       AND (UPPER(USR.USR_NM) LIKE UPPER(#{userNamePattern}) OR UPPER(USR.USR_NM_EN) LIKE UPPER(#{userNamePattern}) )
		   </if>
		   <if test="p.upcr_crtr_id != null and p.upcr_crtr_id != ''">
		       AND USR.USR_ID = #{p.upcr_crtr_id}
		   </if>
		   <if test="p.oorg_cd != null and p.oorg_cd.size() != 0">
		       AND UPCRHD.OORG_CD IN
		       <foreach close=")" collection="p.oorg_cd" item="oorg_cd" open="(" separator=",">
		           #{oorg_cd}
		       </foreach>
		   </if>
		   <if test="p.from_create_date != null">
		       AND UPCRHD.UPCR_REQ_DT &gt;= #{p.from_create_date}
		   </if>
		   <if test="p.to_create_date != null">
		   <bind name="toDatePattern" value="g.getPlusDays(p.to_create_date,1)"/>
		       AND UPCRHD.UPCR_REQ_DT <![CDATA[<]]> #{toDatePattern}
		   </if>
		   <choose>
		       <when test="p.upcr_nos != null and p.upcr_nos.size() != 0">
		           AND UPPER(UPCRHD.UPCR_NO) IN
		           <foreach close=")" collection="p.upcr_nos" item="upcr_no" open="(" separator=",">
		               #{upcr_no}
		           </foreach>
		       </when>
		       <otherwise>
		           <if test="p.upcr_no != null and p.upcr_no != ''">
		               <bind name="upcrNoPattern" value="'%' + p.upcr_no + '%'"/>
		               AND UPPER(UPCRHD.UPCR_NO) LIKE UPPER(#{upcrNoPattern})
		           </if>
		       </otherwise>
		    </choose>
		    <choose>
		        <when test="p.item_cds != null and p.item_cds.size() != 0">
		            AND UPPER(UPCRDT.ITEM_CD) IN
		            <foreach close=")" collection="p.item_cds" item="item_cd" open="(" separator=",">
		                #{item_cd}
		            </foreach>
		        </when>
		        <otherwise>
		            <if test="p.item_cd != null and p.item_cd != ''">
		                <bind name="itemCdPattern" value="'%' + p.item_cd + '%'"/>
		                AND UPPER(UPCRDT.ITEM_CD) LIKE UPPER(#{itemCdPattern})
		            </if>
		        </otherwise>
		    </choose>
		   <if test="p.purc_typ_ccd != null and p.purc_typ_ccd != ''">
		       AND UPCRHD.PURC_TYP_CCD = #{p.purc_typ_ccd}
		   </if>
		   <if test="p.upcr_purp_ccd != null and p.upcr_purp_ccd != ''">
		    	AND UPCRHD.UPCR_PURP_CCD = #{p.upcr_purp_ccd}
		   </if>
		   <if test="p.upcr_aprv_stss != null and p.upcr_aprv_stss.size() != 0">
		       AND UPCRHD.UPCR_STS_CCD IN
		       <foreach close=")" collection="p.upcr_aprv_stss" item="upcr_sts_ccd" open="(" separator=",">
		           #{upcr_sts_ccd}
		       </foreach>
		   </if>
		   <if test="p.upcr_sts_ccd != null and p.upcr_sts_ccd != ''">
		       <choose>
		           <when test="p.upcr_sts_ccd == &quot;PR_RCPT_WTG&quot;">
		               AND UPCRDT.UPCR_STS_CCD IN ('PR_RCPT_WTG', 'RFI_CMPLD') /*RFI 종료인 경우 접수 상태로 보이도록 함 */
		           </when>
		           <otherwise>
		               AND UPCRDT.UPCR_STS_CCD = #{p.upcr_sts_ccd}
		           </otherwise>
		       </choose>
		   </if>
		   <if test="p.upcr_prog_stss != null and p.upcr_prog_stss.size() != 0">
		       AND UPCRDT.UPCR_STS_CCD IN
		       <foreach close=")" collection="p.upcr_prog_stss" item="upcr_sts_ccd" open="(" separator=",">
		           #{upcr_sts_ccd}
		       </foreach>
		   </if>
		   <if test="p.purc_grp_cds != null and p.purc_grp_cds.size() != 0">
		       AND UPCRDT.PURC_GRP_CD IN
		       <foreach close=")" collection="p.purc_grp_cds" item="purc_grp_cd" open="(" separator=",">
		           #{purc_grp_cd}
		       </foreach>
		   </if>
		   <if test="p.upcr_tit != null and p.upcr_tit != ''">
		       <bind name="namePattern" value="'%' + p.upcr_tit + '%'"/>
		       AND UPPER(UPCRHD.UPCR_TIT) like UPPER(#{namePattern})
		   </if>
		 ORDER BY UPCRHD.UPCR_NO DESC, UPCRHD.UPCR_REVNO DESC, CAST(UPCRDT.UPCR_LNO AS INT) ASC
	</select>
	<select id="findListUpcrItem" resultType="map">
		/* upcr-item.findListUpcrItem 구매  품목 목록 조회 */
		SELECT UPCRDT.TEN_ID
		     , UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.UPCR_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_REVNO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.OORG_CD
		     , UPCRDT.PURC_TYP_CCD
		     , UPCRDT.UPCR_PURP_CCD
		     , UPCRDT.PLT_CD
		     , UPCRDT.ITEM_OORG_CD
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE UPCRDT.ITEM_CD
		        END AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     , UPCRDT.ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.UPCR_QTY
		     , UPCRDT.CUR_CCD
		     , UPCRDT.UPCR_UPRC
		     , UPCRDT.UPCR_AMT
		     , UPCRDT.WH_CCD
		     , UPCRDT.DLVY_PLC
		     , UPCRDT.PURC_GRP_CD
		     , UPCRDT.GR_PIC_ID
		     , UPCRDT.UPCR_REALUSR_ID
		     , UPCRDT.UPCR_REALUSR_REQ_CONT
		     , UPCRDT.SG_CD
		     , UPCRDT.REQ_DLVY_DT
		     , UPCRDT.ATHG_UUID
		     , UPCRDT.UPCR_RET_RSN
		     , UPCRDT.UPCR_STS_CCD
		     , UPCRDT.UPCR_CHG_YN
		     , UPCRDT.STS
		     , UPCRDT.REGR_ID
		     , UPCRDT.REG_DTTM
		     , UPCRDT.MODR_ID
		     , UPCRDT.MOD_DTTM
		     , CASE WHEN 'en_US' = #{g.locale} THEN JOB.PURC_GRP_NM_EN ELSE JOB.PURC_GRP_NM END AS PURC_GRP_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_SUG_USR.USR_NM_EN ELSE UPCR_SUG_USR.USR_NM END AS UPCR_REALUSR_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN GR_CHR_USR.USR_NM_EN ELSE GR_CHR_USR.USR_NM END AS GR_PIC_NM
		     <choose>
		         <when test="p.modify_yn != null and p.modify_yn eq 'Y'.toString()">
		             , 'Y'  AS HAS_PREV_YN
		         </when>
		         <otherwise>
		             , CASE WHEN PREV_UPCRDT.UPCR_ITEM_UUID IS NOT NULL  THEN 'Y'
		                    ELSE 'N'
		                END AS HAS_PREV_YN
		         </otherwise>
		     </choose>
		  FROM UPCR_ITEM UPCRDT
		  LEFT OUTER JOIN USR UPCR_SUG_USR        /* UPCR_SUG_USR : 구매요청 의뢰자 */
		    ON UPCRDT.TEN_ID    = UPCR_SUG_USR.TEN_ID
		   AND UPCRDT.UPCR_REALUSR_ID = UPCR_SUG_USR.USR_ID
		  LEFT OUTER JOIN USR GR_CHR_USR        /* GR_CHR_USR : 검수 담당자 */
		    ON UPCRDT.TEN_ID    = GR_CHR_USR.TEN_ID
		   AND UPCRDT.GR_PIC_ID = GR_CHR_USR.USR_ID
		  LEFT OUTER JOIN PURC_GRP JOB               /* JOB : 직무(그룹) */
		    ON JOB.TEN_ID       = UPCRDT.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		  <if test="p.modify_yn == null or p.modify_yn eq 'N'.toString()">
		      LEFT OUTER JOIN UPCR_ITEM PREV_UPCRDT
		        ON PREV_UPCRDT.TEN_ID     = UPCRDT.TEN_ID
		       AND PREV_UPCRDT.UPCR_NO      = UPCRDT.UPCR_NO
		       AND PREV_UPCRDT.UPCR_REVNO     = UPCRDT.UPCR_REVNO -1
		       AND PREV_UPCRDT.UPCR_LNO     = UPCRDT.UPCR_LNO
		       AND PREV_UPCRDT.ITEM_CD    = UPCRDT.ITEM_CD
		  </if>
		 WHERE UPCRDT.TEN_ID = #{g.tenant}
		   AND UPCRDT.UPCR_UUID  = #{p.upcr_uuid}
		   AND UPCRDT.STS   != 'D'
		 ORDER BY CAST(UPCRDT.UPCR_LNO AS INT) ASC
	</select>
	<!--  계약별로 조회-->
	<resultMap id="cntrMap" type="java.util.HashMap">
		<id column="VD_CD" property="vd_cd"/>
		<result column="OORG_CD" property="oorg_cd"/>
		<result column="PYMTMETH_CCD" property="pymtmeth_ccd"/>
		<result column="PYMTMETH_EXPLN" property="pymtmeth_expln"/>
		<result column="DLVYMETH_CCD" property="dlvymeth_ccd"/>
		<result column="DLVYMETH_EXPLN" property="dlvymeth_expln"/>
		<result column="DLVYMETH_USE_YN" property="dlvymeth_use_yn"/>
		<collection javaType="java.util.ArrayList" property="upcrItems" resultMap="upcrItemMap"/>
	</resultMap>
	<!-- 진행상태 상세 코드 조회 Result Map  -->
	<resultMap id="upcrItemMap" type="java.util.HashMap">
		<id column="UPCR_ITEM_UUID" property="upcr_item_uuid"/>
		<result column="UPCR_UUID" property="upcr_uuid"/>
		<result column="UPCR_NO" property="upcr_no"/>
		<result column="UPCR_REVNO" property="upcr_revno"/>
		<result column="UPCR_LNO" property="upcr_lno"/>
		<result column="OORG_CD" property="oorg_cd"/>
		<result column="PURC_TYP_CCD" property="purc_typ_ccd"/>
		<result column="PLT_CD" property="plt_cd"/>
		<result column="ITEM_OORG_CD" property="item_oorg_cd"/>
		<result column="ITEM_CD_CRN_TYP_CCD" property="item_cd_crn_typ_ccd"/>
		<result column="DISP_ITEM_CD" property="disp_item_cd"/>
		<result column="ITEM_CD" property="item_cd"/>
		<result column="ITEM_NM" property="item_nm"/>
		<result column="ITEM_NM_EN" property="item_nm_en"/>
		<result column="ITEM_SPEC" property="item_spec"/>
		<result column="ITEM_SPEC_DTL" property="item_spec_dtl"/>
		<result column="UOM_CCD" property="uom_ccd"/>
		<result column="UPCR_QTY" property="upcr_qty"/>
		<result column="CUR_CCD" property="cur_ccd"/>
		<result column="UPCR_UPRC" property="upcr_uprc"/>
		<result column="UPCR_AMT" property="upcr_amt"/>
		<result column="WH_CCD" property="wh_ccd"/>
		<result column="DLVY_PLC" property="dlvy_plc"/>
		<result column="PURC_GRP_CD" property="purc_grp_cd"/>
		<result column="GR_PIC_ID" property="gr_pic_id"/>
		<result column="UPCR_REALUSR_ID" property="upcr_realusr_id"/>
		<result column="UPCR_REALUSR_REQ_CONT" property="upcr_realusr_req_cont"/>
		<result column="SG_CD" property="sg_cd"/>
		<result column="REQ_DLVY_DT" property="req_dlvy_dt"/>
		<result column="ATHG_UUID" property="athg_uuid"/>
		<result column="UPCR_RET_RSN" property="upcr_ret_rsn"/>
		<result column="UPCR_STS_CCD" property="upcr_sts_ccd"/>
		<result column="UPCR_CHG_YN" property="upcr_chg_yn"/>
		<result column="MIGR_YN" property="migr_yn"/>
		<result column="STS" property="sts"/>
		<result column="REGR_ID" property="regr_id"/>
		<result column="REG_DTTM" property="reg_dttm"/>
		<result column="MODR_ID" property="modr_id"/>
		<result column="MOD_DTTM" property="mod_dttm"/>
		<result column="VD_RCPT_YN" property="vd_rcpt_yn"/>
		<result column="UPRC_CHG_POSS_YN" property="uprc_chg_poss_yn"/>
		<result column="UPRCCNTR_YN" property="uprccntr_yn"/>
		<result column="TAX_TYP_CCD" property="tax_typ_ccd"/>
		<result column="UPRCCNTR_AMT" property="uprccntr_amt"/>
		<result column="VAT_AMT" property="vat_amt"/>
		<result column="CPGUR_USE_YN" property="cpgur_use_yn"/>
		<result column="CPGUR_TYP_CCD" property="cpgur_typ_ccd"/>
		<result column="CPGUR_RO" property="cpgur_ro"/>
		<result column="CPGUR_AMT" property="cpgur_amt"/>
		<result column="CPGUR_ST_DT" property="cpgur_st_dt"/>
		<result column="CPGUR_EXP_DT" property="cpgur_exp_dt"/>
		<result column="DEFPGUR_USE_YN" property="defpgur_use_yn"/>
		<result column="DEFPGUR_TYP_CCD" property="defpgur_typ_ccd"/>
		<result column="DEFPGUR_RO" property="defpgur_ro"/>
		<result column="DEFPGUR_AMT" property="defpgur_amt"/>
		<result column="DEFPGUR_PD_TYP_CCD" property="defpgur_pd_typ_ccd"/>
		<result column="DEFPGUR_PD" property="defpgur_pd"/>
		<result column="PLT_CD" property="plt_cd"/>
		<result column="ITEM_OORG_CD" property="item_oorg_cd"/>
		<result column="DOMOVRS_DIV_CCD" property="domovrs_div_ccd"/>
		<result column="RFX_ITEM_UUID" property="rfx_item_uuid"/>
		<result column="RFX_NO" property="rfx_no"/>
		<result column="RFX_RND" property="rfx_no"/>
		<result column="RFX_ITEM_LNO" property="rfx_item_lno"/>
		<result column="RFX_BID_ITEM_UUID" property="rfx_bid_item_uuid"/>
		<result column="RFX_BID_NO" property="rfx_bid_no"/>
		<result column="RFX_BID_REVNO" property="rfx_bid_revno"/>
		<result column="RFX_BID_LNO" property="rfx_bid_lno"/>
		<result column="UPCR_GRP_STS_CCD" property="upcr_grp_sts_ccd"/>
		<result column="VD_CD" property="vd_cd"/>
		<result column="ERP_VD_CD" property="erp_vd_cd"/>
	</resultMap>
	<select id="findListUpcrItemAutoPoY" resultMap="cntrMap" resultType="map">
		/* upcr-item.findListUpcrItemAutoPoY 구매  자동발주 품목 목록 조회 */
	</select>
	<update id="updateUpcrProgSts">
		/* updateUpcrProgSts : 구매 물품 상태 변경 */
		UPDATE UPCR_ITEM
		   SET UPCR_GRP_STS_CCD = #{p.upcr_grp_sts_ccd}
		     , UPCR_STS_CCD     = #{p.upcr_sts_ccd}
		     , STS             = 'U'
		     , MODR_ID          = #{g.username}
		     , MOD_DTTM          = #{g.now}
		 WHERE TEN_ID = #{g.tenant}
		   AND UPCR_UUID  = #{p.upcr_uuid}
		   <if test="p.upcr_item_uuid != null and p.upcr_item_uuid != ''">
		       AND UPCR_ITEM_UUID = #{p.upcr_item_uuid}
		   </if>
	</update>
	<update id="updateUpcrItemPurcGrp">
		/* upcr-item.updateUpcrItemPurcGrp : 구매그룹 변경 */
		UPDATE UPCR_ITEM
		   SET PURC_GRP_CD = #{p.purc_grp_cd}
		     , STS         = 'U'
		     , MODR_ID      = #{g.username}
		     , MOD_DTTM      = #{g.now}
		 WHERE TEN_ID = #{g.tenant}
		   <choose>
		       <when test="p.upcr_item_uuids != null and p.upcr_item_uuids.size() &gt; 0">
		           AND UPCR_ITEM_UUID IN
		           <foreach close=")" collection="p.upcr_item_uuids" item="upcr_item_uuid" open="(" separator=",">
		               #{upcr_item_uuid}
		           </foreach>
		       </when>
		       <otherwise>
		           AND UPCR_ITEM_UUID = #{p.upcr_item_uuid}
		       </otherwise>
		   </choose>
	</update>
	<delete id="deleteUpcrItemByUpcr">
		/* deleteUpcrItemByUpcr : 구매 물품 여러건 삭제 */
		DELETE
		  FROM UPCR_ITEM
		 WHERE TEN_ID = #{g.tenant}
		   AND UPCR_UUID  = #{p.upcr_uuid}
	</delete>
	<select id="findListUpcrItemHistory" resultType="map">
		/* upcr-item.findListUpcrItemHistory */
		SELECT T.UPCR_LNO
		     , T.UPCR_REVNO
		     , T.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN T.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE T.ITEM_CD
		        END AS DISP_ITEM_CD
		     , T.ITEM_CD
		     , T.DISP_ITEM_NM
		     , T.ITEM_NM
		     , T.ITEM_NM_EN
		     , T.ITEM_SPEC
		     , T.ITEM_SPEC_DTL
		     , T.UOM_CCD
		     , T.UPCR_QTY
		     , T.UPCR_UPRC
		     , T.UPCR_AMT
		     , T.REQ_DLVY_DT
		     , T.DLVY_PLC
		     , T.PURC_GRP_CD
		     , T.PURC_GRP_NM
		     , T.UPCR_REALUSR_ID
		     , T.UPCR_REALUSR_NM
		     , T.GR_PIC_ID
		     , T.GR_PIC_NM
		     , T.ITEM_MOD_STATE
		  FROM (
		        SELECT UPCRDT.UPCR_LNO
		             , UPCRDT.UPCR_REVNO + 0      AS UPCR_REVNO
		             , UPCRDT.ITEM_CD_CRN_TYP_CCD
		             , UPCRDT.ITEM_CD
		             , CASE WHEN 'en_US' = #{g.locale} THEN UPCRDT.ITEM_NM_EN ELSE UPCRDT.ITEM_NM END AS DISP_ITEM_NM
		             , UPCRDT.ITEM_NM
		             , UPCRDT.ITEM_NM_EN
		             , UPCRDT.ITEM_SPEC
		             , UPCRDT.ITEM_SPEC_DTL
		             , UPCRDT.UOM_CCD
		             , UPCRDT.UPCR_QTY
		             , UPCRDT.UPCR_UPRC
		             , UPCRDT.UPCR_AMT
		             , UPCRDT.REQ_DLVY_DT
		             , UPCRDT.DLVY_PLC
		             , UPCRDT.PURC_GRP_CD
		             , CASE WHEN 'en_US' = #{g.locale} THEN JOB.PURC_GRP_NM_EN ELSE JOB.PURC_GRP_NM END AS PURC_GRP_NM
		             , UPCRDT.UPCR_REALUSR_ID
		             , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_SUG_USR.USR_NM_EN ELSE UPCR_SUG_USR.USR_NM END AS UPCR_REALUSR_NM
		             , UPCRDT.GR_PIC_ID
		             , CASE WHEN 'en_US' = #{g.locale} THEN GR_CHR_USR.USR_NM_EN ELSE GR_CHR_USR.USR_NM END AS GR_PIC_NM
		             , (
		                CASE WHEN UPCRDT.UPCR_REVNO = 1 THEN ''
		                     ELSE (
		                           CASE WHEN PREV_UPCRDT.UPCR_REVNO IS NULL THEN 'NEW'
		                                WHEN UPCRDT.UPCR_QTY = PREV_UPCRDT.UPCR_QTY AND UPCRDT.UPCR_UPRC = PREV_UPCRDT.UPCR_UPRC AND UPCRDT.UPCR_AMT = PREV_UPCRDT.UPCR_AMT  /* 수량,단가,금액 */
		                                     AND ((UPCRDT.REQ_DLVY_DT IS NULL AND PREV_UPCRDT.REQ_DLVY_DT IS NULL) OR UPCRDT.REQ_DLVY_DT = PREV_UPCRDT.REQ_DLVY_DT)                    /* 납기일자 */
		                                     AND (((UPCRDT.PURC_GRP_CD IS NULL OR UPCRDT.PURC_GRP_CD = '') AND (PREV_UPCRDT.PURC_GRP_CD IS NULL OR PREV_UPCRDT.PURC_GRP_CD = '')) OR UPCRDT.PURC_GRP_CD = PREV_UPCRDT.PURC_GRP_CD)    /* 구매그룹 */
		                                     AND (((UPCRDT.DLVY_PLC IS NULL OR UPCRDT.DLVY_PLC = '') AND (PREV_UPCRDT.DLVY_PLC IS NULL OR PREV_UPCRDT.DLVY_PLC = '')) OR UPCRDT.DLVY_PLC = PREV_UPCRDT.DLVY_PLC)                /* 납품(수행)장소 */
		                                     AND (((UPCRDT.UPCR_REALUSR_ID IS NULL OR UPCRDT.UPCR_REALUSR_ID = '') AND (PREV_UPCRDT.UPCR_REALUSR_ID IS NULL OR PREV_UPCRDT.UPCR_REALUSR_ID = '')) OR UPCRDT.UPCR_REALUSR_ID = PREV_UPCRDT.UPCR_REALUSR_ID)            /* 구매의뢰자 */
		                                     AND (((UPCRDT.GR_PIC_ID IS NULL OR UPCRDT.GR_PIC_ID = '') AND (PREV_UPCRDT.GR_PIC_ID IS NULL OR PREV_UPCRDT.GR_PIC_ID = '')) OR UPCRDT.GR_PIC_ID = PREV_UPCRDT.GR_PIC_ID)            /* 검수담당자 */
		                                       THEN ''
		                                     ELSE 'UPDATE'
		                            END
		                          )
		                 END
		               ) AS ITEM_MOD_STATE
		          FROM UPCR_ITEM UPCRDT
		          LEFT OUTER JOIN PURC_GRP JOB               /* JOB : 직무(그룹) */
		            ON JOB.TEN_ID       = UPCRDT.TEN_ID
		           AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		           AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		           AND JOB.CO_CD      = #{g.co_cd}
		           AND JOB.USE_YN       = 'Y'
		          LEFT OUTER JOIN USR UPCR_SUG_USR        /* UPCR_SUG_USR : 구매요청 의뢰자 */
		            ON UPCRDT.TEN_ID    = UPCR_SUG_USR.TEN_ID
		           AND UPCRDT.UPCR_REALUSR_ID = UPCR_SUG_USR.USR_ID
		          LEFT OUTER JOIN USR GR_CHR_USR        /* GR_CHR_USR : 검수 담당자 */
		            ON UPCRDT.TEN_ID    = GR_CHR_USR.TEN_ID
		           AND UPCRDT.GR_PIC_ID = GR_CHR_USR.USR_ID
		          LEFT OUTER JOIN UPCR_ITEM PREV_UPCRDT
		            ON PREV_UPCRDT.TEN_ID = UPCRDT.TEN_ID
		           AND PREV_UPCRDT.UPCR_NO  = UPCRDT.UPCR_NO
		           AND PREV_UPCRDT.UPCR_LNO = UPCRDT.UPCR_LNO
		           AND PREV_UPCRDT.UPCR_REVNO = UPCRDT.UPCR_REVNO -1
		           AND PREV_UPCRDT.STS   != 'D'
		         WHERE UPCRDT.TEN_ID = #{g.tenant}
		           AND UPCRDT.UPCR_NO  = #{p.upcr_no}
		           <if test="p.upcr_revs != null">
		               AND UPCRDT.UPCR_REVNO IN
		               <foreach close=")" collection="p.upcr_revs" item="upcr_revno" open="(" separator=",">
		                   #{upcr_revno}
		               </foreach>
		           </if>
		           AND UPCRDT.STS   != 'D'
		         UNION ALL
		        SELECT PREV_UPCRDT.UPCR_LNO         AS UPCR_LNO
		             , PREV_UPCRDT.UPCR_REVNO + 1     AS UPCR_REVNO
		             , PREV_UPCRDT.ITEM_CD_CRN_TYP_CCD  AS ITEM_CD_CRN_TYP_CCD
		             , PREV_UPCRDT.ITEM_CD        AS ITEM_CD
		             , CASE WHEN 'en_US' = #{g.locale} THEN PREV_UPCRDT.ITEM_NM_EN ELSE PREV_UPCRDT.ITEM_NM END AS DISP_ITEM_NM
		             , PREV_UPCRDT.ITEM_NM        AS ITEM_NM
		             , PREV_UPCRDT.ITEM_NM_EN   AS ITEM_NM_EN
		             , PREV_UPCRDT.ITEM_SPEC           AS ITEM_SPEC
		             , PREV_UPCRDT.ITEM_SPEC_DTL       AS ITEM_SPEC_DTL
		             , PREV_UPCRDT.UOM_CCD        AS UOM_CCD
		             , NULL                     AS UPCR_QTY
		             , NULL                     AS UPCR_UPRC
		             , NULL                     AS UPCR_AMT
		             , NULL                     AS REQ_DLVY_DT
		             , NULL                     AS DLVY_PLC
		             , NULL                     AS PURC_GRP_CD
		             , NULL                     AS PURC_GRP_NM
		             , NULL                     AS UPCR_REALUSR_ID
		             , NULL                     AS UPCR_REALUSR_NM
		             , NULL                     AS GR_PIC_ID
		             , NULL                     AS GR_PIC_NM
		             , 'DELETE'                 AS ITEM_MOD_STATE
		          FROM UPCR_ITEM PREV_UPCRDT
		          LEFT OUTER JOIN UPCR_ITEM DELETED_UPCRDT
		            ON DELETED_UPCRDT.TEN_ID = PREV_UPCRDT.TEN_ID
		           AND DELETED_UPCRDT.UPCR_NO  = PREV_UPCRDT.UPCR_NO
		           AND DELETED_UPCRDT.UPCR_LNO = PREV_UPCRDT.UPCR_LNO
		           AND DELETED_UPCRDT.UPCR_REVNO = PREV_UPCRDT.UPCR_REVNO +1
		         WHERE PREV_UPCRDT.TEN_ID        = #{g.tenant}
		           AND PREV_UPCRDT.UPCR_NO         = #{p.upcr_no}
		           <if test="p.upcr_revs != null">
		               AND PREV_UPCRDT.UPCR_REVNO IN
		               <foreach close=")" collection="p.upcr_revs" item="upcr_revno" open="(" separator=",">
		                   #{upcr_revno} -1
		               </foreach>
		           </if>
		           AND PREV_UPCRDT.UPCR_REVNO != CAST(#{p.last_upcr_rev} AS INT)
		           AND PREV_UPCRDT.STS    != 'D'
		           AND (DELETED_UPCRDT.UPCR_ITEM_UUID IS NULL OR DELETED_UPCRDT.UPCR_ITEM_UUID = '')
		       ) T
		 ORDER BY CAST(T.UPCR_LNO AS INT), T.UPCR_REVNO
	</select>
	<select id="findListCompareUpcrItem" resultType="map">
		/* upcr-item.findListCompareUpcrItem */
		SELECT UPCR_ITEM_LINE.UPCR_NO
		     , UPCR_ITEM_LINE.UPCR_LNO
		     , UPCR_ITEM_LINE.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCR_ITEM_LINE.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE UPCR_ITEM_LINE.ITEM_CD
		        END AS DISP_ITEM_CD
		     , UPCR_ITEM_LINE.ITEM_CD
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_ITEM_LINE.DISP_ITEM_NM ELSE UPCR_ITEM_LINE.ITEM_NM END AS DISP_ITEM_NM
		     , UPCR_ITEM_LINE.ITEM_NM
		     , UPCR_ITEM_LINE.ITEM_SPEC
		     , UPCR_ITEM_LINE.ITEM_SPEC_DTL
		     , UPCR_ITEM_LINE.UOM_CCD
		     , PREV_UPCRDT.UPCR_ITEM_UUID          AS PREV_UPCR_ITEM_ID
		     , POST_UPCRDT.UPCR_ITEM_UUID          AS POST_UPCR_ITEM_ID
		     , PREV_UPCRDT.UPCR_REVNO              AS PREV_UPCR_REV
		     , POST_UPCRDT.UPCR_REVNO              AS POST_UPCR_REV
		     , PREV_UPCRDT.UPCR_QTY            AS PREV_ITEM_QTY
		     , POST_UPCRDT.UPCR_QTY            AS POST_ITEM_QTY
		     , PREV_UPCRDT.UPCR_UPRC            AS PREV_UPCR_PRICE
		     , POST_UPCRDT.UPCR_UPRC            AS POST_UPCR_PRICE
		     , PREV_UPCRDT.UPCR_AMT              AS PREV_UPCR_AMT
		     , POST_UPCRDT.UPCR_AMT              AS POST_UPCR_AMT
		     , PREV_UPCRDT.REQ_DLVY_DT             AS PREV_RD_DATE
		     , POST_UPCRDT.REQ_DLVY_DT             AS POST_RD_DATE
		     , PREV_UPCRDT.DLVY_PLC            AS PREV_RD_LOCAT
		     , POST_UPCRDT.DLVY_PLC            AS POST_RD_LOCAT
		     , PREV_UPCRDT.PURC_GRP_CD         AS PREV_PURC_GRP_CD
		     , POST_UPCRDT.PURC_GRP_CD         AS POST_PURC_GRP_CD
		     , PREV_PURC_GRP.PURC_GRP_NM     AS PREV_PURC_GRP_NM
		     , POST_PURC_GRP.PURC_GRP_NM     AS POST_PURC_GRP_NM
		     , PREV_UPCR_SUG.USR_NM            AS PREV_UPCR_REALUSR_NM
		     , POST_UPCR_SUG.USR_NM            AS POST_UPCR_REALUSR_NM
		     , PREV_GR_CHR.USR_NM            AS PREV_GR_PIC_NM
		     , POST_GR_CHR.USR_NM            AS POST_GR_PIC_NM
		  FROM (
		        SELECT DT.TEN_ID
		             , DT.UPCR_NO
		             , DT.UPCR_LNO
		             , DT.ITEM_CD_CRN_TYP_CCD
		             , DT.ITEM_CD
		             , CASE WHEN 'en_US' = #{g.locale} THEN DT.ITEM_NM_EN ELSE DT.ITEM_NM END AS DISP_ITEM_NM
		             , DT.ITEM_NM
		             , DT.ITEM_SPEC
		             , DT.ITEM_SPEC_DTL
		             , DT.UOM_CCD
		          FROM UPCR_ITEM DT
		         WHERE DT.TEN_ID  = #{g.tenant}
		           AND DT.UPCR_NO   = #{p.upcr_no}
		           AND DT.UPCR_REVNO IN (CAST(#{p.prev_upcr_rev} AS INT), CAST(#{p.post_upcr_rev} AS INT))
		           AND DT.STS    != 'D'
		         GROUP BY DT.TEN_ID
		                , DT.UPCR_NO
		                , DT.UPCR_LNO
		                , DT.ITEM_CD_CRN_TYP_CCD
		                , DT.ITEM_CD
		                , DT.ITEM_NM
		                , DT.ITEM_SPEC
		                , DT.ITEM_SPEC_DTL
		                , DT.UOM_CCD
		                , DT.ITEM_NM_EN
		       ) UPCR_ITEM_LINE
		  LEFT OUTER JOIN UPCR_ITEM PREV_UPCRDT
		    ON PREV_UPCRDT.TEN_ID  = UPCR_ITEM_LINE.TEN_ID
		   AND PREV_UPCRDT.UPCR_NO   = UPCR_ITEM_LINE.UPCR_NO
		   AND PREV_UPCRDT.UPCR_LNO  = UPCR_ITEM_LINE.UPCR_LNO
		   AND PREV_UPCRDT.UPCR_REVNO  = CAST(#{p.prev_upcr_rev} AS INT)
		   AND PREV_UPCRDT.STS    != 'D'
		  LEFT OUTER JOIN PURC_GRP PREV_PURC_GRP
		    ON PREV_PURC_GRP.TEN_ID       = PREV_UPCRDT.TEN_ID
		   AND PREV_PURC_GRP.PURC_GRP_TYP_CCD = 'PURC'
		   AND PREV_PURC_GRP.PURC_GRP_CD  = PREV_UPCRDT.PURC_GRP_CD
		   AND PREV_PURC_GRP.CO_CD      = #{g.co_cd}
		   AND PREV_PURC_GRP.USE_YN  = 'Y'
		  LEFT OUTER JOIN USR PREV_UPCR_SUG
		    ON PREV_UPCRDT.TEN_ID    = PREV_UPCR_SUG.TEN_ID
		   AND PREV_UPCRDT.UPCR_REALUSR_ID = PREV_UPCR_SUG.USR_ID
		  LEFT OUTER JOIN USR PREV_GR_CHR
		    ON PREV_UPCRDT.TEN_ID    = PREV_GR_CHR.TEN_ID
		   AND PREV_UPCRDT.GR_PIC_ID = PREV_GR_CHR.USR_ID
		  LEFT OUTER JOIN UPCR_ITEM POST_UPCRDT
		    ON POST_UPCRDT.TEN_ID  = UPCR_ITEM_LINE.TEN_ID
		   AND POST_UPCRDT.UPCR_NO   = UPCR_ITEM_LINE.UPCR_NO
		   AND POST_UPCRDT.UPCR_LNO  = UPCR_ITEM_LINE.UPCR_LNO
		   AND POST_UPCRDT.UPCR_REVNO  = CAST(#{p.post_upcr_rev} AS INT)
		   AND POST_UPCRDT.STS    != 'D'
		  LEFT OUTER JOIN PURC_GRP POST_PURC_GRP
		    ON POST_PURC_GRP.TEN_ID       = POST_UPCRDT.TEN_ID
		   AND POST_PURC_GRP.PURC_GRP_TYP_CCD = 'PURC'
		   AND POST_PURC_GRP.PURC_GRP_CD  = POST_UPCRDT.PURC_GRP_CD
		   AND POST_PURC_GRP.CO_CD      = #{g.co_cd}
		   AND POST_PURC_GRP.USE_YN        = 'Y'
		  LEFT OUTER JOIN USR POST_UPCR_SUG
		    ON POST_UPCRDT.TEN_ID    = POST_UPCR_SUG.TEN_ID
		   AND POST_UPCRDT.UPCR_REALUSR_ID = POST_UPCR_SUG.USR_ID
		  LEFT OUTER JOIN USR POST_GR_CHR
		    ON POST_UPCRDT.TEN_ID    = POST_GR_CHR.TEN_ID
		   AND POST_UPCRDT.GR_PIC_ID = POST_GR_CHR.USR_ID
		 ORDER BY CAST(UPCR_ITEM_LINE.UPCR_LNO AS INT)
	</select>
	<select id="findPreviousUpcrItems" resultType="map">
		/* upcr-item.xml : findPreviousUpcrItems 이전차수 구매요청  품목 목록 조회 : 결재서식생성시 사용 */
		SELECT UPCRDT.TEN_ID
		     , UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.UPCR_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_REVNO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.OORG_CD
		     , UPCRDT.PURC_TYP_CCD
		     , UPCRDT.UPCR_PURP_CCD
		     , UPCRDT.PLT_CD
		     , UPCRDT.ITEM_OORG_CD
		     , UPCRDT.ITEM_CD_CRN_TYP_CCD
		     , CASE WHEN UPCRDT.ITEM_CD_CRN_TYP_CCD = 'CDLS' THEN NULL -- 구매품목유형: 미등록(무코드품목)
		            ELSE UPCRDT.ITEM_CD
		        END AS DISP_ITEM_CD
		     , UPCRDT.ITEM_CD
		     , UPCRDT.ITEM_NM
		     , UPCRDT.ITEM_NM_EN
		     , UPCRDT.ITEM_SPEC
		     , UPCRDT.ITEM_SPEC_DTL
		     , UPCRDT.UOM_CCD
		     , UPCRDT.UPCR_QTY
		     , UPCRDT.CUR_CCD
		     , UPCRDT.UPCR_UPRC
		     , UPCRDT.UPCR_AMT
		     , UPCRDT.WH_CCD
		     , UPCRDT.DLVY_PLC
		     , UPCRDT.PURC_GRP_CD
		     , UPCRDT.GR_PIC_ID
		     , UPCRDT.UPCR_REALUSR_ID
		     , UPCRDT.UPCR_REALUSR_REQ_CONT
		     , UPCRDT.SG_CD
		     , UPCRDT.REQ_DLVY_DT
		     , UPCRDT.ATHG_UUID
		     , UPCRDT.UPCR_RET_RSN
		     , UPCRDT.UPCR_STS_CCD
		     , UPCRDT.UPCR_CHG_YN
		     , UPCRDT.STS
		     , UPCRDT.REGR_ID
		     , UPCRDT.REG_DTTM
		     , UPCRDT.MODR_ID
		     , UPCRDT.MOD_DTTM
		     , JOB.PURC_GRP_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN UPCR_SUG_USR.USR_NM_EN
		            ELSE UPCR_SUG_USR.USR_NM
		        END AS UPCR_REALUSR_NM
		     , CASE WHEN 'en_US' = #{g.locale} THEN GR_CHR_USR.USR_NM_EN
		            ELSE GR_CHR_USR.USR_NM
		        END AS GR_PIC_NM
		  FROM UPCR_ITEM UPCRDT
		  LEFT OUTER JOIN USR UPCR_SUG_USR        /* UPCR_SUG_USR : 구매요청 의뢰자 */
		    ON UPCRDT.TEN_ID    = UPCR_SUG_USR.TEN_ID
		   AND UPCRDT.UPCR_REALUSR_ID = UPCR_SUG_USR.USR_ID
		  LEFT OUTER JOIN USR GR_CHR_USR        /* GR_CHR_USR : 검수 담당자 */
		    ON UPCRDT.TEN_ID    = GR_CHR_USR.TEN_ID
		   AND UPCRDT.GR_PIC_ID = GR_CHR_USR.USR_ID
		  LEFT OUTER JOIN PURC_GRP JOB               /* JOB : 직무(그룹) */
		    ON JOB.TEN_ID       = UPCRDT.TEN_ID
		   AND JOB.PURC_GRP_TYP_CCD = 'PURC'
		   AND JOB.PURC_GRP_CD  = UPCRDT.PURC_GRP_CD
		   AND JOB.CO_CD      = #{g.co_cd}
		   AND JOB.USE_YN       = 'Y'
		 WHERE UPCRDT.TEN_ID  = #{g.tenant}
		   AND UPCRDT.UPCR_REVNO  = CAST(#{p.upcr_revno} AS INT)
		   AND UPCRDT.UPCR_NO   = #{p.upcr_no}
		   AND UPCRDT.STS    != 'D'
		 ORDER BY CAST(UPCRDT.UPCR_LNO AS INT) ASC
	</select>
	<update id="updateUpcrItemUpcrPurp">
		/* updateUpcrItemUpcrPurp : 구매요청 목적 공통코드 변경 */
		UPDATE UPCR_ITEM
		   SET UPCR_PURP_CCD  = #{p.upcr_purp_ccd}
		     , UPCR_UPRC      = #{p.uprccntr_uprc}
		     , UPCR_AMT        =  GETPRECFORMAT(#{g.tenant}, 'amt', (UPCR_QTY * #{p.uprccntr_uprc}), CUR_CCD )
		     , STS           = 'U'
		     , MODR_ID        = #{g.username}
		     , MOD_DTTM        = #{g.now}
		 WHERE TEN_ID     = #{g.tenant}
		   AND UPCR_ITEM_UUID = #{p.upcr_item_uuid}
	</update>
	<select id="compareUpcrDtSts" resultType="map">
		/* upcr-item.compareUpcrDtSts */
		SELECT UPCRDT.UPCR_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_REVNO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.UPCR_STS_CCD
		     , CDDL.DTLCD_NM AS UPCR_PROG_STS_NM
		     , CASE WHEN UPCRDT.UPCR_STS_CCD = #{p.upcr_sts_ccd} THEN 'Y'
		            ELSE 'N'
		        END AS VALID_YN
		  FROM UPCR_ITEM UPCRDT
		 INNER JOIN DTLCD CDDT
		    ON CDDT.TEN_ID = UPCRDT.TEN_ID
		   AND CDDT.CCD = 'P044'
		   AND CDDT.DTLCD = UPCRDT.UPCR_STS_CCD
		   AND CDDT.USE_YN = 'Y'
		   AND CDDT.STS   != 'D'
		 INNER JOIN DTLCD_MULTLANG CDDL
		    ON CDDL.TEN_ID  = CDDT.TEN_ID
		   AND CDDL.CCD  = CDDT.CCD
		   AND CDDL.DTLCD  = CDDT.DTLCD
		   AND CDDL.LANG_CCD = #{g.locale}
		   AND CDDL.STS    != 'D'
		 WHERE UPCRDT.TEN_ID     = #{g.tenant}
		   AND UPCRDT.UPCR_ITEM_UUID = #{p.upcr_item_uuid}
	</select>
	<resultMap id="upcrDtValidCheckMap" type="java.util.HashMap">
		<result column="VALID_YN" property="valid_yn"/>
		<collection javaType="java.util.ArrayList" property="itemList" resultMap="upcrDtMap"/>
	</resultMap>
	<resultMap id="upcrDtMap" type="java.util.HashMap">
		<id column="UPCR_ITEM_UUID" property="upcr_item_uuid"/>
		<result column="UPCR_NO" property="upcr_no"/>
		<result column="UPCR_LNO" property="upcr_lno"/>
		<result column="UPCR_STS_CCD" property="upcr_sts_ccd"/>
		<result column="UPCR_PROG_STS_NM" property="upcr_prog_sts_nm"/>
	</resultMap>
	<select id="compareListUpcrDtSts" resultMap="upcrDtValidCheckMap">
		/* upcr-item.compareUpcrDtSts */
		SELECT UPCRDT.UPCR_ITEM_UUID
		     , UPCRDT.UPCR_UUID
		     , UPCRDT.UPCR_NO
		     , UPCRDT.UPCR_LNO
		     , UPCRDT.UPCR_STS_CCD
		     , CDDL.DTLCD_NM     AS UPCR_PROG_STS_NM
		     <choose>
		         <when test="p.availableStsList != null">
		             , CASE WHEN UPCRDT.UPCR_STS_CCD IN
		             <foreach close=")" collection="p.availableStsList" item="sts" open="(" separator=",">
		                 #{sts}
		             </foreach>
		                         THEN 'Y'
		                    ELSE 'N'
		                END AS VALID_YN
		         </when>
		         <otherwise>
		             , CASE WHEN UPCRDT.UPCR_STS_CCD = #{p.upcr_sts_ccd} THEN 'Y'
		                    ELSE 'N'
		                END AS VALID_YN
		         </otherwise>
		     </choose>
		  FROM UPCR_ITEM UPCRDT
		 INNER JOIN TEMP_TBL TEMP
		    ON TEMP.TEN_ID = UPCRDT.TEN_ID
		   AND TEMP.TASK_ID = UPCRDT.UPCR_ITEM_UUID
		   AND TEMP.USR_ID = #{g.username}
		 INNER JOIN DTLCD CDDT
		    ON CDDT.TEN_ID = UPCRDT.TEN_ID
		   AND CDDT.CCD = 'P044'
		   AND CDDT.DTLCD = UPCRDT.UPCR_STS_CCD
		   AND CDDT.USE_YN = 'Y'
		   AND CDDT.STS   != 'D'
		 INNER JOIN DTLCD_MULTLANG CDDL
		    ON CDDL.TEN_ID  = CDDT.TEN_ID
		   AND CDDL.CCD  = CDDT.CCD
		   AND CDDL.DTLCD  = CDDT.DTLCD
		   AND CDDL.LANG_CCD = #{g.locale}
		   AND CDDL.STS    != 'D'
		 WHERE UPCRDT.TEN_ID  = #{g.tenant}
	</select>
	<select id="findUpcrByUpcrItemId" resultType="map">
		/* upcr-item.findUpcrByUpcrItemId */
		SELECT UPCRHD.UPCR_UUID AS APP_ID
		     , UPCRHD.PURC_TYP_CCD
		  FROM UPCR_ITEM UPCRDT
		 INNER JOIN UPCR UPCRHD
		    ON UPCRDT.TEN_ID = UPCRHD.TEN_ID
		   AND UPCRDT.UPCR_UUID  = UPCRHD.UPCR_UUID
		 WHERE UPCRDT.TEN_ID     = #{g.tenant}
		   AND UPCRDT.UPCR_ITEM_UUID = #{p.upcr_item_uuid}
	</select>
	<select id="findListUpcrItemIdsByUpcrId" resultType="map">
		/* upcr-item.findListUpcrItemIdsByUpcrId */
		SELECT UPCR_ITEM_UUID
			FROM UPCR_ITEM
			WHERE TEN_ID = #{g.tenant}
			AND UPCR_UUID  = #{p.upcr_uuid}
			AND STS   != 'D'
	</select>
	<select id="findListUpcrItemByUpcrItemUuids" resultType="map">
		/* upcr-item.findListUpcrItemByUpcrItemUuids */
		SELECT UPCR_ITEM.OORG_CD
		, UPCR_ITEM.UPCR_ITEM_UUID
		FROM UPCR_ITEM
		WHERE UPCR_ITEM.TEN_ID = #{g.tenant}
		<choose>
		       <when test="p.upcr_item_uuids != null and p.upcr_item_uuids.size() &gt; 0">
		           AND UPCR_ITEM.UPCR_ITEM_UUID IN
		           <foreach close=")" collection="p.upcr_item_uuids" item="upcr_item_uuid" open="(" separator=",">
		               #{upcr_item_uuid}
		           </foreach>
		       </when>
		       <otherwise>
		           AND UPCR_ITEM.UPCR_ITEM_UUID = #{upcr_item_uuid}
		       </otherwise>
		   </choose>
	</select>
</mapper>
