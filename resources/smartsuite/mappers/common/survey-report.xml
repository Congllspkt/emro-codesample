<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="survey-report">
	<select id="findSurveyByUuid" resultType="map">
		SELECT SURV_UUID
		     , SURV_TYP_CCD
		     , SURV_NM
		     , FN_JSON_VALUE(SURV_NM, #{g.locale}) AS DISP_SURV_NM
		     , SURV_ST_DTTM
		     , TO_CHAR(SURV_ST_DTTM, 'YYYY-MM-DD HH24:MI')  AS DISP_SURV_ST_DTTM
		     , SURV_ED_DTTM
		     , TO_CHAR(SURV_ED_DTTM, 'YYYY-MM-DD HH24:MI')  AS DISP_SURV_ED_DTTM
		     , SURV_PIC_ID
		     , SURV_PRGS_STS_CCD
		     , RMK
		     , (
		        SELECT SUM(CASE WHEN SURV_SUBJ.SURV_SUBJ_SUBM_DTTM IS NOT NULL THEN 1 ELSE 0 END)
		          FROM SURV_SUBJ
		         WHERE SURV_SUBJ.TEN_ID = SURV.TEN_ID
		           AND SURV_SUBJ.SURV_UUID = SURV.SURV_UUID
		       ) AS SUBM_CNT
		     , (
		        SELECT COUNT(SURV_SUBJ.SURV_SUBJ_UUID)
		          FROM SURV_SUBJ
		         WHERE SURV_SUBJ.TEN_ID = SURV.TEN_ID
		           AND SURV_SUBJ.SURV_UUID = SURV.SURV_UUID
		       ) AS TOT_CNT
		  FROM SURV
		 WHERE TEN_ID = #{g.tenant}
		   AND SURV_UUID = #{p.surv_uuid}
	</select>
	<select id="findListSurveySubjectBySurveyUuid" resultType="map">
		SELECT SURV_SUBJ.SURV_UUID
		     , SURV_SUBJ.SURV_SUBJ_UUID
		     , SURV_SUBJ.SURV_SUBJ_INFO_ID
		     , CASE WHEN #{g.locale} = 'en_US' THEN USR.USR_NM_EN
		            ELSE USR.USR_NM
		        END AS DISP_SURV_SUBJ_INFO_NM
		     , SURV_SUBJ.SURV_SUBJ_SUBM_DTTM
		     , SURV_SUBJ.SURV_SUBJ_SC
		  FROM SURV
		 INNER JOIN SURV_SUBJ
		    ON SURV_SUBJ.TEN_ID = SURV.TEN_ID
		   AND SURV_SUBJ.SURV_UUID = SURV.SURV_UUID
		 INNER JOIN USR
		    ON USR.TEN_ID = SURV_SUBJ.TEN_ID
		   AND USR.USR_ID = SURV_SUBJ.SURV_SUBJ_INFO_ID
		 WHERE SURV_SUBJ.TEN_ID = #{g.tenant}
		   AND SURV_SUBJ.SURV_UUID = #{p.surv_uuid}
		   AND SURV_SUBJ.SURV_SUBJ_SUBM_DTTM IS NOT NULL
	</select>
	<select id="findListSurveySectBySurveyUuid" resultType="map">
		SELECT SURV_UUID
		     , SURV_SECT_UUID
		     , SURV_SECT_CD
		     , SURV_SECT_NM
		     , FN_JSON_VALUE(SURV_SECT_NM, #{g.locale}) AS DISP_SURV_SECT_NM
		     , SURV_SECT_EXPLN
		     , FN_JSON_VALUE(SURV_SECT_EXPLN, #{g.locale}) AS DISP_SURV_SECT_EXPLN
		     , SURV_SECT_SORT
		  FROM SURV_SECT
		 WHERE TEN_ID = #{g.tenant}
		   AND SURV_UUID = #{p.surv_uuid}
		 ORDER BY SURV_SECT_SORT
	</select>
	<select id="findListSurveyQnBySurveyUuid" resultType="map">
		SELECT SURV_UUID
		     , SURV_SECT_UUID
		     , SURV_QN_UUID
		     , SURV_QN_CD
		     , SURV_QN_NM
		     , FN_JSON_VALUE(SURV_QN_NM, #{g.locale}) AS DISP_SURV_QN_NM
		     , SURV_QN_EXPLN
		     , FN_JSON_VALUE(SURV_QN_EXPLN, #{g.locale}) AS DISP_SURV_QN_EXPLN
		     , SURV_QN_SORT
		     , SURV_QN_RAND_SORT
		     , CMNT_ADD_YN
		     , ANS_MAND_YN
		     , ANS_TYP_CCD
		     , ATH_POSS_YN
		     , ATH_MAND_YN
		     , OTRS_ANS_YN
		     , LNR_MIN_VAL_CCD
		     , LNR_MAX_VAL_CCD
		     , LNR_MIN_NM
		     , FN_JSON_VALUE(LNR_MIN_NM, #{g.locale}) AS DISP_LNR_MIN_NM
		     , LNR_MAX_NM
		     , FN_JSON_VALUE(LNR_MAX_NM, #{g.locale}) AS DISP_LNR_MAX_NM
		     , SHORTANS_INP_FORM_CCD
		     , REGEXP
		     , INP_LMT
		     , MAX_SEL_CNT
		     , ST_DT_LMT
		     , ED_DT_LMT
		     , GRID_RESP_YN
		     , PAR_SURV_QN_UUID
		     , PAR_SURV_ANS_OPT_UUID
		     , (
		        SELECT COUNT(SURV_SUBJ_ANS_MAPG.SURV_SUBJ_UUID)
		          FROM SURV_SUBJ_ANS_MAPG
		         WHERE SURV_SUBJ_ANS_MAPG.TEN_ID = SURV_QN.TEN_ID
		           AND SURV_SUBJ_ANS_MAPG.SURV_UUID = SURV_QN.SURV_UUID
		           AND SURV_SUBJ_ANS_MAPG.SURV_SECT_UUID = SURV_QN.SURV_SECT_UUID
		           AND SURV_SUBJ_ANS_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		       ) AS QN_ANS_CNT
		     , (
		        SELECT COUNT(SURV_SUBJ_ANS_MAPG.SURV_SUBJ_UUID)
		          FROM SURV_SUBJ_ANS_MAPG
		         WHERE SURV_SUBJ_ANS_MAPG.TEN_ID = SURV_QN.TEN_ID
		           AND SURV_SUBJ_ANS_MAPG.SURV_UUID = SURV_QN.SURV_UUID
		           AND SURV_SUBJ_ANS_MAPG.SURV_SECT_UUID = SURV_QN.SURV_SECT_UUID
		           AND SURV_SUBJ_ANS_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		           AND SURV_SUBJ_ANS_MAPG.SURV_SUBJ_OTRS_VAL IS NOT NULL  ) AS OTRS_CNT
		     , (
		        SELECT COUNT(SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_UUID)
		          FROM SURV_SUBJ_GRID_ANS_MAPG
		         WHERE SURV_SUBJ_GRID_ANS_MAPG.TEN_ID = SURV_QN.TEN_ID
		           AND SURV_SUBJ_GRID_ANS_MAPG.SURV_UUID = SURV_QN.SURV_UUID
		           AND SURV_SUBJ_GRID_ANS_MAPG.SURV_SECT_UUID = SURV_QN.SURV_SECT_UUID
		           AND SURV_SUBJ_GRID_ANS_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		           AND SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_OTRS_VAL IS NOT NULL  ) AS GRID_OTRS_CNT
		  FROM SURV_QN
		 WHERE TEN_ID = #{g.tenant}
		   AND SURV_UUID = #{p.surv_uuid}
		 ORDER BY SURV_QN_SORT
	</select>
	<select id="findListSurveyAnsBySurveyUuid" resultType="map">
		SELECT SURV_UUID
		     , SURV_SECT_UUID
		     , SURV_QN_UUID
		     , SURV_ANS_OPT_UUID
		     , OPT_NM
		     , FN_JSON_VALUE(OPT_NM, #{g.locale}) AS DISP_OPT_NM
		     , OPT_SC
		     , OPT_SORT
		     , OPT_RAND_SORT
		  FROM SURV_ANS
		 WHERE TEN_ID = #{g.tenant}
		   AND SURV_UUID = #{p.surv_uuid}
		 ORDER BY OPT_SORT
	</select>
	<select id="findListSelectAnswer" resultType="map">
		SELECT SURV_ANS.SURV_QN_UUID
		     , SURV_SUBJ_ANS_OPT_MAPG.SURV_ANS_OPT_RANK
		     , SURV_SUBJ_ANS_OPT_MAPG.SURV_ANS_OPT_UUID
		     , COUNT(SURV_SUBJ_ANS_OPT_MAPG.SURV_SUBJ_UUID) AS VALUE
		  FROM SURV_QN
		 INNER JOIN SURV_ANS
		    ON SURV_ANS.TEN_ID = SURV_QN.TEN_ID
		   AND SURV_ANS.SURV_UUID = SURV_QN.SURV_UUID
		   AND SURV_ANS.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		 INNER JOIN SURV_SUBJ_ANS_OPT_MAPG
		    ON SURV_SUBJ_ANS_OPT_MAPG.TEN_ID = SURV_ANS.TEN_ID
		   AND SURV_SUBJ_ANS_OPT_MAPG.SURV_UUID = SURV_ANS.SURV_UUID
		   AND SURV_SUBJ_ANS_OPT_MAPG.SURV_QN_UUID = SURV_ANS.SURV_QN_UUID
		   AND SURV_SUBJ_ANS_OPT_MAPG.SURV_ANS_OPT_UUID = SURV_ANS.SURV_ANS_OPT_UUID
		 WHERE SURV_QN.TEN_ID = #{g.tenant}
		   AND SURV_QN.SURV_UUID = #{p.surv_uuid}
		 GROUP BY SURV_ANS.SURV_QN_UUID, SURV_SUBJ_ANS_OPT_MAPG.SURV_ANS_OPT_RANK, SURV_SUBJ_ANS_OPT_MAPG.SURV_ANS_OPT_UUID
		 UNION ALL
		SELECT SURV_QN.SURV_QN_UUID
		     , SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_ANS_OPT_RANK
		     , SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_ANS_OPT_UUID
		     , COUNT(SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_SUBJ_UUID) AS VALUE
		  FROM SURV_QN
		 INNER JOIN SURV_ANS
		    ON SURV_ANS.TEN_ID = SURV_QN.TEN_ID
		   AND SURV_ANS.SURV_UUID = SURV_QN.SURV_UUID
		   AND SURV_ANS.SURV_QN_UUID = SURV_QN.PAR_SURV_QN_UUID
		 INNER JOIN SURV_SUBJ_GRID_ANS_OPT_MAPG
		    ON SURV_SUBJ_GRID_ANS_OPT_MAPG.TEN_ID = SURV_ANS.TEN_ID
		   AND SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_UUID = SURV_ANS.SURV_UUID
		   AND SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		   AND SURV_SUBJ_GRID_ANS_OPT_MAPG.PAR_SURV_QN_UUID = SURV_QN.PAR_SURV_QN_UUID
		   AND SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_ANS_OPT_UUID = SURV_ANS.SURV_ANS_OPT_UUID
		 WHERE SURV_QN.TEN_ID = #{g.tenant}
		   AND SURV_QN.SURV_UUID = #{p.surv_uuid}
		 GROUP BY SURV_QN.SURV_QN_UUID, SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_ANS_OPT_RANK, SURV_SUBJ_GRID_ANS_OPT_MAPG.SURV_ANS_OPT_UUID
	</select>
	<select id="findListSurveyTextAnsBySurveyUuid" resultType="map">
		SELECT SURV_QN.SURV_UUID
		     , SURV_SUBJ_ANS_MAPG.SURV_SUBJ_UUID
		     , SURV_QN.SURV_QN_UUID
		     , SURV_SUBJ_ANS_MAPG.SURV_SUBJ_ANS_VAL
		     , SURV_SUBJ_ANS_MAPG.SURV_SUBJ_CMNT_VAL
		     , SURV_SUBJ_ANS_MAPG.SURV_SUBJ_OTRS_VAL
		     , SURV_SUBJ_ANS_MAPG.SURV_SUBJ_ATHG_UUID
		  FROM SURV_QN
		 INNER JOIN SURV_SUBJ_ANS_MAPG
		    ON SURV_SUBJ_ANS_MAPG.TEN_ID = SURV_QN.TEN_ID
		   AND SURV_SUBJ_ANS_MAPG.SURV_UUID = SURV_QN.SURV_UUID
		   AND SURV_SUBJ_ANS_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		 WHERE SURV_QN.TEN_ID = #{g.tenant}
		   AND SURV_QN.SURV_UUID = #{p.surv_uuid}
		 UNION ALL
		SELECT SURV_QN.SURV_UUID
		     , SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_UUID
		     , SURV_QN.SURV_QN_UUID
		     , SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_ANS_VAL
		     , SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_CMNT_VAL
		     , SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_OTRS_VAL
		     , SURV_SUBJ_GRID_ANS_MAPG.SURV_SUBJ_ATHG_UUID
		  FROM SURV_QN
		 INNER JOIN SURV_SUBJ_GRID_ANS_MAPG
		    ON SURV_SUBJ_GRID_ANS_MAPG.TEN_ID = SURV_QN.TEN_ID
		   AND SURV_SUBJ_GRID_ANS_MAPG.SURV_UUID = SURV_QN.SURV_UUID
		   AND SURV_SUBJ_GRID_ANS_MAPG.SURV_QN_UUID = SURV_QN.SURV_QN_UUID
		 WHERE SURV_QN.TEN_ID = #{g.tenant}
		   AND SURV_QN.SURV_UUID = #{p.surv_uuid}
	</select>
</mapper>
